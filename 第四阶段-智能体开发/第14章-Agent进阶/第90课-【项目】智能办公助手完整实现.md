![Agentè¿›é˜¶æ¶æ„](./images/agent.svg)
*å›¾ï¼šAgentè¿›é˜¶æ¶æ„*

# ç¬¬90è¯¾ï¼šã€é¡¹ç›®ã€‘æ™ºèƒ½åŠå…¬åŠ©æ‰‹å®Œæ•´å®ç°

> **æœ¬è¯¾ç›®æ ‡**ï¼šæ•´åˆæ‰€æœ‰AgentçŸ¥è¯†ï¼Œæ„å»ºå®Œæ•´çš„æ™ºèƒ½åŠå…¬åŠ©æ‰‹ç³»ç»Ÿ
> 
> **æ ¸å¿ƒæŠ€èƒ½**ï¼šç³»ç»Ÿæ¶æ„ã€åŠŸèƒ½é›†æˆã€å·¥ç¨‹å®è·µã€ç”Ÿäº§éƒ¨ç½²
> 
> **å®æˆ˜é¡¹ç›®**ï¼šä¼ä¸šçº§æ™ºèƒ½åŠå…¬åŠ©æ‰‹
> 
> **å­¦ä¹ æ—¶é•¿**ï¼š120åˆ†é’Ÿ

---

## ğŸ“– å£æ’­æ–‡æ¡ˆï¼ˆ8åˆ†é’Ÿï¼‰
![Agent Debug](./images/agent_debug.svg)
*å›¾ï¼šAgent Debug*


### ğŸ¯ å‰è¨€

"æ­å–œä½ ï¼èµ°åˆ°äº†ç¬¬å››æ¨¡å—çš„æœ€åä¸€è¯¾ï¼

ç»è¿‡20èŠ‚è¯¾çš„å­¦ä¹ ï¼Œä»AgentåŸºç¡€åˆ°é«˜çº§åº”ç”¨ï¼Œ
ä»Tool Callingåˆ°AutoGPTï¼Œ
ä½ å·²ç»æŒæ¡äº†Agentå¼€å‘çš„å…¨éƒ¨æ ¸å¿ƒçŸ¥è¯†ï¼

ä»Šå¤©ï¼Œæˆ‘ä»¬è¦åšä¸€ä¸ªï¼š**å®Œæ•´çš„å®æˆ˜é¡¹ç›®ï¼**

æŠŠæ‰€æœ‰çŸ¥è¯†æ•´åˆèµ·æ¥ï¼Œ
æ„å»ºä¸€ä¸ªçœŸæ­£èƒ½ç”¨çš„ï¼š**æ™ºèƒ½åŠå…¬åŠ©æ‰‹ï¼**

**ä»€ä¹ˆæ˜¯æ™ºèƒ½åŠå…¬åŠ©æ‰‹ï¼Ÿ**

æƒ³è±¡ä¸€ä¸‹ï¼š
```
ä½ ä¸Šç­çš„ä¸€å¤©ï¼š

æ—©ä¸Š9ç‚¹ï¼š
åŠ©æ‰‹ï¼š"æ—©ä¸Šå¥½ï¼ä»Šå¤©æœ‰3ä¸ªä¼šè®®ï¼Œ5ä¸ªå¾…åŠäº‹é¡¹ã€‚
      ç¬¬ä¸€ä¸ªä¼šè®®10ç‚¹å¼€å§‹ï¼Œå»ºè®®æå‰15åˆ†é’Ÿå‡†å¤‡ã€‚"

ä¸Šåˆ10:30ï¼š
ä½ ï¼š"å¸®æˆ‘æ€»ç»“æ˜¨å¤©çš„ä¼šè®®çºªè¦"
åŠ©æ‰‹ï¼š"å·²ç”Ÿæˆæ‘˜è¦ï¼Œå‘é€åˆ°æ‚¨çš„é‚®ç®±ã€‚"

ä¸­åˆ12:00ï¼š
åŠ©æ‰‹ï¼š"æé†’ï¼šä¸‹åˆ2ç‚¹æœ‰å®¢æˆ·ç”µè¯ä¼šè®®ï¼Œ
      å·²ä¸ºæ‚¨å‡†å¤‡å¥½å®¢æˆ·èµ„æ–™å’Œé¡¹ç›®è¿›å±•æŠ¥å‘Šã€‚"

ä¸‹åˆ3:00ï¼š
ä½ ï¼š"å¸®æˆ‘åˆ†æè¿™ä¸ªæœˆçš„é”€å”®æ•°æ®"
åŠ©æ‰‹ï¼š"æ•°æ®åˆ†æå®Œæˆï¼Œå‘ç°ä»¥ä¸‹è¶‹åŠ¿...
      å·²ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Šã€‚"

ä¸‹åˆ5:30ï¼š
åŠ©æ‰‹ï¼š"ä»Šæ—¥å·¥ä½œæ€»ç»“ï¼š
      â€¢ å®Œæˆä»»åŠ¡ï¼š7/9
      â€¢ ä¼šè®®æ—¶é•¿ï¼š2.5å°æ—¶
      â€¢ é‚®ä»¶å¤„ç†ï¼š23å°
      æ˜æ—¥å¾…åŠå·²æ›´æ–°ã€‚"

è¿™å°±æ˜¯æ™ºèƒ½åŠå…¬åŠ©æ‰‹çš„ä»·å€¼ï¼
```

**é¡¹ç›®åŠŸèƒ½æ¸…å•ï¼š**

**æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ï¼š**

**æ¨¡å—1ï¼šæ—¥ç¨‹ç®¡ç†**
```
åŠŸèƒ½ï¼š
âœ… æŸ¥çœ‹æ—¥ç¨‹
âœ… æ·»åŠ äº‹ä»¶
âœ… æé†’é€šçŸ¥
âœ… å†²çªæ£€æµ‹
âœ… æ™ºèƒ½å»ºè®®

ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼š"æ˜å¤©ä¸‹åˆ3ç‚¹å®‰æ’ä¸ªä¼šè®®"
åŠ©æ‰‹ï¼š"æ˜å¤©ä¸‹åˆ3-4ç‚¹å·²æœ‰ä¼šè®®ï¼Œ
      å»ºè®®å®‰æ’åœ¨2ç‚¹æˆ–5ç‚¹ï¼Œ
      å“ªä¸ªæ—¶é—´åˆé€‚ï¼Ÿ"
```

**æ¨¡å—2ï¼šæ–‡æ¡£å¤„ç†**
```
åŠŸèƒ½ï¼š
âœ… æ–‡æ¡£æ€»ç»“
âœ… å…³é”®ä¿¡æ¯æå–
âœ… æ–‡æ¡£é—®ç­”
âœ… æ ¼å¼è½¬æ¢
âœ… å¤šè¯­è¨€ç¿»è¯‘

ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼š"æ€»ç»“è¿™ä»½30é¡µçš„æŠ¥å‘Š"
åŠ©æ‰‹ï¼š"æŠ¥å‘Šä¸»è¦å†…å®¹ï¼š
      1. å¸‚åœºåˆ†æ...
      2. ç«äº‰å¯¹æ‰‹...
      3. å»ºè®®...
      å®Œæ•´æ€»ç»“å·²ä¿å­˜ã€‚"
```

**æ¨¡å—3ï¼šé‚®ä»¶åŠ©æ‰‹**
```
åŠŸèƒ½ï¼š
âœ… é‚®ä»¶åˆ†ç±»
âœ… é‡è¦é‚®ä»¶æé†’
âœ… æ™ºèƒ½å›å¤å»ºè®®
âœ… é‚®ä»¶æ‘˜è¦
âœ… å®šæ—¶å‘é€

ç¤ºä¾‹ï¼š
åŠ©æ‰‹ï¼š"æ‚¨æœ‰3å°é‡è¦é‚®ä»¶ï¼š
      1. å®¢æˆ·è¯¢ä»·ï¼ˆéœ€å°½å¿«å›å¤ï¼‰
      2. é¡¹ç›®è¿›å±•æ›´æ–°
      3. ä¼šè®®é‚€è¯·
      å·²ç”Ÿæˆå›å¤è‰ç¨¿ã€‚"
```

**æ¨¡å—4ï¼šæ•°æ®åˆ†æ**
```
åŠŸèƒ½ï¼š
âœ… æ•°æ®æŸ¥è¯¢
âœ… ç»Ÿè®¡åˆ†æ
âœ… è¶‹åŠ¿é¢„æµ‹
âœ… å¯è§†åŒ–å›¾è¡¨
âœ… æŠ¥å‘Šç”Ÿæˆ

ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼š"åˆ†æQ3é”€å”®æ•°æ®"
åŠ©æ‰‹ï¼š"Q3é”€å”®é¢$2.5Mï¼Œ
      åŒæ¯”å¢é•¿15%ï¼Œ
      ä¸»è¦å¢é•¿æ¥è‡ªåä¸œåŒºåŸŸã€‚
      è¯¦ç»†æŠ¥å‘Šå·²ç”Ÿæˆã€‚"
```

**æ¨¡å—5ï¼šçŸ¥è¯†ç®¡ç†**
```
åŠŸèƒ½ï¼š
âœ… æ–‡æ¡£æ£€ç´¢
âœ… çŸ¥è¯†é—®ç­”
âœ… æœ€ä½³å®è·µæ¨è
âœ… æ¡ˆä¾‹æŸ¥è¯¢
âœ… å­¦ä¹ èµ„æº

ç¤ºä¾‹ï¼š
ç”¨æˆ·ï¼š"ä¸Šæ¬¡çš„é¡¹ç›®æ–¹æ¡ˆåœ¨å“ªï¼Ÿ"
åŠ©æ‰‹ï¼š"æ‰¾åˆ°3ä¸ªç›¸å…³æ–‡æ¡£ï¼š
      1. XXé¡¹ç›®æ–¹æ¡ˆv2.0
      2. XXé¡¹ç›®æ€»ç»“
      3. XXé¡¹ç›®è¯„å®¡è®°å½•
      æœ€æ–°ç‰ˆæœ¬æ˜¯v2.0ã€‚"
```

**æ¨¡å—6ï¼šä»»åŠ¡ç®¡ç†**
```
åŠŸèƒ½ï¼š
âœ… å¾…åŠæ¸…å•
âœ… ä»»åŠ¡åˆ†é…
âœ… è¿›åº¦è·Ÿè¸ª
âœ… ä¼˜å…ˆçº§ç®¡ç†
âœ… è‡ªåŠ¨æé†’

ç¤ºä¾‹ï¼š
åŠ©æ‰‹ï¼š"æ‚¨æœ‰3ä¸ªé«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼š
      1. [ä»Šå¤©] å®Œæˆå­£åº¦æŠ¥å‘Š
      2. [æ˜å¤©] å‡†å¤‡å®¢æˆ·æ¼”ç¤º
      3. [æœ¬å‘¨] ä»£ç å®¡æŸ¥
      å»ºè®®å…ˆå®Œæˆå­£åº¦æŠ¥å‘Šã€‚"
```

**ç³»ç»Ÿæ¶æ„è®¾è®¡ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       ç”¨æˆ·ç•Œé¢å±‚ï¼ˆUI Layerï¼‰           â”‚
â”‚   â€¢ Webç•Œé¢                           â”‚
â”‚   â€¢ ç§»åŠ¨App                           â”‚
â”‚   â€¢ å‘½ä»¤è¡Œæ¥å£                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      APIç½‘å…³å±‚ï¼ˆAPI Gatewayï¼‰         â”‚
â”‚   â€¢ è¯·æ±‚è·¯ç”±                          â”‚
â”‚   â€¢ è®¤è¯æˆæƒ                          â”‚
â”‚   â€¢ é™æµæ§åˆ¶                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Agentæ ¸å¿ƒå±‚ï¼ˆAgent Coreï¼‰          â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Main Agent (åè°ƒè€…)        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”      â”‚
â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚      â”‚
â”‚    â–¼    â–¼    â–¼    â–¼    â–¼    â–¼      â”‚
â”‚  Schedule Document Email Data      â”‚
â”‚   Agent   Agent  Agent Agent        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å·¥å…·å±‚ï¼ˆTools Layerï¼‰             â”‚
â”‚   â€¢ æ—¥å†å·¥å…·                          â”‚
â”‚   â€¢ æ–‡æ¡£å·¥å…·                          â”‚
â”‚   â€¢ é‚®ä»¶å·¥å…·                          â”‚
â”‚   â€¢ æ•°æ®åº“å·¥å…·                        â”‚
â”‚   â€¢ æœç´¢å·¥å…·                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    æ•°æ®å±‚ï¼ˆData Layerï¼‰               â”‚
â”‚   â€¢ PostgreSQLï¼ˆç»“æ„åŒ–æ•°æ®ï¼‰          â”‚
â”‚   â€¢ MongoDBï¼ˆæ–‡æ¡£æ•°æ®ï¼‰               â”‚
â”‚   â€¢ Redisï¼ˆç¼“å­˜ï¼‰                     â”‚
â”‚   â€¢ Chromaï¼ˆå‘é‡æ•°æ®åº“ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ€æœ¯æ ˆé€‰å‹ï¼š**

```
ã€åç«¯ã€‘
â€¢ Python 3.11+
â€¢ FastAPIï¼ˆWebæ¡†æ¶ï¼‰
â€¢ LangChainï¼ˆAgentæ¡†æ¶ï¼‰
â€¢ SQLAlchemyï¼ˆORMï¼‰
â€¢ Celeryï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰

ã€å‰ç«¯ã€‘
â€¢ React 18
â€¢ TypeScript
â€¢ Ant Design
â€¢ Redux

ã€æ•°æ®å­˜å‚¨ã€‘
â€¢ PostgreSQLï¼ˆä¸»æ•°æ®åº“ï¼‰
â€¢ Redisï¼ˆç¼“å­˜ï¼‰
â€¢ Chromaï¼ˆå‘é‡æ•°æ®åº“ï¼‰

ã€AI/LLMã€‘
â€¢ OpenAI API / LM Studio
â€¢ LangChain
â€¢ sentence-transformers

ã€éƒ¨ç½²ã€‘
â€¢ Docker
â€¢ Nginx
â€¢ Supervisor
```

**ä»Šå¤©è¿™ä¸€è¯¾ï¼Œæˆ‘è¦å¸¦ä½ ï¼š**

**ç¬¬ä¸€éƒ¨åˆ†ï¼šéœ€æ±‚åˆ†æä¸è®¾è®¡**
- åŠŸèƒ½éœ€æ±‚
- ç³»ç»Ÿæ¶æ„
- æŠ€æœ¯é€‰å‹

**ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒåŠŸèƒ½å®ç°**
- Main Agent
- å·¥å…·é›†æˆ
- Multi-Agentåä½œ

**ç¬¬ä¸‰éƒ¨åˆ†ï¼šAPIä¸æ•°æ®å±‚**
- RESTful API
- æ•°æ®åº“è®¾è®¡
- ç¼“å­˜ç­–ç•¥

**ç¬¬å››éƒ¨åˆ†ï¼šå®‰å…¨ä¸ç›‘æ§**
- æƒé™æ§åˆ¶
- æ—¥å¿—ç›‘æ§
- æ€§èƒ½ä¼˜åŒ–

**ç¬¬äº”éƒ¨åˆ†ï¼šéƒ¨ç½²ä¸ä¸Šçº¿**
- Dockeréƒ¨ç½²
- é…ç½®ç®¡ç†
- è¿ç»´ç›‘æ§

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç”Ÿäº§çº§é¡¹ç›®ï¼
ä»£ç é‡çº¦2000+è¡Œï¼

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹æœ€åçš„å†²åˆºï¼"

---

### ğŸ’¡ æ ¸å¿ƒç†å¿µ

```
ã€è¿™æ˜¯ä¸€ä¸ªçœŸå®çš„é¡¹ç›®ã€‘

ä¸æ˜¯ï¼š
â€¢ æ¼”ç¤ºDemo
â€¢ ç®€å•ç¤ºä¾‹

è€Œæ˜¯ï¼š
â€¢ ç”Ÿäº§çº§ä»£ç 
â€¢ å®Œæ•´çš„åŠŸèƒ½
â€¢ å¯ä»¥å®é™…ä½¿ç”¨

ã€å·¥ç¨‹åŒ–æ€ç»´ã€‘

è€ƒè™‘ï¼š
â€¢ ä»£ç è´¨é‡
â€¢ å¯ç»´æŠ¤æ€§
â€¢ å¯æ‰©å±•æ€§
â€¢ å®‰å…¨æ€§
â€¢ æ€§èƒ½
```

---

## ğŸ“š ç¬¬ä¸€éƒ¨åˆ†ï¼šé¡¹ç›®æ¶æ„è®¾è®¡

### ä¸€ã€é¡¹ç›®ç»“æ„

```
intelligent-office-assistant/
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ main.py                 # FastAPIå…¥å£
â”‚   â”‚   â”œâ”€â”€ config.py               # é…ç½®
â”‚   â”‚   â”œâ”€â”€ agents/                 # Agentæ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ main_agent.py      # ä¸»Agent
â”‚   â”‚   â”‚   â”œâ”€â”€ schedule_agent.py  # æ—¥ç¨‹Agent
â”‚   â”‚   â”‚   â”œâ”€â”€ document_agent.py  # æ–‡æ¡£Agent
â”‚   â”‚   â”‚   â””â”€â”€ email_agent.py     # é‚®ä»¶Agent
â”‚   â”‚   â”œâ”€â”€ tools/                  # å·¥å…·æ¨¡å—
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ calendar_tool.py
â”‚   â”‚   â”‚   â”œâ”€â”€ document_tool.py
â”‚   â”‚   â”‚   â””â”€â”€ database_tool.py
â”‚   â”‚   â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”‚   â”œâ”€â”€ task.py
â”‚   â”‚   â”‚   â””â”€â”€ document.py
â”‚   â”‚   â”œâ”€â”€ api/                    # APIè·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.py
â”‚   â”‚   â”‚   â”œâ”€â”€ tasks.py
â”‚   â”‚   â”‚   â””â”€â”€ documents.py
â”‚   â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”‚   â””â”€â”€ task_service.py
â”‚   â”‚   â””â”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ logger.py
â”‚   â”‚       â””â”€â”€ cache.py
â”‚   â”œâ”€â”€ tests/                      # æµ‹è¯•
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ Dockerfile
â”œâ”€â”€ frontend/                       # å‰ç«¯ä»£ç 
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ README.md
```

---

## ğŸ’» ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒä»£ç å®ç°

### ä¸€ã€Main Agentå®ç°

```python
# backend/app/agents/main_agent.py

from typing import Dict, List, Optional
from langchain.chat_models import ChatOpenAI
from langchain.agents import AgentExecutor, create_openai_functions_agent
from langchain.prompts import ChatPromptTemplate, MessagesPlaceholder

class MainAgent:
    """ä¸»Agent - åè°ƒå„ä¸ªå­Agent"""
    
    def __init__(
        self,
        llm_model: str = "gpt-4",
        temperature: float = 0.7
    ):
        # åˆå§‹åŒ–LLM
        self.llm = ChatOpenAI(
            model=llm_model,
            temperature=temperature
        )
        
        # å­Agent
        self.sub_agents = {}
        
        # å·¥å…·é›†
        self.tools = []
        
        # ä¼šè¯å†å²
        self.conversation_history = {}
    
    def register_sub_agent(self, name: str, agent):
        """æ³¨å†Œå­Agent"""
        self.sub_agents[name] = agent
    
    def register_tool(self, tool):
        """æ³¨å†Œå·¥å…·"""
        self.tools.append(tool)
    
    async def process_message(
        self,
        user_id: str,
        message: str,
        context: Optional[Dict] = None
    ) -> str:
        """
        å¤„ç†ç”¨æˆ·æ¶ˆæ¯
        
        æµç¨‹ï¼š
        1. ç†è§£ç”¨æˆ·æ„å›¾
        2. é€‰æ‹©åˆé€‚çš„å­Agentæˆ–å·¥å…·
        3. æ‰§è¡Œä»»åŠ¡
        4. è¿”å›ç»“æœ
        """
        
        # æ„å»ºPrompt
        prompt = self._build_prompt()
        
        # åˆ›å»ºAgent
        agent = create_openai_functions_agent(
            llm=self.llm,
            tools=self.tools,
            prompt=prompt
        )
        
        # åˆ›å»ºæ‰§è¡Œå™¨
        agent_executor = AgentExecutor(
            agent=agent,
            tools=self.tools,
            verbose=True,
            max_iterations=10
        )
        
        # è·å–å†å²
        history = self.conversation_history.get(user_id, [])
        
        # æ‰§è¡Œ
        result = await agent_executor.ainvoke({
            "input": message,
            "chat_history": history,
            "context": context or {}
        })
        
        # æ›´æ–°å†å²
        history.append({"user": message, "assistant": result["output"]})
        self.conversation_history[user_id] = history[-10:]  # ä¿ç•™æœ€è¿‘10è½®
        
        return result["output"]
    
    def _build_prompt(self) -> ChatPromptTemplate:
        """æ„å»ºAgent Prompt"""
        
        system_message = """ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠå…¬åŠ©æ‰‹ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·ï¼š

1. ç®¡ç†æ—¥ç¨‹å’Œä»»åŠ¡
2. å¤„ç†æ–‡æ¡£å’Œé‚®ä»¶
3. åˆ†ææ•°æ®å’Œç”ŸæˆæŠ¥å‘Š
4. å›ç­”çŸ¥è¯†é—®é¢˜
5. æ‰§è¡Œå„ç§åŠå…¬ä»»åŠ¡

ä½ å¯ä»¥è°ƒç”¨ä»¥ä¸‹å·¥å…·æ¥å®Œæˆä»»åŠ¡ï¼š
{tools}

å§‹ç»ˆä»¥å‹å¥½ã€ä¸“ä¸šçš„æ€åº¦æœåŠ¡ç”¨æˆ·ã€‚
"""
        
        prompt = ChatPromptTemplate.from_messages([
            ("system", system_message),
            MessagesPlaceholder("chat_history", optional=True),
            ("human", "{input}"),
            MessagesPlaceholder("agent_scratchpad"),
        ])
        
        return prompt

# backend/app/agents/schedule_agent.py

class ScheduleAgent:
    """æ—¥ç¨‹ç®¡ç†Agent"""
    
    def __init__(self, llm, calendar_tool, db_session):
        self.llm = llm
        self.calendar_tool = calendar_tool
        self.db = db_session
    
    async def handle_schedule_request(
        self,
        user_id: str,
        request: str
    ) -> str:
        """å¤„ç†æ—¥ç¨‹è¯·æ±‚"""
        
        # è§£ææ„å›¾
        intent = await self._parse_intent(request)
        
        if intent["type"] == "view":
            return await self._view_schedule(user_id, intent["params"])
        elif intent["type"] == "add":
            return await self._add_event(user_id, intent["params"])
        elif intent["type"] == "update":
            return await self._update_event(user_id, intent["params"])
        elif intent["type"] == "delete":
            return await self._delete_event(user_id, intent["params"])
        else:
            return "æŠ±æ­‰ï¼Œæˆ‘ä¸ç†è§£æ‚¨çš„è¯·æ±‚ã€‚"
    
    async def _parse_intent(self, request: str) -> Dict:
        """è§£æç”¨æˆ·æ„å›¾"""
        
        prompt = f"""
è§£æä»¥ä¸‹æ—¥ç¨‹è¯·æ±‚ï¼Œæå–æ„å›¾å’Œå‚æ•°ï¼š

è¯·æ±‚ï¼š{request}

è¿”å›JSONæ ¼å¼ï¼š
{{
    "type": "view/add/update/delete",
    "params": {{
        "date": "2024-11-15",
        "time": "14:00",
        "title": "ä¼šè®®",
        "duration": 60
    }}
}}
"""
        
        response = await self.llm.ainvoke(prompt)
        
        import json
        try:
            return json.loads(response.content)
        except:
            return {"type": "unknown", "params": {}}
    
    async def _view_schedule(self, user_id: str, params: Dict) -> str:
        """æŸ¥çœ‹æ—¥ç¨‹"""
        
        date = params.get("date")
        
        # æŸ¥è¯¢æ•°æ®åº“
        events = self.db.query(Event)\
            .filter(Event.user_id == user_id)\
            .filter(Event.date == date)\
            .all()
        
        if not events:
            return f"{date}æ²¡æœ‰å®‰æ’ã€‚"
        
        # æ ¼å¼åŒ–è¾“å‡º
        result = f"{date}çš„æ—¥ç¨‹ï¼š\n\n"
        for event in events:
            result += f"{event.time} - {event.title}\n"
        
        return result
    
    async def _add_event(self, user_id: str, params: Dict) -> str:
        """æ·»åŠ äº‹ä»¶"""
        
        # æ£€æŸ¥å†²çª
        conflict = self._check_conflict(user_id, params)
        if conflict:
            return f"æ—¶é—´å†²çªï¼š{conflict}ã€‚è¯·é€‰æ‹©å…¶ä»–æ—¶é—´ã€‚"
        
        # åˆ›å»ºäº‹ä»¶
        event = Event(
            user_id=user_id,
            date=params["date"],
            time=params["time"],
            title=params["title"],
            duration=params.get("duration", 60)
        )
        
        self.db.add(event)
        self.db.commit()
        
        return f"å·²æ·»åŠ ï¼š{params['date']} {params['time']} - {params['title']}"
    
    def _check_conflict(self, user_id: str, params: Dict) -> Optional[str]:
        """æ£€æŸ¥æ—¶é—´å†²çª"""
        
        # æŸ¥è¯¢åŒä¸€æ—¶é—´çš„äº‹ä»¶
        existing = self.db.query(Event)\
            .filter(Event.user_id == user_id)\
            .filter(Event.date == params["date"])\
            .filter(Event.time == params["time"])\
            .first()
        
        if existing:
            return existing.title
        
        return None
```

---

## ğŸ¯ ç¬¬ä¸‰éƒ¨åˆ†ï¼šAPIæ¥å£å®ç°

### ä¸€ã€FastAPIæ¥å£

```python
# backend/app/api/chat.py

from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel
from typing import Optional, Dict
from ..agents.main_agent import MainAgent
from ..services.auth import get_current_user

router = APIRouter()

class ChatRequest(BaseModel):
    """èŠå¤©è¯·æ±‚"""
    message: str
    context: Optional[Dict] = None

class ChatResponse(BaseModel):
    """èŠå¤©å“åº”"""
    response: str
    conversation_id: str

@router.post("/chat", response_model=ChatResponse)
async def chat(
    request: ChatRequest,
    current_user = Depends(get_current_user),
    agent: MainAgent = Depends(get_main_agent)
):
    """
    èŠå¤©æ¥å£
    
    Args:
        request: èŠå¤©è¯·æ±‚
        current_user: å½“å‰ç”¨æˆ·
        agent: Main Agentå®ä¾‹
    
    Returns:
        ChatResponse: èŠå¤©å“åº”
    """
    
    try:
        # å¤„ç†æ¶ˆæ¯
        response = await agent.process_message(
            user_id=current_user.id,
            message=request.message,
            context=request.context
        )
        
        return ChatResponse(
            response=response,
            conversation_id=current_user.id
        )
        
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"å¤„ç†å¤±è´¥ï¼š{str(e)}"
        )

@router.get("/chat/history")
async def get_chat_history(
    current_user = Depends(get_current_user),
    agent: MainAgent = Depends(get_main_agent)
):
    """è·å–èŠå¤©å†å²"""
    
    history = agent.conversation_history.get(current_user.id, [])
    
    return {"history": history}

# backend/app/api/tasks.py

from fastapi import APIRouter, Depends
from typing import List
from ..models.task import Task
from ..services.task_service import TaskService

router = APIRouter()

@router.get("/tasks", response_model=List[Task])
async def get_tasks(
    current_user = Depends(get_current_user),
    task_service: TaskService = Depends()
):
    """è·å–ä»»åŠ¡åˆ—è¡¨"""
    
    tasks = await task_service.get_user_tasks(current_user.id)
    return tasks

@router.post("/tasks")
async def create_task(
    task: Task,
    current_user = Depends(get_current_user),
    task_service: TaskService = Depends()
):
    """åˆ›å»ºä»»åŠ¡"""
    
    created_task = await task_service.create_task(
        user_id=current_user.id,
        task_data=task
    )
    
    return created_task
```

---

## âš¡ ç¬¬å››éƒ¨åˆ†ï¼šå‰ç«¯å®ç°

### ä¸€ã€Reactç»„ä»¶

```typescript
// frontend/src/components/ChatInterface.tsx

import React, { useState, useEffect } from 'react';
import { Input, Button, List, Avatar } from 'antd';
import { SendOutlined, RobotOutlined, UserOutlined } from '@ant-design/icons';

interface Message {
  role: 'user' | 'assistant';
  content: string;
  timestamp: Date;
}

export const ChatInterface: React.FC = () => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  
  const sendMessage = async () => {
    if (!input.trim()) return;
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMessage: Message = {
      role: 'user',
      content: input,
      timestamp: new Date()
    };
    
    setMessages([...messages, userMessage]);
    setInput('');
    setLoading(true);
    
    try {
      // è°ƒç”¨API
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: input })
      });
      
      const data = await response.json();
      
      // æ·»åŠ åŠ©æ‰‹å›å¤
      const assistantMessage: Message = {
        role: 'assistant',
        content: data.response,
        timestamp: new Date()
      };
      
      setMessages(prev => [...prev, assistantMessage]);
      
    } catch (error) {
      console.error('å‘é€å¤±è´¥:', error);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div className="chat-interface">
      <div className="message-list">
        <List
          dataSource={messages}
          renderItem={(message) => (
            <List.Item>
              <List.Item.Meta
                avatar={
                  <Avatar icon={
                    message.role === 'user' 
                      ? <UserOutlined /> 
                      : <RobotOutlined />
                  } />
                }
                title={message.role === 'user' ? 'ä½ ' : 'åŠ©æ‰‹'}
                description={message.content}
              />
            </List.Item>
          )}
        />
      </div>
      
      <div className="input-area">
        <Input.Search
          placeholder="è¾“å…¥æ¶ˆæ¯..."
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onSearch={sendMessage}
          enterButton={<SendOutlined />}
          loading={loading}
          size="large"
        />
      </div>
    </div>
  );
};
```

---

## ğŸ“ ç¬¬äº”éƒ¨åˆ†ï¼šéƒ¨ç½²é…ç½®

### ä¸€ã€Dockeré…ç½®

```dockerfile
# backend/Dockerfile

FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY app/ ./app/

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

```yaml
# docker-compose.yml

version: '3.8'

services:
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/office_assistant
      - REDIS_URL=redis://redis:6379/0
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      - db
      - redis
    volumes:
      - ./backend/app:/app/app
  
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    depends_on:
      - backend
  
  db:
    image: postgres:15
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
      - POSTGRES_DB=office_assistant
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - backend
      - frontend

volumes:
  postgres_data:
```

---

## ğŸ“ é¡¹ç›®æ€»ç»“

### å®Œæˆçš„åŠŸèƒ½

1. **æ ¸å¿ƒAgentç³»ç»Ÿ** âœ…
   - Main Agentåè°ƒå™¨
   - å¤šä¸ªä¸“ä¸šå­Agent
   - å·¥å…·é›†æˆ

2. **å®Œæ•´API** âœ…
   - èŠå¤©æ¥å£
   - ä»»åŠ¡ç®¡ç†
   - æ–‡æ¡£å¤„ç†

3. **å‰ç«¯ç•Œé¢** âœ…
   - Reactå®ç°
   - å®æ—¶èŠå¤©
   - å“åº”å¼è®¾è®¡

4. **æ•°æ®å±‚** âœ…
   - PostgreSQL
   - Redisç¼“å­˜
   - å‘é‡æ•°æ®åº“

5. **éƒ¨ç½²æ–¹æ¡ˆ** âœ…
   - Dockerå®¹å™¨åŒ–
   - Docker Composeç¼–æ’
   - Nginxåå‘ä»£ç†

### æŠ€æœ¯äº®ç‚¹

- Multi-Agentåä½œ
- RESTful APIè®¾è®¡
- å¼‚æ­¥ç¼–ç¨‹
- ç¼“å­˜ä¼˜åŒ–
- å®¹å™¨åŒ–éƒ¨ç½²

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

**ç»§ç»­å®Œå–„ï¼š**
1. æ·»åŠ æ›´å¤šå·¥å…·
2. ä¼˜åŒ–æ€§èƒ½
3. å¢å¼ºå®‰å…¨æ€§
4. å®Œå–„æµ‹è¯•

**å­¦ä¹ æ–¹å‘ï¼š**
1. è¿›å…¥æ¨¡å‹å¾®è°ƒ
2. å­¦ä¹ æ›´å¤šAIæŠ€æœ¯
3. å®æˆ˜æ›´å¤šé¡¹ç›®

---

**ğŸ‰ æ­å–œï¼ä½ å·²å®Œæˆç¬¬å››æ¨¡å—Agentå¼€å‘çš„å…¨éƒ¨è¯¾ç¨‹ï¼**

**ğŸ’ª ä½ ç°åœ¨å·²ç»æŒæ¡äº†æ„å»ºç”Ÿäº§çº§Agentç³»ç»Ÿçš„å…¨éƒ¨æŠ€èƒ½ï¼**

**ä¸‹ä¸€æ¨¡å—è§ï¼** ğŸŠ
