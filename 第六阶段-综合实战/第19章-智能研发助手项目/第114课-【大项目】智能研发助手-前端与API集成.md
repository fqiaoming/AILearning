![æ™ºèƒ½ç ”å‘åŠ©æ‰‹æ¶æ„](./images/project.svg)
*å›¾ï¼šæ™ºèƒ½ç ”å‘åŠ©æ‰‹æ¶æ„*

# ç¬¬114è¯¾ï¼šã€å¤§é¡¹ç›®ã€‘æ™ºèƒ½ç ”å‘åŠ©æ‰‹-å‰ç«¯ä¸APIé›†æˆ

> **æœ¬è¯¾ç›®æ ‡**ï¼šå®ç°å®Œæ•´çš„å‰ç«¯ç•Œé¢å’ŒAPIé›†æˆ
> 
> **æ ¸å¿ƒæŠ€èƒ½**ï¼šReactå¼€å‘ã€WebSocketé€šä¿¡ã€FastAPIåç«¯ã€ç³»ç»Ÿé›†æˆ
> 
> **å­¦ä¹ æ—¶é•¿**ï¼š120åˆ†é’Ÿ

---

## ğŸ“– å£æ’­æ–‡æ¡ˆï¼ˆ9åˆ†é’Ÿï¼‰
![Agent Impl](./images/agent_impl.svg)
*å›¾ï¼šAgent Impl*


### ğŸ¯ å‰è¨€

"å‰é¢ä¸‰èŠ‚è¯¾ï¼Œæˆ‘ä»¬å®Œæˆäº†æ¶æ„è®¾è®¡ã€RAGç³»ç»Ÿå’ŒAgentç³»ç»Ÿã€‚

ä»Šå¤©è¦åšçš„æ˜¯ï¼š**æ‰“é€šå‰åç«¯ï¼Œè®©ç³»ç»ŸçœŸæ­£è¿è¡Œèµ·æ¥ï¼**

**ç°åœ¨çš„çŠ¶æ€ï¼š**

```
åç«¯ï¼š
âœ… RAGç³»ç»Ÿï¼ˆæ–‡æ¡£æ£€ç´¢ï¼‰
âœ… Agentç³»ç»Ÿï¼ˆä»»åŠ¡æ‰§è¡Œï¼‰
âœ… å·¥å…·é›†ï¼ˆGitã€æ–‡ä»¶ç­‰ï¼‰

å‰ç«¯ï¼š
âŒ è¿˜æ²¡æœ‰ç•Œé¢
âŒ ç”¨æˆ·æ— æ³•ä½¿ç”¨

ç›®æ ‡ï¼š
è®©ç”¨æˆ·é€šè¿‡å‹å¥½çš„ç•Œé¢ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ï¼
```

**ä»Šå¤©è¦å®ç°ä»€ä¹ˆï¼Ÿ**

```
1. Webæ§åˆ¶å°ï¼ˆä¸»ç•Œé¢ï¼‰
   â€¢ èŠå¤©ç•Œé¢ï¼ˆä¸»è¦äº¤äº’ï¼‰
   â€¢ çŸ¥è¯†åº“ç®¡ç†
   â€¢ ä»»åŠ¡å†å²
   â€¢ ç»Ÿè®¡åˆ†æ

2. FastAPIåç«¯æœåŠ¡
   â€¢ RESTful API
   â€¢ WebSocketå®æ—¶é€šä¿¡
   â€¢ è¯·æ±‚å¤„ç†
   â€¢ é”™è¯¯å¤„ç†

3. ç³»ç»Ÿé›†æˆ
   â€¢ RAG + Agenté›†æˆ
   â€¢ æ„å›¾è·¯ç”±
   â€¢ æµå¼å“åº”
   â€¢ çŠ¶æ€ç®¡ç†

4. VS Codeæ’ä»¶ï¼ˆå¯é€‰ï¼‰
   â€¢ ä¾§è¾¹æ é›†æˆ
   â€¢ å¿«æ·é”®æ”¯æŒ
   â€¢ ä»£ç ä¸Šä¸‹æ–‡æ„ŸçŸ¥
```

**æŠ€æœ¯æ ˆï¼š**

```
ã€å‰ç«¯ã€‘
â€¢ æ¡†æ¶ï¼šReact 18 + TypeScript
â€¢ UIåº“ï¼šAnt Design
â€¢ çŠ¶æ€ç®¡ç†ï¼šRedux Toolkit
â€¢ HTTPå®¢æˆ·ç«¯ï¼šAxios
â€¢ WebSocketï¼šSocket.io-client
â€¢ ç¼–è¾‘å™¨ï¼šMonaco Editor
â€¢ Markdownæ¸²æŸ“ï¼šreact-markdown

ã€åç«¯ã€‘
â€¢ APIæ¡†æ¶ï¼šFastAPI
â€¢ WebSocketï¼šFastAPI WebSocket
â€¢ å¼‚æ­¥ï¼šasyncio
â€¢ æ•°æ®éªŒè¯ï¼šPydantic
â€¢ è®¤è¯ï¼šJWT
â€¢ CORSï¼šFastAPI CORSä¸­é—´ä»¶
```

**ç•Œé¢è®¾è®¡ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ™ºèƒ½ç ”å‘åŠ©æ‰‹                    [è®¾ç½®] [ç”¨æˆ·]        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          â”‚                                          â”‚
â”‚  [ğŸ’¬å¯¹è¯]â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚          â”‚  â”‚ ç”¨æˆ·ï¼šPostgreSQLå¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ   â”‚ â”‚
â”‚  [ğŸ“šæ–‡æ¡£]â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚                                          â”‚
â”‚  [ğŸ¤–ä»»åŠ¡]â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚          â”‚  â”‚ åŠ©æ‰‹ï¼š                             â”‚ â”‚
â”‚  [ğŸ“Šç»Ÿè®¡]â”‚  â”‚ PostgreSQLæ…¢æŸ¥è¯¢ä¼˜åŒ–å¯ä»¥ä»...      â”‚ â”‚
â”‚          â”‚  â”‚                                    â”‚ â”‚
â”‚  [âš™ï¸è®¾ç½®]â”‚  â”‚ å‚è€ƒæ–‡æ¡£ï¼š                         â”‚ â”‚
â”‚          â”‚  â”‚ â€¢ PostgreSQLä¼˜åŒ–æŒ‡å—               â”‚ â”‚
â”‚          â”‚  â”‚ â€¢ æ•°æ®åº“æ€§èƒ½è°ƒä¼˜                   â”‚ â”‚
â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚                                          â”‚
â”‚          â”‚  [________________________] [å‘é€]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒåŠŸèƒ½ï¼š**

```
åŠŸèƒ½1ï¼šæ™ºèƒ½å¯¹è¯
â€¢ è¾“å…¥é—®é¢˜
â€¢ å®æ—¶æµå¼å“åº”
â€¢ Markdownæ¸²æŸ“
â€¢ ä»£ç é«˜äº®
â€¢ å¼•ç”¨æ ‡æ³¨

åŠŸèƒ½2ï¼šçŸ¥è¯†åº“ç®¡ç†
â€¢ ä¸Šä¼ æ–‡æ¡£
â€¢ æŸ¥çœ‹æ–‡æ¡£åˆ—è¡¨
â€¢ åˆ é™¤æ–‡æ¡£
â€¢ æ›´æ–°æ–‡æ¡£
â€¢ æœç´¢æµ‹è¯•

åŠŸèƒ½3ï¼šä»»åŠ¡æ‰§è¡Œ
â€¢ æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨
â€¢ ä»»åŠ¡è¯¦æƒ…
â€¢ æ‰§è¡ŒçŠ¶æ€
â€¢ ç»“æœå±•ç¤º
â€¢ é”™è¯¯å¤„ç†

åŠŸèƒ½4ï¼šç»Ÿè®¡åˆ†æ
â€¢ ä½¿ç”¨ç»Ÿè®¡
â€¢ çƒ­é—¨é—®é¢˜
â€¢ æ•ˆç‡åˆ†æ
â€¢ æ»¡æ„åº¦è¯„åˆ†
```

**äº¤äº’æµç¨‹ï¼š**

```
ã€æµç¨‹1ï¼šæ–‡æ¡£é—®ç­”ã€‘

ç”¨æˆ·è¾“å…¥ â†’ å‰ç«¯å‘é€ â†’ åç«¯å¤„ç†
                 â†“
            æ„å›¾è¯†åˆ«ï¼šæ–‡æ¡£é—®ç­”
                 â†“
            RAGç³»ç»Ÿæ£€ç´¢
                 â†“
            æµå¼ç”Ÿæˆç­”æ¡ˆ
                 â†“
         WebSocketæ¨é€ â†’ å‰ç«¯å®æ—¶æ˜¾ç¤º

ã€æµç¨‹2ï¼šä»»åŠ¡æ‰§è¡Œã€‘

ç”¨æˆ·è¾“å…¥ â†’ å‰ç«¯å‘é€ â†’ åç«¯å¤„ç†
                 â†“
            æ„å›¾è¯†åˆ«ï¼šä»»åŠ¡æ‰§è¡Œ
                 â†“
            Agentè§„åˆ’ä»»åŠ¡
                 â†“
            é€æ­¥æ‰§è¡Œå·¥å…·
                 â†“
         WebSocketæ¨é€çŠ¶æ€ â†’ å‰ç«¯å®æ—¶æ›´æ–°

ã€æµç¨‹3ï¼šä»£ç åˆ†æã€‘

ç”¨æˆ·è¾“å…¥ â†’ å‰ç«¯å‘é€ â†’ åç«¯å¤„ç†
                 â†“
            æ„å›¾è¯†åˆ«ï¼šä»£ç ä»»åŠ¡
                 â†“
            RAGæ£€ç´¢ç›¸å…³æ–‡æ¡£
                 â†“
            Agentæ‰§è¡Œåˆ†æ
                 â†“
            åˆå¹¶ç»“æœç”Ÿæˆ
                 â†“
         WebSocketæ¨é€ â†’ å‰ç«¯å±•ç¤º
```

**WebSocketå®æ—¶é€šä¿¡ï¼š**

```
ã€æ¶ˆæ¯æ ¼å¼ã€‘

// å®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯
{
  "type": "query",
  "content": "PostgreSQLå¦‚ä½•ä¼˜åŒ–æ…¢æŸ¥è¯¢ï¼Ÿ",
  "session_id": "sess_123",
  "stream": true
}

// æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ï¼ˆæµå¼ï¼‰
{
  "type": "stream",
  "content": "PostgreSQLæ…¢æŸ¥è¯¢",
  "delta": "PostgreSQLæ…¢æŸ¥è¯¢",
  "done": false
}

{
  "type": "stream",
  "content": "PostgreSQLæ…¢æŸ¥è¯¢ä¼˜åŒ–å¯ä»¥",
  "delta": "ä¼˜åŒ–å¯ä»¥",
  "done": false
}

...

{
  "type": "complete",
  "content": "å®Œæ•´ç­”æ¡ˆ",
  "sources": [...],
  "done": true
}

ã€Agentä»»åŠ¡çŠ¶æ€æ¨é€ã€‘

{
  "type": "agent_step",
  "step": 1,
  "thought": "æˆ‘éœ€è¦å…ˆæœç´¢UserServiceæ–‡ä»¶",
  "action": "file_search",
  "status": "running"
}

{
  "type": "agent_step",
  "step": 1,
  "observation": "æ‰¾åˆ°æ–‡ä»¶ï¼š/src/.../UserService.java",
  "status": "success"
}
```

**çŠ¶æ€ç®¡ç†ï¼š**

```
ã€Redux Storeç»“æ„ã€‘

{
  chat: {
    messages: [],      // èŠå¤©è®°å½•
    loading: false,    // åŠ è½½çŠ¶æ€
    streaming: false   // æµå¼å“åº”ä¸­
  },
  
  knowledge: {
    documents: [],     // æ–‡æ¡£åˆ—è¡¨
    total: 0,          // æ€»æ•°
    loading: false
  },
  
  tasks: {
    history: [],       // ä»»åŠ¡å†å²
    current: null,     // å½“å‰ä»»åŠ¡
    loading: false
  },
  
  user: {
    profile: {},       // ç”¨æˆ·ä¿¡æ¯
    permissions: []    // æƒé™
  }
}
```

**ä»Šå¤©è¿™ä¸€è¯¾ï¼Œæˆ‘è¦å¸¦ä½ ï¼š**

**ç¬¬ä¸€éƒ¨åˆ†ï¼šFastAPIåç«¯**
- APIè·¯ç”±è®¾è®¡
- WebSocketå®ç°
- ç³»ç»Ÿé›†æˆ
- é”™è¯¯å¤„ç†

**ç¬¬äºŒéƒ¨åˆ†ï¼šReactå‰ç«¯**
- èŠå¤©ç•Œé¢
- å®æ—¶é€šä¿¡
- Markdownæ¸²æŸ“
- çŠ¶æ€ç®¡ç†

**ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ„å›¾è·¯ç”±**
- æ™ºèƒ½åˆ†å‘
- RAG/Agenté€‰æ‹©
- æ··åˆæ¨¡å¼
- ç»“æœèåˆ

**ç¬¬å››éƒ¨åˆ†ï¼šå®Œæ•´è”è°ƒ**
- ç«¯åˆ°ç«¯æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–
- é”™è¯¯å¤„ç†
- ç”¨æˆ·ä½“éªŒ

è®©å‰åç«¯å®Œç¾å¯¹æ¥ï¼"

---

## ğŸ“š ç¬¬ä¸€éƒ¨åˆ†ï¼šFastAPIåç«¯æœåŠ¡

### ä¸€ã€APIè·¯ç”±è®¾è®¡

```python
from fastapi import FastAPI, WebSocket, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import List, Optional, Dict
import asyncio
import json
from datetime import datetime

# åˆå§‹åŒ–FastAPI
app = FastAPI(
    title="æ™ºèƒ½ç ”å‘åŠ©æ‰‹API",
    description="ä¼ä¸šçº§AIç ”å‘åŠ©æ‰‹åç«¯æœåŠ¡",
    version="1.0.0"
)

# CORSä¸­é—´ä»¶
app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # Reactå¼€å‘æœåŠ¡å™¨
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ============= æ•°æ®æ¨¡å‹ =============

class QueryRequest(BaseModel):
    """æŸ¥è¯¢è¯·æ±‚"""
    content: str
    session_id: Optional[str] = None
    stream: bool = True

class QueryResponse(BaseModel):
    """æŸ¥è¯¢å“åº”"""
    answer: str
    sources: List[Dict] = []
    confidence: float = 0.0
    duration: float = 0.0

class DocumentUpload(BaseModel):
    """æ–‡æ¡£ä¸Šä¼ """
    filename: str
    content: str
    metadata: Optional[Dict] = {}

class TaskRequest(BaseModel):
    """ä»»åŠ¡è¯·æ±‚"""
    task: str
    session_id: Optional[str] = None

# ============= APIè·¯ç”± =============

@app.get("/")
async def root():
    """å¥åº·æ£€æŸ¥"""
    return {
        "status": "healthy",
        "service": "æ™ºèƒ½ç ”å‘åŠ©æ‰‹",
        "version": "1.0.0",
        "timestamp": datetime.now().isoformat()
    }

@app.post("/api/query", response_model=QueryResponse)
async def query(request: QueryRequest):
    """
    åŒæ­¥æŸ¥è¯¢æ¥å£
    
    Args:
        request: æŸ¥è¯¢è¯·æ±‚
    
    Returns:
        æŸ¥è¯¢å“åº”
    """
    
    print(f"\næ”¶åˆ°æŸ¥è¯¢ï¼š{request.content}")
    
    # æ„å›¾è¯†åˆ«
    intent = await detect_intent(request.content)
    print(f"æ„å›¾è¯†åˆ«ï¼š{intent}")
    
    # æ ¹æ®æ„å›¾è·¯ç”±
    if intent == "document_qa":
        result = await handle_document_qa(request.content)
    elif intent == "task_execution":
        result = await handle_task_execution(request.content)
    else:
        result = await handle_general_qa(request.content)
    
    return result

@app.post("/api/documents/upload")
async def upload_document(doc: DocumentUpload):
    """
    ä¸Šä¼ æ–‡æ¡£
    
    Args:
        doc: æ–‡æ¡£ä¿¡æ¯
    
    Returns:
        ä¸Šä¼ ç»“æœ
    """
    
    print(f"\nä¸Šä¼ æ–‡æ¡£ï¼š{doc.filename}")
    
    # å¤„ç†æ–‡æ¡£
    # 1. ä¿å­˜æ–‡æ¡£
    # 2. åˆ†å—
    # 3. å‘é‡åŒ–
    # 4. å­˜å‚¨åˆ°Qdrant
    
    return {
        "status": "success",
        "doc_id": "doc_123",
        "filename": doc.filename,
        "chunks": 15,
        "message": "æ–‡æ¡£ä¸Šä¼ æˆåŠŸ"
    }

@app.get("/api/documents")
async def list_documents(
    page: int = 1,
    page_size: int = 20
):
    """
    è·å–æ–‡æ¡£åˆ—è¡¨
    
    Args:
        page: é¡µç 
        page_size: æ¯é¡µæ•°é‡
    
    Returns:
        æ–‡æ¡£åˆ—è¡¨
    """
    
    # ä»æ•°æ®åº“æŸ¥è¯¢
    documents = [
        {
            "id": "doc_1",
            "filename": "PostgreSQLä¼˜åŒ–æŒ‡å—.md",
            "size": 12345,
            "chunks": 25,
            "created_at": "2024-01-15T10:30:00",
            "updated_at": "2024-01-15T10:30:00"
        },
        {
            "id": "doc_2",
            "filename": "Javaå¼€å‘è§„èŒƒ.pdf",
            "size": 23456,
            "chunks": 45,
            "created_at": "2024-01-14T15:20:00",
            "updated_at": "2024-01-14T15:20:00"
        }
    ]
    
    return {
        "total": len(documents),
        "page": page,
        "page_size": page_size,
        "documents": documents
    }

@app.delete("/api/documents/{doc_id}")
async def delete_document(doc_id: str):
    """
    åˆ é™¤æ–‡æ¡£
    
    Args:
        doc_id: æ–‡æ¡£ID
    
    Returns:
        åˆ é™¤ç»“æœ
    """
    
    print(f"\nåˆ é™¤æ–‡æ¡£ï¼š{doc_id}")
    
    # 1. ä»å‘é‡åº“åˆ é™¤
    # 2. ä»æ•°æ®åº“åˆ é™¤
    
    return {
        "status": "success",
        "message": f"æ–‡æ¡£ {doc_id} å·²åˆ é™¤"
    }

@app.get("/api/tasks/history")
async def get_task_history(limit: int = 50):
    """
    è·å–ä»»åŠ¡å†å²
    
    Args:
        limit: è¿”å›æ•°é‡
    
    Returns:
        ä»»åŠ¡åˆ—è¡¨
    """
    
    tasks = [
        {
            "id": "task_1",
            "task": "åˆ†æUserServiceä»£ç è´¨é‡",
            "status": "completed",
            "steps": 5,
            "duration": 12.5,
            "created_at": "2024-01-15T14:30:00"
        },
        {
            "id": "task_2",
            "task": "æŸ¥çœ‹æœ€è¿‘3å¤©çš„Gitæäº¤",
            "status": "completed",
            "steps": 2,
            "duration": 3.2,
            "created_at": "2024-01-15T14:25:00"
        }
    ]
    
    return {
        "total": len(tasks),
        "tasks": tasks
    }

@app.get("/api/stats/overview")
async def get_stats_overview():
    """
    è·å–ç»Ÿè®¡æ¦‚è§ˆ
    
    Returns:
        ç»Ÿè®¡æ•°æ®
    """
    
    return {
        "total_queries": 1234,
        "total_documents": 156,
        "total_tasks": 456,
        "avg_response_time": 1.8,
        "satisfaction_rate": 0.89,
        "active_users": 45
    }

# ============= è¾…åŠ©å‡½æ•° =============

async def detect_intent(query: str) -> str:
    """
    æ£€æµ‹ç”¨æˆ·æ„å›¾
    
    Args:
        query: ç”¨æˆ·è¾“å…¥
    
    Returns:
        æ„å›¾ç±»å‹
    """
    
    # ç®€å•è§„åˆ™ï¼ˆå®é™…åº”ä½¿ç”¨åˆ†ç±»æ¨¡å‹ï¼‰
    query_lower = query.lower()
    
    # ä»»åŠ¡æ‰§è¡Œå…³é”®è¯
    task_keywords = ["å¸®æˆ‘", "æ‰§è¡Œ", "è¿è¡Œ", "æŸ¥çœ‹", "ç»Ÿè®¡", "åˆ†æ"]
    if any(kw in query_lower for kw in task_keywords):
        return "task_execution"
    
    # æ–‡æ¡£é—®ç­”å…³é”®è¯
    doc_keywords = ["æ€ä¹ˆ", "å¦‚ä½•", "ä»€ä¹ˆæ˜¯", "ä¸ºä»€ä¹ˆ"]
    if any(kw in query_lower for kw in doc_keywords):
        return "document_qa"
    
    return "general_qa"

async def handle_document_qa(query: str) -> QueryResponse:
    """å¤„ç†æ–‡æ¡£é—®ç­”"""
    
    # è°ƒç”¨RAGç³»ç»Ÿ
    # result = rag_system.query(query)
    
    return QueryResponse(
        answer="PostgreSQLæ…¢æŸ¥è¯¢ä¼˜åŒ–å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…¥æ‰‹...",
        sources=[
            {"title": "PostgreSQLä¼˜åŒ–æŒ‡å—", "score": 0.92},
            {"title": "æ•°æ®åº“æ€§èƒ½è°ƒä¼˜", "score": 0.87}
        ],
        confidence=0.89,
        duration=1.5
    )

async def handle_task_execution(query: str) -> QueryResponse:
    """å¤„ç†ä»»åŠ¡æ‰§è¡Œ"""
    
    # è°ƒç”¨Agentç³»ç»Ÿ
    # result = agent.run(query)
    
    return QueryResponse(
        answer="å·²ä¸ºæ‚¨æ‰§è¡Œä»»åŠ¡ï¼Œç»“æœå¦‚ä¸‹ï¼š...",
        sources=[],
        confidence=0.95,
        duration=3.2
    )

async def handle_general_qa(query: str) -> QueryResponse:
    """å¤„ç†é€šç”¨é—®ç­”"""
    
    return QueryResponse(
        answer="è¿™æ˜¯ä¸€ä¸ªé€šç”¨é—®ç­”...",
        sources=[],
        confidence=0.75,
        duration=1.0
    )

# ============= è¿è¡Œè¯´æ˜ =============

print("""
="*60
FastAPIåç«¯æœåŠ¡
="*60

å¯åŠ¨å‘½ä»¤ï¼š
uvicorn main:app --host 0.0.0.0 --port 8000 --reload

APIæ–‡æ¡£ï¼š
â€¢ Swagger UI: http://localhost:8000/docs
â€¢ ReDoc: http://localhost:8000/redoc

ä¸»è¦ç«¯ç‚¹ï¼š
â€¢ POST /api/query - åŒæ­¥æŸ¥è¯¢
â€¢ WebSocket /ws - æµå¼æŸ¥è¯¢
â€¢ POST /api/documents/upload - ä¸Šä¼ æ–‡æ¡£
â€¢ GET /api/documents - æ–‡æ¡£åˆ—è¡¨
â€¢ GET /api/tasks/history - ä»»åŠ¡å†å²
â€¢ GET /api/stats/overview - ç»Ÿè®¡æ¦‚è§ˆ
=""*60
""")
```

---

## ğŸ’» ç¬¬äºŒéƒ¨åˆ†ï¼šWebSocketå®æ—¶é€šä¿¡

### ä¸€ã€WebSocketæœåŠ¡ç«¯

```python
from fastapi import WebSocket, WebSocketDisconnect
from typing import Dict, Set
import json

# è¿æ¥ç®¡ç†å™¨
class ConnectionManager:
    """WebSocketè¿æ¥ç®¡ç†å™¨"""
    
    def __init__(self):
        """åˆå§‹åŒ–"""
        self.active_connections: Dict[str, WebSocket] = {}
    
    async def connect(self, session_id: str, websocket: WebSocket):
        """
        å»ºç«‹è¿æ¥
        
        Args:
            session_id: ä¼šè¯ID
            websocket: WebSocketè¿æ¥
        """
        await websocket.accept()
        self.active_connections[session_id] = websocket
        print(f"âœ“ WebSocketè¿æ¥å»ºç«‹ï¼š{session_id}")
    
    def disconnect(self, session_id: str):
        """
        æ–­å¼€è¿æ¥
        
        Args:
            session_id: ä¼šè¯ID
        """
        if session_id in self.active_connections:
            del self.active_connections[session_id]
            print(f"âœ— WebSocketè¿æ¥æ–­å¼€ï¼š{session_id}")
    
    async def send_message(self, session_id: str, message: dict):
        """
        å‘é€æ¶ˆæ¯
        
        Args:
            session_id: ä¼šè¯ID
            message: æ¶ˆæ¯å†…å®¹
        """
        if session_id in self.active_connections:
            websocket = self.active_connections[session_id]
            await websocket.send_json(message)
    
    async def broadcast(self, message: dict):
        """
        å¹¿æ’­æ¶ˆæ¯
        
        Args:
            message: æ¶ˆæ¯å†…å®¹
        """
        for websocket in self.active_connections.values():
            await websocket.send_json(message)

# åˆ›å»ºè¿æ¥ç®¡ç†å™¨
manager = ConnectionManager()

@app.websocket("/ws/{session_id}")
async def websocket_endpoint(websocket: WebSocket, session_id: str):
    """
    WebSocketç«¯ç‚¹
    
    Args:
        websocket: WebSocketè¿æ¥
        session_id: ä¼šè¯ID
    """
    
    await manager.connect(session_id, websocket)
    
    try:
        while True:
            # æ¥æ”¶æ¶ˆæ¯
            data = await websocket.receive_json()
            
            print(f"\næ”¶åˆ°WebSocketæ¶ˆæ¯ï¼š{data}")
            
            # å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯
            msg_type = data.get("type")
            
            if msg_type == "query":
                # æµå¼æŸ¥è¯¢
                await handle_streaming_query(session_id, data)
            
            elif msg_type == "task":
                # ä»»åŠ¡æ‰§è¡Œ
                await handle_streaming_task(session_id, data)
            
            elif msg_type == "ping":
                # å¿ƒè·³
                await manager.send_message(session_id, {
                    "type": "pong",
                    "timestamp": datetime.now().isoformat()
                })
    
    except WebSocketDisconnect:
        manager.disconnect(session_id)
        print(f"å®¢æˆ·ç«¯æ–­å¼€ï¼š{session_id}")

async def handle_streaming_query(session_id: str, data: dict):
    """
    å¤„ç†æµå¼æŸ¥è¯¢
    
    Args:
        session_id: ä¼šè¯ID
        data: è¯·æ±‚æ•°æ®
    """
    
    query = data.get("content", "")
    print(f"æµå¼æŸ¥è¯¢ï¼š{query}")
    
    # æ„å›¾è¯†åˆ«
    intent = await detect_intent(query)
    
    # å‘é€å¼€å§‹æ¶ˆæ¯
    await manager.send_message(session_id, {
        "type": "start",
        "intent": intent
    })
    
    # æ¨¡æ‹Ÿæµå¼ç”Ÿæˆ
    full_answer = "PostgreSQLæ…¢æŸ¥è¯¢ä¼˜åŒ–å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢å…¥æ‰‹ï¼š1. å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿— 2. ä½¿ç”¨EXPLAINåˆ†æ 3. åˆ›å»ºåˆé€‚çš„ç´¢å¼•"
    
    # é€å­—æ¨é€
    current_text = ""
    for char in full_answer:
        current_text += char
        
        await manager.send_message(session_id, {
            "type": "stream",
            "content": current_text,
            "delta": char,
            "done": False
        })
        
        # æ¨¡æ‹Ÿå»¶è¿Ÿ
        await asyncio.sleep(0.05)
    
    # å‘é€å®Œæˆæ¶ˆæ¯
    await manager.send_message(session_id, {
        "type": "complete",
        "content": full_answer,
        "sources": [
            {
                "title": "PostgreSQLä¼˜åŒ–æŒ‡å—",
                "url": "/docs/pg-optimization",
                "score": 0.92
            }
        ],
        "done": True
    })

async def handle_streaming_task(session_id: str, data: dict):
    """
    å¤„ç†æµå¼ä»»åŠ¡
    
    Args:
        session_id: ä¼šè¯ID
        data: è¯·æ±‚æ•°æ®
    """
    
    task = data.get("content", "")
    print(f"æµå¼ä»»åŠ¡ï¼š{task}")
    
    # æ¨¡æ‹ŸAgentæ‰§è¡Œæ­¥éª¤
    steps = [
        {
            "step": 1,
            "thought": "æˆ‘éœ€è¦å…ˆæœç´¢UserServiceæ–‡ä»¶",
            "action": "file_search",
            "input": {"filename": "UserService.java"}
        },
        {
            "step": 2,
            "thought": "ç°åœ¨è¯»å–æ–‡ä»¶å†…å®¹",
            "action": "file_read",
            "input": {"path": "/src/.../UserService.java"}
        },
        {
            "step": 3,
            "thought": "ä½¿ç”¨ä»£ç åˆ†æå·¥å…·",
            "action": "code_analysis",
            "input": {"content": "...", "metrics": ["loc", "complexity"]}
        }
    ]
    
    for step_info in steps:
        # å‘é€æ€è€ƒè¿‡ç¨‹
        await manager.send_message(session_id, {
            "type": "agent_step",
            "step": step_info["step"],
            "thought": step_info["thought"],
            "action": step_info["action"],
            "input": step_info["input"],
            "status": "running"
        })
        
        await asyncio.sleep(1)
        
        # å‘é€æ‰§è¡Œç»“æœ
        await manager.send_message(session_id, {
            "type": "agent_step",
            "step": step_info["step"],
            "observation": f"æ‰§è¡ŒæˆåŠŸï¼š{step_info['action']}",
            "status": "success"
        })
        
        await asyncio.sleep(0.5)
    
    # å‘é€æœ€ç»ˆç»“æœ
    await manager.send_message(session_id, {
        "type": "task_complete",
        "result": "ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼ŒUserServiceç±»å…±450è¡Œä»£ç ...",
        "done": True
    })

print("""
WebSocketç«¯ç‚¹å·²é…ç½®ï¼š
â€¢ ç«¯ç‚¹ï¼š/ws/{session_id}
â€¢ åè®®ï¼šws://localhost:8000/ws/session_123

æ¶ˆæ¯ç±»å‹ï¼š
â€¢ query: æµå¼æŸ¥è¯¢
â€¢ task: ä»»åŠ¡æ‰§è¡Œ
â€¢ ping: å¿ƒè·³æ£€æµ‹
""")
```

---

## ğŸ¯ ç¬¬ä¸‰éƒ¨åˆ†ï¼šReactå‰ç«¯å®ç°

### ä¸€ã€èŠå¤©ç•Œé¢ç»„ä»¶

```typescript
// ChatInterface.tsx
import React, { useState, useEffect, useRef } from 'react';
import { Input, Button, Card, Avatar, Spin } from 'antd';
import { SendOutlined, UserOutlined, RobotOutlined } from '@ant-design/icons';
import ReactMarkdown from 'react-markdown';
import { Prism as SyntaxHighlighter } from 'react-syntax-highlighter';
import { vscDarkPlus } from 'react-syntax-highlighter/dist/esm/styles/prism';

const { TextArea } = Input;

interface Message {
  id: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: Array<{
    title: string;
    score: number;
  }>;
  timestamp: Date;
}

const ChatInterface: React.FC = () => {
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState('');
  const [loading, setLoading] = useState(false);
  const [streaming, setStreaming] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const wsRef = useRef<WebSocket | null>(null);
  
  // WebSocketè¿æ¥
  useEffect(() => {
    const sessionId = `session_${Date.now()}`;
    const ws = new WebSocket(`ws://localhost:8000/ws/${sessionId}`);
    
    ws.onopen = () => {
      console.log('âœ“ WebSocketè¿æ¥æˆåŠŸ');
    };
    
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      handleWebSocketMessage(data);
    };
    
    ws.onerror = (error) => {
      console.error('WebSocketé”™è¯¯:', error);
    };
    
    ws.onclose = () => {
      console.log('âœ— WebSocketè¿æ¥å…³é—­');
    };
    
    wsRef.current = ws;
    
    return () => {
      ws.close();
    };
  }, []);
  
  // å¤„ç†WebSocketæ¶ˆæ¯
  const handleWebSocketMessage = (data: any) => {
    console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
    
    switch (data.type) {
      case 'start':
        setStreaming(true);
        // æ·»åŠ ç©ºçš„åŠ©æ‰‹æ¶ˆæ¯
        setMessages(prev => [...prev, {
          id: `msg_${Date.now()}`,
          role: 'assistant',
          content: '',
          timestamp: new Date()
        }]);
        break;
      
      case 'stream':
        // æ›´æ–°æœ€åä¸€æ¡æ¶ˆæ¯
        setMessages(prev => {
          const newMessages = [...prev];
          const lastMsg = newMessages[newMessages.length - 1];
          if (lastMsg && lastMsg.role === 'assistant') {
            lastMsg.content = data.content;
          }
          return newMessages;
        });
        break;
      
      case 'complete':
        setStreaming(false);
        setLoading(false);
        // æ·»åŠ æ¥æºå¼•ç”¨
        setMessages(prev => {
          const newMessages = [...prev];
          const lastMsg = newMessages[newMessages.length - 1];
          if (lastMsg && lastMsg.role === 'assistant') {
            lastMsg.sources = data.sources;
          }
          return newMessages;
        });
        break;
      
      case 'agent_step':
        // æ˜¾ç¤ºAgentæ‰§è¡Œæ­¥éª¤
        console.log('Agentæ­¥éª¤:', data);
        break;
    }
  };
  
  // å‘é€æ¶ˆæ¯
  const handleSend = () => {
    if (!input.trim() || loading) return;
    
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    const userMessage: Message = {
      id: `msg_${Date.now()}`,
      role: 'user',
      content: input,
      timestamp: new Date()
    };
    
    setMessages(prev => [...prev, userMessage]);
    setInput('');
    setLoading(true);
    
    // é€šè¿‡WebSocketå‘é€
    if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
      wsRef.current.send(JSON.stringify({
        type: 'query',
        content: input,
        stream: true
      }));
    }
  };
  
  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);
  
  return (
    <div style={{ height: '100vh', display: 'flex', flexDirection: 'column' }}>
      {/* æ¶ˆæ¯åˆ—è¡¨ */}
      <div style={{ 
        flex: 1, 
        overflowY: 'auto', 
        padding: '20px',
        backgroundColor: '#f5f5f5'
      }}>
        {messages.map(msg => (
          <div
            key={msg.id}
            style={{
              marginBottom: '20px',
              display: 'flex',
              justifyContent: msg.role === 'user' ? 'flex-end' : 'flex-start'
            }}
          >
            <Card
              style={{
                maxWidth: '70%',
                backgroundColor: msg.role === 'user' ? '#1890ff' : '#fff',
                color: msg.role === 'user' ? '#fff' : '#000'
              }}
            >
              <div style={{ display: 'flex', alignItems: 'flex-start' }}>
                <Avatar
                  icon={msg.role === 'user' ? <UserOutlined /> : <RobotOutlined />}
                  style={{ marginRight: '12px' }}
                />
                <div style={{ flex: 1 }}>
                  {msg.role === 'assistant' ? (
                    <ReactMarkdown
                      components={{
                        code({node, inline, className, children, ...props}) {
                          const match = /language-(\w+)/.exec(className || '');
                          return !inline && match ? (
                            <SyntaxHighlighter
                              style={vscDarkPlus}
                              language={match[1]}
                              PreTag="div"
                              {...props}
                            >
                              {String(children).replace(/\n$/, '')}
                            </SyntaxHighlighter>
                          ) : (
                            <code className={className} {...props}>
                              {children}
                            </code>
                          );
                        }
                      }}
                    >
                      {msg.content}
                    </ReactMarkdown>
                  ) : (
                    <div>{msg.content}</div>
                  )}
                  
                  {/* æ¥æºå¼•ç”¨ */}
                  {msg.sources && msg.sources.length > 0 && (
                    <div style={{ marginTop: '12px', fontSize: '12px', opacity: 0.8 }}>
                      <div>å‚è€ƒæ–‡æ¡£ï¼š</div>
                      {msg.sources.map((source, idx) => (
                        <div key={idx}>
                          â€¢ {source.title} ({(source.score * 100).toFixed(0)}%)
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </Card>
          </div>
        ))}
        
        {/* åŠ è½½æŒ‡ç¤ºå™¨ */}
        {loading && (
          <div style={{ textAlign: 'center', padding: '20px' }}>
            <Spin tip={streaming ? "å›ç­”ä¸­..." : "æ€è€ƒä¸­..."} />
          </div>
        )}
        
        <div ref={messagesEndRef} />
      </div>
      
      {/* è¾“å…¥æ¡† */}
      <div style={{ 
        padding: '20px', 
        borderTop: '1px solid #e8e8e8',
        backgroundColor: '#fff'
      }}>
        <div style={{ display: 'flex', gap: '12px' }}>
          <TextArea
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onPressEnter={(e) => {
              if (!e.shiftKey) {
                e.preventDefault();
                handleSend();
              }
            }}
            placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜... (Shift+Enteræ¢è¡Œ)"
            autoSize={{ minRows: 1, maxRows: 6 }}
            disabled={loading}
          />
          <Button
            type="primary"
            icon={<SendOutlined />}
            onClick={handleSend}
            loading={loading}
            disabled={!input.trim()}
          >
            å‘é€
          </Button>
        </div>
        <div style={{ marginTop: '8px', fontSize: '12px', color: '#999' }}>
          ğŸ’¡ æç¤ºï¼šå¯ä»¥é—®æŠ€æœ¯é—®é¢˜ã€è¯·æ±‚ä»»åŠ¡æ‰§è¡Œã€åˆ†æä»£ç ç­‰
        </div>
      </div>
    </div>
  );
};

export default ChatInterface;
```

---

## ğŸ“ è¯¾åç»ƒä¹ 

### ç»ƒä¹ 1ï¼šAPIå¼€å‘
å®Œå–„å…¶ä»–APIç«¯ç‚¹

### ç»ƒä¹ 2ï¼šå‰ç«¯ç»„ä»¶
å¼€å‘çŸ¥è¯†åº“ç®¡ç†ç•Œé¢

### ç»ƒä¹ 3ï¼šå®æ—¶é€šä¿¡
ä¼˜åŒ–WebSocketæ€§èƒ½

---

## ğŸ“ çŸ¥è¯†æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **APIè®¾è®¡**
   - RESTfulè§„èŒƒ
   - æ•°æ®éªŒè¯
   - é”™è¯¯å¤„ç†

2. **å®æ—¶é€šä¿¡**
   - WebSocketè¿æ¥ç®¡ç†
   - æ¶ˆæ¯æ ¼å¼è®¾è®¡
   - æµå¼æ¨é€

3. **å‰ç«¯å¼€å‘**
   - Reactç»„ä»¶åŒ–
   - çŠ¶æ€ç®¡ç†
   - ç”¨æˆ·ä½“éªŒ

4. **ç³»ç»Ÿé›†æˆ**
   - æ„å›¾è·¯ç”±
   - RAG/Agentè°ƒç”¨
   - ç»“æœå±•ç¤º

---

## ğŸš€ ä¸‹èŠ‚é¢„å‘Š

ä¸‹ä¸€è¯¾ï¼š**ç¬¬115è¯¾ï¼šã€å¤§é¡¹ç›®ã€‘æ™ºèƒ½ç ”å‘åŠ©æ‰‹-æ¨¡å‹å¾®è°ƒä¸ä¼˜åŒ–**

- é¢†åŸŸæ•°æ®å‡†å¤‡
- Qwen2æ¨¡å‹å¾®è°ƒ
- æ•ˆæœè¯„ä¼°
- éƒ¨ç½²é›†æˆ

**è®©æ¨¡å‹æ›´æ‡‚ä½ çš„ä¸šåŠ¡ï¼** ğŸ”¥

---

**ğŸ’ª è®°ä½ï¼šå¥½çš„ç•Œé¢æ˜¯æˆåŠŸçš„ä¸€åŠï¼**

**ä¸‹ä¸€è¯¾è§ï¼** ğŸ‰
