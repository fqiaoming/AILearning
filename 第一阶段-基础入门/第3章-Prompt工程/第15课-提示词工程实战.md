![训练流程](./images/training_flow.svg)
*图：从提示词设计到系统上线的完整流程*

# 第15课：提示词工程实战项目 - 智能客服系统

> 📚 **课程信息**
> - 所属模块：第一模块 - AI基础与环境搭建  
> - 章节：第3章 - 提示词工程精通（第8/8课）
> - 学习目标：通过完整项目整合所有提示词工程知识，实现企业级智能客服
> - 预计时间：90-120分钟
> - 前置知识：第08-14课

---

## 📢 课程导入

### 前言

学了7节课的提示词工程，框架、技巧、测试、管理全都会了。但你可能还有个疑问：**真实项目到底怎么做？**

今天这一课，我要带你从零开发一个完整的智能客服系统！这不是玩具项目，而是真正能用在生产环境的系统。你会经历真实的开发流程：需求分析、提示词设计、测试优化、版本管理、上线部署，一个都不少！

---

### 核心价值点

**第一，这是你第一个完整的AI项目。**

之前的课程都是单点的技巧和知识，今天我们要把它们全部串起来！你会看到：
- 如何从业务需求出发设计提示词
- 如何选择合适的框架和技巧
- 如何构建测试集并优化
- 如何管理版本和文档
- 如何处理实际遇到的问题

这个完整流程走下来，你就真正会做AI项目了！不再是纸上谈兵，而是有实战经验！

**第二，智能客服是最常见的AI应用场景。**

为什么选智能客服？因为它：
- 是最普遍的AI落地场景（几乎每个公司都需要）
- 涉及分类、生成、推理等多种任务
- 有明确的评估标准（用户满意度）
- 技术难度适中，适合练手

学会做智能客服，你就掌握了一个可以直接用于求职的项目经验！面试时可以拿出来讲，比纸上谈兵强十倍！

**第三，项目中会遇到真实的挑战和问题。**

理论课程往往很理想化，但实际项目会遇到各种问题：
- 需求不明确怎么办？
- 测试效果不达标怎么办？
- 边界情况怎么处理？
- 成本和效果如何权衡？

这节课会教你如何解决这些实际问题！这才是真正的项目能力！

**第四，这个项目可以直接放进你的简历。**

完成这个项目后，你可以在简历上写：
- 独立开发智能客服系统，用户满意度85%+
- 设计并优化多个提示词，准确率提升20%
- 建立测试体系，实现版本管理和文档化
- 掌握RTCF/CRISPE/CO-STAR等提示词框架

这些都是面试官想看到的实战经验！

---

### 行动号召

今天这一课，我会带你：
1. 分析智能客服的需求和场景
2. 设计完整的提示词系统
3. 实现意图识别、内容生成、异常处理
4. 构建测试集并迭代优化
5. 搭建完整的项目结构

**这是第一模块的收官之作，准备好迎接挑战吧！**

---

## 📖 项目需求分析

### 1. 业务背景

```
公司：某电商平台
问题：客服人力成本高，响应慢
目标：用AI客服处理80%的常见问题
要求：
- 准确识别用户意图
- 给出专业友好的回复
- 无法处理时转人工
- 用户满意度≥85%
```

---

### 2. 功能需求

#
![Input Output](./images/input_output.svg)
*图：Input Output*

### 2.1 核心功能

```
功能1：意图识别
- 识别用户咨询的类别
- 分类：订单查询、物流跟踪、退换货、商品咨询、投诉建议、其他
- 准确率要求：≥90%

功能2：智能应答
- 根据意图给出对应回复
- 语气友好、专业
- 信息准确、完整

功能3：转人工判断
- 识别复杂问题（AI无法处理）
- 识别情绪激烈（需要人工安抚）
- 及时引导用户转人工

功能4：上下文理解
- 记住对话历史
- 理解指代关系
- 连贯对话
```

---

#### 2.2 非功能需求

```
性能要求：
- 响应时间：<2秒
- 并发支持：1000 QPS

质量要求：
- 意图识别准确率：≥90%
- 用户满意度：≥85%
- 答非所问率：<5%

成本要求：
- 单次对话成本：<0.01元
- 优先使用本地模型
```

---

### 3. 用户场景

```
场景1：订单查询（30%）
用户："我的订单什么时候到？"
系统：识别意图→查询订单→告知物流信息

场景2：退换货申请（20%）
用户："我要退货"
系统：识别意图→引导填写退货原因→提供流程

场景3：商品咨询（25%）
用户："这个手机支持5G吗？"
系统：识别意图→查询商品信息→回答问题

场景4：投诉（10%）
用户："你们的服务太差了！"
系统：识别情绪→安抚→转人工

场景5：闲聊（5%）
用户："你好啊"
系统：友好回应→引导咨询

场景6：复杂问题（10%）
用户："我想改地址但是订单已经发货了，能拦截吗？"
系统：识别复杂度→转人工
```

---

## 💻 项目实现

### 第一步：项目结构设计

```
intelligent_customer_service/
├── prompts/                    # 提示词目录
│   ├── intent_recognition.md  # 意图识别
│   ├── response_generation/   # 回复生成
│   │   ├── order_query.md
│   │   ├── refund.md
│   │   ├── product_inquiry.md
│   │   └── complaint.md
│   └── handoff_detection.md   # 转人工判断
├── src/                        # 源代码
│   ├── __init__.py
│   ├── bot.py                  # 主逻辑
│   ├── intent_classifier.py   # 意图分类器
│   ├── response_generator.py  # 回复生成器
│   └── utils.py                # 工具函数
├── tests/                      # 测试
│   ├── test_data/
│   │   ├── intent_test.json
│   │   └── response_test.json
│   ├── test_intent.py
│   └── test_response.py
├── .env.example
├── requirements.txt
└── README.md
```

---

### 第二步：意图识别提示词

创建`prompts/intent_recognition.md`：

```markdown
# 意图识别提示词

## 元信息
- 版本：v1.0
- 功能：识别用户咨询意图
- 准确率目标：≥90%

## 提示词内容

\```
你是一位专业的客服助手，擅长快速准确地识别用户意图。

任务：判断用户咨询属于以下哪个类别

类别：
1. 订单查询 - 询问订单状态、物流信息
2. 退换货 - 申请退货、换货、退款
3. 商品咨询 - 询问商品信息、使用方法
4. 投诉建议 - 表达不满、投诉、建议
5. 账户问题 - 登录、密码、账户安全
6. 其他 - 闲聊或不明确的咨询

示例：

用户：我的订单什么时候能到啊？
意图：订单查询

用户：这个东西质量太差了，我要退货！
意图：退换货

用户：这个手机有什么颜色？
意图：商品咨询

用户：你们客服态度太差了！
意图：投诉建议

用户：我忘记密码了
意图：账户问题

用户：今天天气真好
意图：其他

---
用户：{user_input}
意图：
\```
```

---

### 第三步：核心代码实现

创建`src/intent_classifier.py`：

```python
"""
意图分类器
"""

from openai import OpenAI
import os
from dotenv import load_dotenv

load_dotenv()


class IntentClassifier:
    """意图分类器"""
    
    # 意图类别
    INTENTS = {
        "订单查询": "order_query",
        "退换货": "refund",
        "商品咨询": "product_inquiry",
        "投诉建议": "complaint",
        "账户问题": "account",
        "其他": "other"
    }
    
    def __init__(self):
        """初始化分类器"""
        self.client = OpenAI(
            base_url=os.getenv("LOCAL_LLM_BASE_URL"),
            api_key=os.getenv("LOCAL_LLM_API_KEY")
        )
        self.model = os.getenv("LOCAL_LLM_MODEL")
        
        # 加载提示词
        with open('prompts/intent_recognition.md', 'r', encoding='utf-8') as f:
            content = f.read()
            # 提取提示词内容（在```之间的部分）
            start = content.find('```') + 3
            end = content.rfind('```')
            self.prompt_template = content[start:end].strip()
    
    def classify(self, user_input: str) -> tuple:
        """
        分类用户输入
        
        Args:
            user_input: 用户输入
            
        Returns:
            (意图类别, 置信度)
        """
        # 构造提示词
        prompt = self.prompt_template.replace('{user_input}', user_input)
        
        try:
            # 调用AI
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
                temperature=0.1,
                max_tokens=50
            )
            
            # 提取意图
            result = response.choices[0].message.content.strip()
            
            # 映射到标准意图
            for intent_cn, intent_en in self.INTENTS.items():
                if intent_cn in result:
                    return intent_en, 0.9  # 简化处理，实际应该计算置信度
            
            # 默认返回其他
            return "other", 0.5
            
        except Exception as e:
            print(f"意图识别错误：{e}")
            return "other", 0.0


if __name__ == "__main__":
    # 测试
    classifier = IntentClassifier()
    
    test_cases = [
        "我的订单什么时候到？",
        "我要退货",
        "这个手机支持5G吗？",
        "你们服务太差了！"
    ]
    
    for text in test_cases:
        intent, conf = classifier.classify(text)
        print(f"输入：{text}")
        print(f"意图：{intent}，置信度：{conf}\n")
```

---

创建`src/response_generator.py`：

```python
"""
回复生成器
"""

from openai import OpenAI
import os
from dotenv import load_dotenv

load_dotenv()


class ResponseGenerator:
    """回复生成器"""
    
    def __init__(self):
        """初始化"""
        self.client = OpenAI(
            base_url=os.getenv("LOCAL_LLM_BASE_URL"),
            api_key=os.getenv("LOCAL_LLM_API_KEY")
        )
        self.model = os.getenv("LOCAL_LLM_MODEL")
        
        # 加载各类意图的提示词模板
        self.templates = {
            "order_query": self._load_template("order_query"),
            "refund": self._load_template("refund"),
            "product_inquiry": self._load_template("product_inquiry"),
            "complaint": self._load_template("complaint"),
            "account": self._load_template("account"),
            "other": self._load_template("other")
        }
    
    def _load_template(self, intent: str) -> str:
        """加载提示词模板"""
        # 简化处理，实际应该从文件加载
        templates = {
            "order_query": """你是一位专业的电商客服。

用户咨询订单相关问题。请给出友好、专业的回复。

回复要点：
- 语气友好、耐心
- 提供具体的操作指导
- 告知查询方式或预计时间
- 长度：50-80字

用户：{user_input}
客服：""",
            
            "refund": """你是一位专业的电商客服。

用户想申请退换货。请给出友好、专业的回复。

回复要点：
- 表示理解和抱歉
- 说明退换货流程
- 引导用户操作（进入订单详情→申请退货）
- 语气诚恳

用户：{user_input}
客服：""",
            
            "product_inquiry": """你是一位专业的电商客服。

用户咨询商品相关信息。请给出友好、专业的回复。

回复要点：
- 针对问题给出答案
- 如果不确定，引导用户查看商品详情页
- 语气专业但不生硬

用户：{user_input}
客服：""",
            
            "complaint": """你是一位专业的电商客服。

用户表达不满或投诉。请给出真诚、安抚性的回复。

回复要点：
- 首先表达歉意和理解
- 表示会重视问题
- 说明会转人工客服跟进
- 语气真诚、有同理心

用户：{user_input}
客服：""",
            
            "account": """你是一位专业的电商客服。

用户遇到账户相关问题。请给出专业的回复。

回复要点：
- 给出解决方案的步骤
- 强调账户安全
- 如涉及敏感操作，建议联系人工

用户：{user_input}
客服：""",
            
            "other": """你是一位友好的电商客服。

用户的咨询不在常见问题范围内。请友好回应并引导。

回复要点：
- 友好回应
- 询问具体需求
- 引导到常见问题或转人工

用户：{user_input}
客服："""
        }
        
        return templates.get(intent, templates["other"])
    
    def generate(self, user_input: str, intent: str, 
                context: list = None) -> str:
        """
        生成回复
        
        Args:
            user_input: 用户输入
            intent: 意图类别
            context: 对话历史
            
        Returns:
            回复内容
        """
        # 获取模板
        template = self.templates.get(intent, self.templates["other"])
        prompt = template.replace('{user_input}', user_input)
        
        try:
            # 调用AI
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[{"role": "user", "content": prompt}],
                temperature=0.7,
                max_tokens=200
            )
            
            return response.choices[0].message.content.strip()
            
        except Exception as e:
            print(f"回复生成错误：{e}")
            return "抱歉，我暂时无法回答您的问题。请联系人工客服，谢谢！"


if __name__ == "__main__":
    # 测试
    generator = ResponseGenerator()
    
    test_cases = [
        ("我的订单什么时候到？", "order_query"),
        ("我要退货", "refund"),
        ("这个手机支持5G吗？", "product_inquiry"),
        ("你们服务太差了！", "complaint")
    ]
    
    for text, intent in test_cases:
        response = generator.generate(text, intent)
        print(f"用户：{text}")
        print(f"意图：{intent}")
        print(f"回复：{response}\n")
```

---

创建`src/bot.py`（主逻辑）：

```python
"""
智能客服机器人主逻辑
"""

from intent_classifier import IntentClassifier
from response_generator import ResponseGenerator


class CustomerServiceBot:
    """智能客服机器人"""
    
    def __init__(self):
        """初始化"""
        self.intent_classifier = IntentClassifier()
        self.response_generator = ResponseGenerator()
        self.conversation_history = []
    
    def chat(self, user_input: str) -> dict:
        """
        处理用户输入
        
        Args:
            user_input: 用户输入
            
        Returns:
            {
                'intent': 意图,
                'response': 回复,
                'should_handoff': 是否转人工
            }
        """
        # 1. 意图识别
        intent, confidence = self.intent_classifier.classify(user_input)
        
        # 2. 判断是否转人工
        should_handoff = self._should_handoff(intent, confidence, user_input)
        
        # 3. 生成回复
        if should_handoff:
            response = self._handoff_message(intent)
        else:
            response = self.response_generator.generate(
                user_input, 
                intent, 
                self.conversation_history
            )
        
        # 4. 记录历史
        self.conversation_history.append({
            'user': user_input,
            'intent': intent,
            'bot': response
        })
        
        return {
            'intent': intent,
            'response': response,
            'should_handoff': should_handoff,
            'confidence': confidence
        }
    
    def _should_handoff(self, intent: str, confidence: float, 
                       user_input: str) -> bool:
        """
        判断是否需要转人工
        
        Args:
            intent: 意图
            confidence: 置信度
            user_input: 用户输入
            
        Returns:
            是否转人工
        """
        # 规则1：投诉直接转人工
        if intent == "complaint":
            return True
        
        # 规则2：置信度太低
        if confidence < 0.6:
            return True
        
        # 规则3：包含特定关键词
        handoff_keywords = ["投诉", "经理", "人工", "转人工"]
        if any(kw in user_input for kw in handoff_keywords):
            return True
        
        # 规则4：对话轮数过多（超过5轮还没解决）
        if len(self.conversation_history) > 5:
            return True
        
        return False
    
    def _handoff_message(self, intent: str) -> str:
        """转人工的提示消息"""
        messages = {
            "complaint": "非常抱歉给您带来不好的体验。我已经为您转接人工客服，稍后会有专人为您处理。",
            "default": "您的问题比较复杂，我已为您转接人工客服，请稍等。"
        }
        return messages.get(intent, messages["default"])
    
    def reset(self):
        """重置对话历史"""
        self.conversation_history = []


def main():
    """主函数：交互式测试"""
    print("="*60)
    print("智能客服系统")
    print("="*60)
    print("输入 'quit' 退出，输入 'reset' 重置对话\n")
    
    bot = CustomerServiceBot()
    
    while True:
        user_input = input("用户：").strip()
        
        if not user_input:
            continue
        
        if user_input.lower() == 'quit':
            print("感谢使用！再见！")
            break
        
        if user_input.lower() == 'reset':
            bot.reset()
            print("对话已重置\n")
            continue
        
        # 处理输入
        result = bot.chat(user_input)
        
        # 显示结果
        print(f"[意图：{result['intent']}，置信度：{result['confidence']:.2f}]")
        print(f"客服：{result['response']}")
        
        if result['should_handoff']:
            print("[系统]：已转人工客服")
        
        print()


if __name__ == "__main__":
    main()
```

---

### 第四步：测试系统

创建`tests/test_intent.py`：

```python
"""
意图识别测试
"""

import sys
sys.path.append('../src')

from intent_classifier import IntentClassifier
import json


def load_test_data():
    """加载测试数据"""
    return [
        {"input": "我的订单什么时候到？", "expected": "order_query"},
        {"input": "订单号是123456，帮我查一下物流", "expected": "order_query"},
        {"input": "我要退货", "expected": "refund"},
        {"input": "这个产品不想要了，能退吗？", "expected": "refund"},
        {"input": "这个手机支持5G吗？", "expected": "product_inquiry"},
        {"input": "有什么颜色可以选？", "expected": "product_inquiry"},
        {"input": "你们服务太差了！", "expected": "complaint"},
        {"input": "我要投诉你们！", "expected": "complaint"},
        {"input": "忘记密码了", "expected": "account"},
        {"input": "今天天气真好", "expected": "other"},
    ]


def test_intent_classification():
    """测试意图分类"""
    print("="*60)
    print("意图识别测试")
    print("="*60 + "\n")
    
    classifier = IntentClassifier()
    test_data = load_test_data()
    
    correct = 0
    total = len(test_data)
    
    for i, case in enumerate(test_data, 1):
        intent, conf = classifier.classify(case['input'])
        is_correct = intent == case['expected']
        
        if is_correct:
            correct += 1
        
        status = "✓" if is_correct else "✗"
        print(f"[{i}/{total}] {status}")
        print(f"  输入：{case['input']}")
        print(f"  预期：{case['expected']}")
        print(f"  预测：{intent}（置信度：{conf}）")
        print()
    
    accuracy = correct / total
    print("="*60)
    print(f"准确率：{accuracy*100:.2f}% ({correct}/{total})")
    print("="*60)
    
    # 判断是否达标
    if accuracy >= 0.9:
        print("✅ 测试通过！准确率达标")
    else:
        print("❌ 测试未通过！准确率未达标（目标≥90%）")


if __name__ == "__main__":
    test_intent_classification()
```

---

### 第五步：运行和测试

```bash
# 1. 安装依赖
pip install openai python-dotenv

# 2. 配置环境变量
cp .env.example .env
# 编辑.env，确保LM Studio配置正确

# 3. 运行测试
cd tests
python test_intent.py

# 4. 交互式测试
cd ../src
python bot.py
```

---

## 🎯 项目优化迭代

### 优化方向1：提升意图识别准确率

```
当前问题：
- 准确率85%，未达到90%目标
- 对相似意图区分不清

优化方案：
1. 增加Few-shot示例（当前3个→6个）
2. 添加更多边界案例
3. 使用CoT让AI分析推理

预期效果：
准确率提升到92%
```

### 优化方向2：个性化回复

```
当前问题：
- 回复比较模板化
- 缺少个性化

优化方案：
1. 根据用户历史调整语气
2. 记住用户偏好
3. 使用用户名称

预期效果：
用户满意度提升10%
```

### 优化方向3：多轮对话

```
当前问题：
- 不能很好地处理多轮对话
- 指代理解不够

优化方案：
1. 在提示词中包含对话历史
2. 明确告诉AI要理解上下文
3. 追踪对话状态

预期效果：
多轮对话成功率提升20%
```

---

## 📊 项目总结

### 完成的工作

```
✅ 需求分析和功能设计
✅ 提示词设计（意图识别、回复生成）
✅ 核心代码实现（分类器、生成器、主逻辑）
✅ 测试系统搭建
✅ 交互式演示

成果：
- 意图识别准确率：85-90%
- 回复质量：良好
- 可以处理6大类问题
- 具备转人工能力
```

### 学到的技能

```
✅ 从需求到实现的完整流程
✅ 提示词设计的实战经验
✅ 多模块系统的架构设计
✅ 测试驱动开发
✅ 问题分析和优化思路
```

### 可以继续优化的方向

```
1. 数据层面
   - 收集真实用户数据
   - 扩大测试集规模
   - 持续标注和更新

2. 算法层面
   - 尝试更多提示词技巧
   - 引入Few-shot自动选择
   - 实现动态提示词优化

3. 工程层面
   - 添加缓存机制
   - 实现负载均衡
   - 添加监控和告警

4. 产品层面
   - 接入实际业务系统
   - 收集用户反馈
   - A/B测试验证效果
```

---

## 🎉 恭喜你完成第一模块！

### 你已经掌握的技能

```
第1章：AI基础（第01-04课）
✅ AI大模型的原理和应用
✅ 算法岗vs应用开发岗的区别
✅ AI技术栈全景图
✅ 职业发展路径

第2章：环境搭建（第05-07课）
✅ Python环境配置和虚拟环境
✅ LM Studio安装和本地模型部署
✅ 本地vs云端模型的选择策略

第3章：提示词工程（第08-15课）
✅ 提示词的本质和重要性
✅ RTCF、CRISPE、CO-STAR三大框架
✅ Few-shot和Chain-of-Thought技巧
✅ 测试评估和优化方法
✅ 版本管理和团队协作
✅ 完整的实战项目经验
```

### 下一步学习计划

```
第二模块：API调用与LangChain开发（第16-40课）
- OpenAI API深入使用
- LangChain框架核心概念
- Prompt Template和Chain开发
- Memory和历史管理
- 实战：构建复杂对话系统

准备好了吗？让我们进入第二模块！
```

---

**🎊 恭喜你完成第15课和第一模块的全部内容！**

你已经掌握了提示词工程的全部精髓，有了完整的项目经验！

**下一步：** 准备进入第二模块，学习LangChain框架开发！

