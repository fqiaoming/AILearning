![å®‰å…¨åˆè§„æ¶æ„](./images/security.svg)
*å›¾ï¼šå®‰å…¨åˆè§„æ¶æ„*

# ç¬¬131è¯¾ï¼šæ•°æ®å®‰å…¨ - è¾“å…¥éªŒè¯ä¸æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

> **æœ¬è¯¾ç›®æ ‡**ï¼šæŒæ¡æ•°æ®å®‰å…¨çš„æ ¸å¿ƒé˜²æŠ¤æŠ€æœ¯
> 
> **æ ¸å¿ƒæŠ€èƒ½**ï¼šè¾“å…¥éªŒè¯ã€SQLæ³¨å…¥é˜²æŠ¤ã€XSSé˜²æŠ¤ã€æ•°æ®åŠ å¯†
> 
> **å­¦ä¹ æ—¶é•¿**ï¼š90åˆ†é’Ÿ

---

## ğŸ“– å£æ’­æ–‡æ¡ˆï¼ˆ8åˆ†é’Ÿï¼‰
![Api Security](./images/api_security.svg)
*å›¾ï¼šApi Security*


### ğŸ¯ å‰è¨€

"ç³»ç»Ÿä¸Šçº¿äº†ï¼Œé»‘å®¢æ¥äº†ï¼Œ**æ€ä¹ˆé˜²ï¼Ÿ**

**å®‰å…¨æ— å°äº‹ï¼Œä»£ä»·å·¨å¤§ï¼**

**çœŸå®å®‰å…¨äº‹æ•…ï¼š**

```
æ¡ˆä¾‹1ï¼šEquifaxæ•°æ®æ³„éœ²ï¼ˆ2017ï¼‰
â€¢ 1.47äº¿ç”¨æˆ·ä¿¡æ¯æ³„éœ²
â€¢ åŸå› ï¼šæœªä¿®å¤å·²çŸ¥æ¼æ´
â€¢ æŸå¤±ï¼šè¶…è¿‡14äº¿ç¾å…ƒ
â€¢ CEOè¾èŒ

æ¡ˆä¾‹2ï¼šCapital Oneæ•°æ®æ³„éœ²ï¼ˆ2019ï¼‰
â€¢ 1äº¿å®¢æˆ·ä¿¡æ¯æ³„éœ²
â€¢ åŸå› ï¼šäº‘é…ç½®é”™è¯¯
â€¢ æŸå¤±ï¼š8000ä¸‡ç¾å…ƒç½šæ¬¾

æ¡ˆä¾‹3ï¼šTwitterè´¦å·åŠ«æŒï¼ˆ2020ï¼‰
â€¢ 130ä¸ªé«˜ä»·å€¼è´¦å·è¢«é»‘
â€¢ åŸå› ï¼šç¤¾ä¼šå·¥ç¨‹æ”»å‡»
â€¢ å½±å“ï¼šè‚¡ä»·æš´è·Œ

ä¸€ä¸ªæ¼æ´ï¼Œå€¾å®¶è¡äº§ï¼
```

**OWASP Top 10å®‰å…¨é£é™©ï¼š**

```
1. æ³¨å…¥æ”»å‡»ï¼ˆInjectionï¼‰
   â€¢ SQLæ³¨å…¥
   â€¢ NoSQLæ³¨å…¥
   â€¢ å‘½ä»¤æ³¨å…¥

2. èº«ä»½éªŒè¯å¤±æ•ˆ
   â€¢ å¼±å¯†ç 
   â€¢ ä¼šè¯ç®¡ç†

3. æ•æ„Ÿæ•°æ®æ³„éœ²
   â€¢ æ˜æ–‡å­˜å‚¨
   â€¢ ä¼ è¾“æœªåŠ å¯†

4. XMLå¤–éƒ¨å®ä½“ï¼ˆXXEï¼‰
   â€¢ XMLè§£ææ¼æ´

5. è®¿é—®æ§åˆ¶å¤±æ•ˆ
   â€¢ è¶Šæƒè®¿é—®
   â€¢ æƒé™æå‡

6. å®‰å…¨é…ç½®é”™è¯¯
   â€¢ é»˜è®¤é…ç½®
   â€¢ è°ƒè¯•ä¿¡æ¯æ³„éœ²

7. è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰
   â€¢ å­˜å‚¨å‹XSS
   â€¢ åå°„å‹XSS

8. ä¸å®‰å…¨çš„ååºåˆ—åŒ–
   â€¢ å¯¹è±¡æ³¨å…¥

9. ä½¿ç”¨æœ‰æ¼æ´çš„ç»„ä»¶
   â€¢ è¿‡æ—¶çš„ä¾èµ–

10. æ—¥å¿—å’Œç›‘æ§ä¸è¶³
    â€¢ æ— æ³•æ£€æµ‹æ”»å‡»

å‰3ä¸ªæœ€å±é™©ï¼
```

**SQLæ³¨å…¥çš„å±å®³ï¼š**

```
æ¼æ´ä»£ç ï¼š
def get_user(username):
    query = f"SELECT * FROM users WHERE username = '{username}'"
    return db.execute(query)

æ”»å‡»ï¼š
username = "admin' OR '1'='1"

å®é™…æ‰§è¡Œï¼š
SELECT * FROM users WHERE username = 'admin' OR '1'='1'

ç»“æœï¼šè¿”å›æ‰€æœ‰ç”¨æˆ·ï¼

æ›´å±é™©çš„æ”»å‡»ï¼š
username = "admin'; DROP TABLE users; --"

å®é™…æ‰§è¡Œï¼š
SELECT * FROM users WHERE username = 'admin';
DROP TABLE users;
--'

ç»“æœï¼šæ•°æ®åº“è¢«åˆ é™¤ï¼

ä¸€è¡Œä»£ç ï¼Œæ•°æ®å…¨æ¯ï¼
```

**é˜²æŠ¤çš„ä¸‰é“é˜²çº¿ï¼š**

```
ç¬¬ä¸€é“ï¼šè¾“å…¥éªŒè¯
â€¢ ç™½åå•éªŒè¯
â€¢ ç±»å‹æ£€æŸ¥
â€¢ é•¿åº¦é™åˆ¶
â€¢ æ ¼å¼éªŒè¯

ç¬¬äºŒé“ï¼šå‚æ•°åŒ–æŸ¥è¯¢
â€¢ ä½¿ç”¨ORM
â€¢ å‚æ•°ç»‘å®š
â€¢ é¿å…å­—ç¬¦ä¸²æ‹¼æ¥

ç¬¬ä¸‰é“ï¼šè¾“å‡ºç¼–ç 
â€¢ HTMLè½¬ä¹‰
â€¢ URLç¼–ç 
â€¢ JSONç¼–ç 

å±‚å±‚é˜²æŠ¤ï¼
```

**æ•æ„Ÿæ•°æ®ä¿æŠ¤ï¼š**

```
ã€æ•°æ®åˆ†ç±»ã€‘

å…¬å¼€æ•°æ®ï¼š
â€¢ äº§å“ä¿¡æ¯
â€¢ å…¬å‘Š
â†’ æ— éœ€åŠ å¯†

å†…éƒ¨æ•°æ®ï¼š
â€¢ ä¸šåŠ¡æ•°æ®
â€¢ æ—¥å¿—
â†’ è®¿é—®æ§åˆ¶

æ•æ„Ÿæ•°æ®ï¼š
â€¢ ç”¨æˆ·ä¿¡æ¯
â€¢ è®¢å•æ•°æ®
â†’ åŠ å¯†ä¼ è¾“

æœºå¯†æ•°æ®ï¼š
â€¢ å¯†ç 
â€¢ æ”¯ä»˜ä¿¡æ¯
â€¢ ä¸ªäººéšç§
â†’ åŠ å¯†å­˜å‚¨+ä¼ è¾“

ã€åŠ å¯†æ–¹æ¡ˆã€‘

ä¼ è¾“åŠ å¯†ï¼š
â€¢ HTTPSï¼ˆTLS/SSLï¼‰
â€¢ APIå¯†é’¥

å­˜å‚¨åŠ å¯†ï¼š
â€¢ å¯†ç ï¼šbcrypt/argon2
â€¢ æ•æ„Ÿå­—æ®µï¼šAES-256
â€¢ æ•°æ®åº“ï¼šé€æ˜åŠ å¯†

ã€æ•°æ®è„±æ•ã€‘

å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼š
â€¢ æ‰‹æœºå·ï¼š138****1234
â€¢ é‚®ç®±ï¼šu***@example.com
â€¢ å§“åï¼šå¼ *
â€¢ èº«ä»½è¯ï¼š42***********1234

æ—¥å¿—è¾“å‡ºï¼š
â€¢ å®Œå…¨è„±æ•
â€¢ ä¸è®°å½•æ•æ„Ÿä¿¡æ¯

ä¿æŠ¤éšç§ï¼
```

**ä»Šå¤©è¿™ä¸€è¯¾ï¼Œæˆ‘è¦å¸¦ä½ ï¼š**

**ç¬¬ä¸€éƒ¨åˆ†ï¼šè¾“å…¥éªŒè¯**
- PydanticéªŒè¯
- è‡ªå®šä¹‰æ ¡éªŒå™¨
- é»‘ç™½åå•

**ç¬¬äºŒéƒ¨åˆ†ï¼šæ³¨å…¥é˜²æŠ¤**
- SQLæ³¨å…¥é˜²æŠ¤
- NoSQLæ³¨å…¥é˜²æŠ¤
- å‘½ä»¤æ³¨å…¥é˜²æŠ¤

**ç¬¬ä¸‰éƒ¨åˆ†ï¼šXSSé˜²æŠ¤**
- è¾“å‡ºç¼–ç 
- CSPç­–ç•¥
- å®‰å…¨headers

**ç¬¬å››éƒ¨åˆ†ï¼šæ•°æ®åŠ å¯†**
- å¯†ç åŠ å¯†
- æ•æ„Ÿæ•°æ®åŠ å¯†
- æ•°æ®è„±æ•

å»ºç«‹å®‰å…¨é˜²çº¿ï¼"

---

## ğŸ“š ç¬¬ä¸€éƒ¨åˆ†ï¼šè¾“å…¥éªŒè¯

### ä¸€ã€Pydanticä¸¥æ ¼éªŒè¯

```python
# app/models/security.py
from pydantic import BaseModel, Field, validator, EmailStr
from typing import Optional
import re

class SecureUserInput(BaseModel):
    """å®‰å…¨çš„ç”¨æˆ·è¾“å…¥æ¨¡å‹"""
    
    username: str = Field(
        ...,
        min_length=3,
        max_length=20,
        regex=r'^[a-zA-Z0-9_]+$',  # åªå…è®¸å­—æ¯æ•°å­—ä¸‹åˆ’çº¿
        description="ç”¨æˆ·å"
    )
    
    email: EmailStr = Field(
        ...,
        description="é‚®ç®±"
    )
    
    password: str = Field(
        ...,
        min_length=8,
        max_length=50,
        description="å¯†ç "
    )
    
    phone: Optional[str] = Field(
        None,
        regex=r'^1[3-9]\d{9}$',  # ä¸­å›½æ‰‹æœºå·
        description="æ‰‹æœºå·"
    )
    
    @validator('username')
    def validate_username(cls, v):
        """éªŒè¯ç”¨æˆ·å"""
        # é»‘åå•æ£€æŸ¥
        blacklist = ['admin', 'root', 'system']
        if v.lower() in blacklist:
            raise ValueError('ç”¨æˆ·åä¸å¯ç”¨')
        
        # ä¸å…è®¸SQLå…³é”®å­—
        sql_keywords = ['select', 'insert', 'update', 'delete', 'drop']
        if any(keyword in v.lower() for keyword in sql_keywords):
            raise ValueError('ç”¨æˆ·ååŒ…å«éæ³•å­—ç¬¦')
        
        return v
    
    @validator('password')
    def validate_password(cls, v):
        """éªŒè¯å¯†ç å¼ºåº¦"""
        # è‡³å°‘åŒ…å«ä¸€ä¸ªæ•°å­—
        if not re.search(r'\d', v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«æ•°å­—')
        
        # è‡³å°‘åŒ…å«ä¸€ä¸ªå­—æ¯
        if not re.search(r'[a-zA-Z]', v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«å­—æ¯')
        
        # è‡³å°‘åŒ…å«ä¸€ä¸ªç‰¹æ®Šå­—ç¬¦
        if not re.search(r'[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]', v):
            raise ValueError('å¯†ç å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦')
        
        return v
    
    class Config:
        # é¢å¤–å­—æ®µæŠ¥é”™
        extra = 'forbid'

class SecurePredictInput(BaseModel):
    """å®‰å…¨çš„é¢„æµ‹è¾“å…¥"""
    
    text: str = Field(
        ...,
        min_length=1,
        max_length=10000,
        description="è¾“å…¥æ–‡æœ¬"
    )
    
    model_name: str = Field(
        default="default",
        regex=r'^[a-zA-Z0-9\-_]+$',  # åªå…è®¸å®‰å…¨å­—ç¬¦
        description="æ¨¡å‹åç§°"
    )
    
    @validator('text')
    def validate_text(cls, v):
        """éªŒè¯æ–‡æœ¬"""
        # å»é™¤ç©ºç™½
        v = v.strip()
        
        if not v:
            raise ValueError('æ–‡æœ¬ä¸èƒ½ä¸ºç©º')
        
        # æ£€æŸ¥å±é™©å­—ç¬¦
        dangerous_chars = ['<script', 'javascript:', 'onerror=']
        if any(char in v.lower() for char in dangerous_chars):
            raise ValueError('æ–‡æœ¬åŒ…å«å±é™©å†…å®¹')
        
        return v
    
    @validator('model_name')
    def validate_model_name(cls, v):
        """éªŒè¯æ¨¡å‹åç§°"""
        # ç™½åå•
        allowed_models = ['default', 'gpt-3.5', 'gpt-4', 'claude']
        if v not in allowed_models:
            raise ValueError(f'ä¸æ”¯æŒçš„æ¨¡å‹ï¼š{v}')
        
        return v
```

### äºŒã€è‡ªå®šä¹‰éªŒè¯å™¨

```python
# app/core/validators.py
import re
from typing import Any
from fastapi import HTTPException, status

class InputValidator:
    """è¾“å…¥éªŒè¯å™¨"""
    
    @staticmethod
    def validate_sql_injection(value: str) -> str:
        """
        SQLæ³¨å…¥æ£€æµ‹
        
        Args:
            value: è¾“å…¥å€¼
        
        Returns:
            æ¸…ç†åçš„å€¼
        
        Raises:
            HTTPException: æ£€æµ‹åˆ°SQLæ³¨å…¥
        """
        # SQLå…³é”®å­—æ£€æµ‹
        sql_keywords = [
            'select', 'insert', 'update', 'delete', 'drop',
            'create', 'alter', 'exec', 'execute', 'union',
            'or', 'and', '--', ';', '/*', '*/'
        ]
        
        value_lower = value.lower()
        
        for keyword in sql_keywords:
            if keyword in value_lower:
                raise HTTPException(
                    status_code=status.HTTP_400_BAD_REQUEST,
                    detail=f"è¾“å…¥åŒ…å«éæ³•å†…å®¹: {keyword}"
                )
        
        return value
    
    @staticmethod
    def validate_xss(value: str) -> str:
        """
        XSSæ”»å‡»æ£€æµ‹
        
        Args:
            value: è¾“å…¥å€¼
        
        Returns:
            æ¸…ç†åçš„å€¼
        """
        # å±é™©æ ‡ç­¾å’Œå±æ€§
        dangerous_patterns = [
            r'<script[^>]*>.*?</script>',
            r'javascript:',
            r'onerror\s*=',
            r'onclick\s*=',
            r'onload\s*=',
            r'<iframe',
            r'<object',
            r'<embed'
        ]
        
        for pattern in dangerous_patterns:
            if re.search(pattern, value, re.IGNORECASE):
                raise HTTPException(
                    status_code=status.HTTP_400_BAD_REQUEST,
                    detail="è¾“å…¥åŒ…å«å±é™©å†…å®¹"
                )
        
        return value
    
    @staticmethod
    def validate_command_injection(value: str) -> str:
        """
        å‘½ä»¤æ³¨å…¥æ£€æµ‹
        
        Args:
            value: è¾“å…¥å€¼
        
        Returns:
            æ¸…ç†åçš„å€¼
        """
        # å±é™©å­—ç¬¦
        dangerous_chars = ['|', '&', ';', '$', '`', '\n', '\r']
        
        for char in dangerous_chars:
            if char in value:
                raise HTTPException(
                    status_code=status.HTTP_400_BAD_REQUEST,
                    detail="è¾“å…¥åŒ…å«éæ³•å­—ç¬¦"
                )
        
        return value
    
    @staticmethod
    def sanitize_filename(filename: str) -> str:
        """
        æ–‡ä»¶åæ¸…ç†
        
        Args:
            filename: æ–‡ä»¶å
        
        Returns:
            æ¸…ç†åçš„æ–‡ä»¶å
        """
        # ç§»é™¤è·¯å¾„éå†å­—ç¬¦
        filename = filename.replace('..', '')
        filename = filename.replace('/', '')
        filename = filename.replace('\\', '')
        
        # åªä¿ç•™å®‰å…¨å­—ç¬¦
        filename = re.sub(r'[^a-zA-Z0-9._-]', '', filename)
        
        # é™åˆ¶é•¿åº¦
        if len(filename) > 255:
            filename = filename[:255]
        
        return filename
```

---

## ğŸ’» ç¬¬äºŒéƒ¨åˆ†ï¼šæ³¨å…¥é˜²æŠ¤

### ä¸€ã€SQLæ³¨å…¥é˜²æŠ¤

```python
# app/db/safe_queries.py
from sqlalchemy import text
from sqlalchemy.orm import Session
from typing import List, Dict, Any

class SafeQuery:
    """å®‰å…¨çš„æ•°æ®åº“æŸ¥è¯¢"""
    
    def __init__(self, db: Session):
        """åˆå§‹åŒ–"""
        self.db = db
    
    def get_user_by_username(self, username: str) -> Dict:
        """
        å®‰å…¨çš„ç”¨æˆ·æŸ¥è¯¢
        
        Args:
            username: ç”¨æˆ·å
        
        Returns:
            ç”¨æˆ·ä¿¡æ¯
        """
        # âœ“ æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
        query = text("""
            SELECT id, username, email, created_at
            FROM users
            WHERE username = :username
        """)
        
        result = self.db.execute(query, {"username": username}).fetchone()
        
        if result:
            return {
                "id": result.id,
                "username": result.username,
                "email": result.email,
                "created_at": result.created_at
            }
        
        return None
    
    def search_users(self, keyword: str) -> List[Dict]:
        """
        å®‰å…¨çš„ç”¨æˆ·æœç´¢
        
        Args:
            keyword: æœç´¢å…³é”®è¯
        
        Returns:
            ç”¨æˆ·åˆ—è¡¨
        """
        # âœ“ æ­£ç¡®ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ + LIKEè½¬ä¹‰
        # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
        keyword = keyword.replace('%', '\\%').replace('_', '\\_')
        
        query = text("""
            SELECT id, username, email
            FROM users
            WHERE username LIKE :pattern
            ESCAPE '\\'
            LIMIT 100
        """)
        
        results = self.db.execute(
            query,
            {"pattern": f"%{keyword}%"}
        ).fetchall()
        
        return [
            {
                "id": r.id,
                "username": r.username,
                "email": r.email
            }
            for r in results
        ]
    
    def batch_update_users(self, updates: List[Dict]) -> int:
        """
        æ‰¹é‡æ›´æ–°ç”¨æˆ·
        
        Args:
            updates: æ›´æ–°åˆ—è¡¨
        
        Returns:
            æ›´æ–°æ•°é‡
        """
        # âœ“ æ­£ç¡®ï¼šä½¿ç”¨æ‰¹é‡å‚æ•°åŒ–æŸ¥è¯¢
        query = text("""
            UPDATE users
            SET email = :email, updated_at = NOW()
            WHERE id = :user_id
        """)
        
        count = 0
        for update in updates:
            result = self.db.execute(query, {
                "user_id": update["id"],
                "email": update["email"]
            })
            count += result.rowcount
        
        self.db.commit()
        
        return count

# é”™è¯¯ç¤ºä¾‹ï¼ˆä¾›å‚è€ƒï¼Œåˆ‡å‹¿ä½¿ç”¨ï¼‰
class UnsafeQuery:
    """ä¸å®‰å…¨çš„æŸ¥è¯¢ç¤ºä¾‹"""
    
    def get_user_dangerous(self, username: str):
        """
        âœ— é”™è¯¯ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ï¼ŒSQLæ³¨å…¥é£é™©
        """
        query = f"SELECT * FROM users WHERE username = '{username}'"
        # æ”»å‡»ï¼šusername = "admin' OR '1'='1"
        # å®é™…æ‰§è¡Œï¼šSELECT * FROM users WHERE username = 'admin' OR '1'='1'
        return self.db.execute(query)
    
    def search_users_dangerous(self, keyword: str):
        """
        âœ— é”™è¯¯ï¼šä½¿ç”¨%æ ¼å¼åŒ–ï¼ŒSQLæ³¨å…¥é£é™©
        """
        query = "SELECT * FROM users WHERE username LIKE '%%%s%%'" % keyword
        return self.db.execute(query)
```

### äºŒã€NoSQLæ³¨å…¥é˜²æŠ¤

```python
# app/db/mongodb_safe.py
from pymongo import MongoClient
from typing import Dict, Any
import re

class SafeMongoQuery:
    """å®‰å…¨çš„MongoDBæŸ¥è¯¢"""
    
    def __init__(self, db):
        """åˆå§‹åŒ–"""
        self.db = db
    
    def find_user(self, username: str) -> Dict:
        """
        å®‰å…¨çš„æŸ¥è¯¢
        
        Args:
            username: ç”¨æˆ·å
        
        Returns:
            ç”¨æˆ·ä¿¡æ¯
        """
        # âœ“ æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨å€¼ï¼Œä¸ä½¿ç”¨$where
        return self.db.users.find_one({"username": username})
    
    def search_users(self, keyword: str) -> list:
        """
        å®‰å…¨çš„æœç´¢
        
        Args:
            keyword: å…³é”®è¯
        
        Returns:
            ç”¨æˆ·åˆ—è¡¨
        """
        # âœ“ æ­£ç¡®ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½†è¦è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦
        # è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
        escaped_keyword = re.escape(keyword)
        
        # ä½¿ç”¨$regexï¼Œä½†é™åˆ¶é€‰é¡¹
        return list(self.db.users.find({
            "username": {
                "$regex": escaped_keyword,
                "$options": "i"
            }
        }).limit(100))
    
    def validate_query(self, query: Dict) -> Dict:
        """
        éªŒè¯æŸ¥è¯¢å®‰å…¨æ€§
        
        Args:
            query: æŸ¥è¯¢å­—å…¸
        
        Returns:
            æ¸…ç†åçš„æŸ¥è¯¢
        """
        # ä¸å…è®¸çš„æ“ä½œç¬¦
        dangerous_operators = [
            '$where',  # JavaScriptæ‰§è¡Œ
            '$function',  # å‡½æ•°æ‰§è¡Œ
            '$accumulator'  # èšåˆå‡½æ•°æ‰§è¡Œ
        ]
        
        def check_dict(d: Dict):
            for key, value in d.items():
                if key in dangerous_operators:
                    raise ValueError(f"ä¸å…è®¸ä½¿ç”¨ {key} æ“ä½œç¬¦")
                
                if isinstance(value, dict):
                    check_dict(value)
                elif isinstance(value, list):
                    for item in value:
                        if isinstance(item, dict):
                            check_dict(item)
        
        check_dict(query)
        
        return query

# é”™è¯¯ç¤ºä¾‹
class UnsafeMongoQuery:
    """ä¸å®‰å…¨çš„MongoDBæŸ¥è¯¢"""
    
    def find_user_dangerous(self, username: str):
        """
        âœ— é”™è¯¯ï¼šä½¿ç”¨$whereï¼Œå¯æ‰§è¡ŒJavaScript
        """
        # æ”»å‡»ï¼šusername = "'; return true; //"
        return self.db.users.find_one({
            "$where": f"this.username == '{username}'"
        })
```

---

## ğŸ¯ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•°æ®åŠ å¯†

### ä¸€ã€å¯†ç åŠ å¯†

```python
# app/core/crypto.py
from passlib.context import CryptContext
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2
import base64
import os

# å¯†ç ä¸Šä¸‹æ–‡ï¼ˆbcryptï¼‰
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

class PasswordManager:
    """å¯†ç ç®¡ç†å™¨"""
    
    @staticmethod
    def hash_password(password: str) -> str:
        """
        åŠ å¯†å¯†ç 
        
        Args:
            password: æ˜æ–‡å¯†ç 
        
        Returns:
            åŠ å¯†åçš„å¯†ç 
        """
        return pwd_context.hash(password)
    
    @staticmethod
    def verify_password(plain_password: str, hashed_password: str) -> bool:
        """
        éªŒè¯å¯†ç 
        
        Args:
            plain_password: æ˜æ–‡å¯†ç 
            hashed_password: åŠ å¯†å¯†ç 
        
        Returns:
            æ˜¯å¦åŒ¹é…
        """
        return pwd_context.verify(plain_password, hashed_password)

class DataEncryption:
    """æ•°æ®åŠ å¯†"""
    
    def __init__(self, secret_key: str = None):
        """
        åˆå§‹åŒ–
        
        Args:
            secret_key: å¯†é’¥ï¼ˆ32å­—èŠ‚base64ç¼–ç ï¼‰
        """
        if secret_key is None:
            # ç”Ÿæˆæ–°å¯†é’¥
            secret_key = Fernet.generate_key()
        
        self.fernet = Fernet(secret_key)
    
    def encrypt(self, data: str) -> str:
        """
        åŠ å¯†æ•°æ®
        
        Args:
            data: æ˜æ–‡æ•°æ®
        
        Returns:
            åŠ å¯†åçš„æ•°æ®ï¼ˆbase64ç¼–ç ï¼‰
        """
        encrypted = self.fernet.encrypt(data.encode())
        return base64.b64encode(encrypted).decode()
    
    def decrypt(self, encrypted_data: str) -> str:
        """
        è§£å¯†æ•°æ®
        
        Args:
            encrypted_data: åŠ å¯†çš„æ•°æ®
        
        Returns:
            æ˜æ–‡æ•°æ®
        """
        encrypted = base64.b64decode(encrypted_data.encode())
        decrypted = self.fernet.decrypt(encrypted)
        return decrypted.decode()

class DataMasking:
    """æ•°æ®è„±æ•"""
    
    @staticmethod
    def mask_phone(phone: str) -> str:
        """
        è„±æ•æ‰‹æœºå·
        
        Args:
            phone: æ‰‹æœºå·
        
        Returns:
            è„±æ•åçš„æ‰‹æœºå·
        """
        if len(phone) != 11:
            return phone
        
        return f"{phone[:3]}****{phone[7:]}"
    
    @staticmethod
    def mask_email(email: str) -> str:
        """
        è„±æ•é‚®ç®±
        
        Args:
            email: é‚®ç®±
        
        Returns:
            è„±æ•åçš„é‚®ç®±
        """
        if '@' not in email:
            return email
        
        username, domain = email.split('@')
        
        if len(username) <= 2:
            masked_username = username[0] + '*'
        else:
            masked_username = username[0] + '*' * (len(username) - 2) + username[-1]
        
        return f"{masked_username}@{domain}"
    
    @staticmethod
    def mask_id_card(id_card: str) -> str:
        """
        è„±æ•èº«ä»½è¯å·
        
        Args:
            id_card: èº«ä»½è¯å·
        
        Returns:
            è„±æ•åçš„èº«ä»½è¯å·
        """
        if len(id_card) != 18:
            return id_card
        
        return f"{id_card[:6]}********{id_card[-4:]}"

# ä½¿ç”¨ç¤ºä¾‹
password_manager = PasswordManager()

# æ³¨å†Œæ—¶åŠ å¯†å¯†ç 
hashed = password_manager.hash_password("my_password123")
print(f"åŠ å¯†åï¼š{hashed}")

# ç™»å½•æ—¶éªŒè¯å¯†ç 
is_valid = password_manager.verify_password("my_password123", hashed)
print(f"éªŒè¯ç»“æœï¼š{is_valid}")

# æ•°æ®åŠ å¯†
encryptor = DataEncryption()
encrypted = encryptor.encrypt("æ•æ„Ÿä¿¡æ¯")
print(f"åŠ å¯†ï¼š{encrypted}")

decrypted = encryptor.decrypt(encrypted)
print(f"è§£å¯†ï¼š{decrypted}")

# æ•°æ®è„±æ•
masker = DataMasking()
print(masker.mask_phone("13812345678"))  # 138****5678
print(masker.mask_email("user@example.com"))  # u***r@example.com
print(masker.mask_id_card("420123199001011234"))  # 420123********1234
```

---

## ğŸ“ è¯¾åæ€»ç»“

### æ ¸å¿ƒæ”¶è·

1. **è¾“å…¥éªŒè¯**
   - Pydanticä¸¥æ ¼éªŒè¯
   - è‡ªå®šä¹‰æ ¡éªŒå™¨
   - é»‘ç™½åå•

2. **æ³¨å…¥é˜²æŠ¤**
   - SQLå‚æ•°åŒ–æŸ¥è¯¢
   - NoSQLå®‰å…¨æŸ¥è¯¢
   - å‘½ä»¤æ³¨å…¥é˜²æŠ¤

3. **XSSé˜²æŠ¤**
   - è¾“å‡ºç¼–ç 
   - å±é™©å­—ç¬¦è¿‡æ»¤

4. **æ•°æ®åŠ å¯†**
   - å¯†ç bcrypt
   - æ•æ„Ÿæ•°æ®AES
   - æ•°æ®è„±æ•

---

## ğŸš€ ä¸‹èŠ‚é¢„å‘Š

ä¸‹ä¸€è¯¾ï¼š**ç¬¬132è¯¾ï¼šAPIå®‰å…¨ - è®¤è¯ã€é‰´æƒä¸é™æµ**

- JWTè®¤è¯
- OAuth2
- APIé™æµ
- CORSé…ç½®

**ä¿æŠ¤APIï¼** ğŸ”¥

---

**ğŸ’ª æ•°æ®å®‰å…¨é˜²çº¿å»ºç«‹å®Œæˆï¼ç³»ç»Ÿå›ºè‹¥é‡‘æ±¤ï¼**

**ä¸‹ä¸€è¯¾è§ï¼** ğŸ‰
