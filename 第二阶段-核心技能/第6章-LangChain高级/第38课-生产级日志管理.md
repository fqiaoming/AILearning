![ç›‘æ§ä¸æ€§èƒ½åˆ†æ](./images/monitoring.svg)
*å›¾ï¼šç›‘æ§ä¸æ€§èƒ½åˆ†æ*

# ç¬¬38è¯¾ï¼šç”Ÿäº§çº§æ—¥å¿—ç®¡ç† - æ„å»ºå¯é çš„æ—¥å¿—ç³»ç»Ÿ

> ğŸ“š **è¯¾ç¨‹ä¿¡æ¯**
> - æ‰€å±æ¨¡å—ï¼šç¬¬äºŒæ¨¡å— - APIä¸LangChainå¼€å‘  
> - ç« èŠ‚ï¼šç¬¬7ç«  - LangChainè°ƒè¯•ä¸ç›‘æ§ï¼ˆç¬¬2/4è¯¾ï¼‰
> - å­¦ä¹ ç›®æ ‡ï¼šæŒæ¡ç”Ÿäº§çº§æ—¥å¿—ç³»ç»Ÿè®¾è®¡å’Œå®ç°
> - é¢„è®¡æ—¶é—´ï¼š80-90åˆ†é’Ÿ
> - å‰ç½®çŸ¥è¯†ï¼šç¬¬23-37è¯¾

---

## ğŸ“¢ è¯¾ç¨‹å¯¼å…¥

### å‰è¨€

å‡Œæ™¨3ç‚¹ï¼Œä½ è¢«ç”µè¯åµé†’ï¼š**"ç³»ç»Ÿå´©äº†ï¼ç”¨æˆ·æ— æ³•ä½¿ç”¨ï¼"** ä½ æ€¥å¿™æ‰“å¼€ç”µè„‘ï¼Œæƒ³çœ‹æ—¥å¿—æŸ¥é—®é¢˜ï¼Œç»“æœå‘ç°ï¼šæ—¥å¿—æ‰¾ä¸åˆ°äº†ï¼æˆ–è€…æ—¥å¿—å¤ªä¹±ï¼Œå‡ åä¸‡æ¡è®°å½•æ ¹æœ¬æ‰¾ä¸åˆ°å…³é”®ä¿¡æ¯ï¼

è¿™ç§æƒ…å†µåœ¨ç”Ÿäº§ç¯å¢ƒå¤ªå¸¸è§äº†ï¼æ²¡æœ‰å¥½çš„æ—¥å¿—ç³»ç»Ÿï¼Œå‡ºé—®é¢˜å°±æ˜¯å™©æ¢¦ï¼ä½†å¦‚æœä½ æœ‰å®Œå–„çš„æ—¥å¿—ç³»ç»Ÿï¼š**å‡ ç§’é’Ÿå®šä½é—®é¢˜ã€å¿«é€Ÿå›æº¯ã€ç²¾å‡†è¿˜åŸç°åœº**ï¼Œé—®é¢˜è¿åˆƒè€Œè§£ï¼

ä»Šå¤©è¿™è¯¾ï¼Œæˆ‘è¦æ•™ä½ å¦‚ä½•æ„å»º**ä¼ä¸šçº§æ—¥å¿—ç³»ç»Ÿ**ï¼è®©ä½ çš„ç³»ç»Ÿå‡ºé—®é¢˜æ—¶ï¼Œæœ‰æ®å¯æŸ¥ã€å¿«é€Ÿå®šä½ï¼

---

### æ ¸å¿ƒä»·å€¼ç‚¹

**ç¬¬ä¸€ï¼Œæ—¥å¿—æ˜¯ç”Ÿäº§ç¯å¢ƒçš„é»‘åŒ£å­ã€‚**

ç³»ç»Ÿå´©æºƒåï¼Œæ—¥å¿—æ˜¯å”¯ä¸€çš„çº¿ç´¢ï¼š
- ç”¨æˆ·åšäº†ä»€ä¹ˆæ“ä½œï¼Ÿ
- ç³»ç»Ÿè¿”å›äº†ä»€ä¹ˆï¼Ÿ
- å“ªé‡Œå‡ºé”™äº†ï¼Ÿ
- å½“æ—¶çš„çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Ÿ

**æ²¡æœ‰æ—¥å¿—ï¼Œå°±æ˜¯ç›²äººæ‘¸è±¡ï¼**

**ç¬¬äºŒï¼Œå¥½æ—¥å¿—å’Œåæ—¥å¿—å·®è·å·¨å¤§ã€‚**

**åæ—¥å¿—**ï¼š
```python
print("å¼€å§‹æ‰§è¡Œ")
print("ç»“æœï¼šxxx")
print("é”™è¯¯")
```
- æ²¡æœ‰æ—¶é—´æˆ³
- æ²¡æœ‰çº§åˆ«
- æ²¡æœ‰ä¸Šä¸‹æ–‡
- æ··ä¹±æ— åº

**å¥½æ—¥å¿—**ï¼š
```python
[2024-11-20 10:30:15] [INFO] [user:123] [request:abc-123] Chain execution started
[2024-11-20 10:30:17] [ERROR] [user:123] [request:abc-123] LLM call failed: timeout after 30s
```
- ç»“æ„åŒ–
- æœ‰æ—¶é—´æˆ³
- æœ‰çº§åˆ«
- æœ‰ä¸Šä¸‹æ–‡
- å¯æœç´¢

å·®è·å°±æ˜¯ä¸“ä¸šå’Œä¸šä½™çš„åˆ†æ°´å²­ï¼

**ç¬¬ä¸‰ï¼Œç”Ÿäº§çº§æ—¥å¿—ç³»ç»Ÿæœ‰å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚**

ä¸æ˜¯åªä¼šå†™æ—¥å¿—å°±è¡Œï¼Œè¿˜è¦ï¼š
- **æ”¶é›†**ï¼šä»å¤šä¸ªæœåŠ¡æ”¶é›†
- **å­˜å‚¨**ï¼šé«˜æ•ˆå­˜å‚¨ï¼Œä¸å ç”¨å¤ªå¤šç©ºé—´
- **æŸ¥è¯¢**ï¼šå¿«é€Ÿæœç´¢å’Œè¿‡æ»¤
- **åˆ†æ**ï¼šç»Ÿè®¡å’Œå¯è§†åŒ–
- **å½’æ¡£**ï¼šé•¿æœŸä¿å­˜
- **æ¸…ç†**ï¼šè‡ªåŠ¨åˆ é™¤è¿‡æœŸæ—¥å¿—

è¿™æ‰æ˜¯ä¼ä¸šçº§ç³»ç»Ÿï¼

**ç¬¬å››ï¼Œè¿™æ˜¯é«˜çº§å¼€å‘è€…çš„å¿…å¤‡æŠ€èƒ½ã€‚**

- **åˆçº§å¼€å‘è€…**ï¼šåªä¼šprintè°ƒè¯•
- **ä¸­çº§å¼€å‘è€…**ï¼šä¼šç”¨loggingæ¨¡å—
- **é«˜çº§å¼€å‘è€…**ï¼šæ„å»ºå®Œæ•´çš„æ—¥å¿—ç³»ç»Ÿ

æŒæ¡ç”Ÿäº§çº§æ—¥å¿—ç®¡ç†ï¼Œä½ å°±èƒ½èƒœä»»ä¼ä¸šçœŸå®é¡¹ç›®ï¼

---

### è¡ŒåŠ¨å·å¬

ä»Šå¤©è¿™ä¸€è¯¾ä¼šæ•™ä½ ï¼š
- ç»“æ„åŒ–æ—¥å¿—è®¾è®¡
- Python loggingæœ€ä½³å®è·µ
- æ—¥å¿—çº§åˆ«å’Œæ ¼å¼
- æ—¥å¿—è½®è½¬å’Œå½’æ¡£
- æ—¥å¿—æœç´¢å’Œåˆ†æ
- é›†æˆç›‘æ§ç³»ç»Ÿ

**å­¦å®Œè¿™è¯¾ï¼Œä½ çš„ç³»ç»Ÿæ—¥å¿—ä¸“ä¸šåˆå¯é ï¼**

---

## ğŸ“– çŸ¥è¯†è®²è§£

### 1. æ—¥å¿—åŸºç¡€

#
![Debugging](./images/debugging.svg)
*å›¾ï¼šDebugging*

### 1.1 ä¸ºä»€ä¹ˆéœ€è¦æ—¥å¿—

```
ç”Ÿäº§ç¯å¢ƒçš„å…³é”®éœ€æ±‚ï¼š

1. é—®é¢˜æ’æŸ¥ï¼š
   - å‡ºé”™æ—¶å¿«é€Ÿå®šä½
   - è¿˜åŸç°åœº
   - è¿½è¸ªç”¨æˆ·è¡Œä¸º

2. æ€§èƒ½ç›‘æ§ï¼š
   - å“åº”æ—¶é—´
   - èµ„æºä½¿ç”¨
   - ç“¶é¢ˆåˆ†æ

3. å®‰å…¨å®¡è®¡ï¼š
   - è®¿é—®è®°å½•
   - æ“ä½œæ—¥å¿—
   - å¼‚å¸¸è¡Œä¸º

4. ä¸šåŠ¡åˆ†æï¼š
   - ç”¨æˆ·è¡Œä¸º
   - åŠŸèƒ½ä½¿ç”¨ç‡
   - è½¬åŒ–æ¼æ–—
```

#### 1.2 æ—¥å¿—çº§åˆ«

```python
import logging

# Pythonæ ‡å‡†æ—¥å¿—çº§åˆ«ï¼ˆä»ä½åˆ°é«˜ï¼‰
logging.DEBUG     # 10 - è¯¦ç»†è°ƒè¯•ä¿¡æ¯
logging.INFO      # 20 - ä¸€èˆ¬ä¿¡æ¯
logging.WARNING   # 30 - è­¦å‘Šä¿¡æ¯
logging.ERROR     # 40 - é”™è¯¯ä¿¡æ¯
logging.CRITICAL  # 50 - ä¸¥é‡é”™è¯¯

# ä½¿ç”¨å»ºè®®ï¼š
# DEBUGï¼šå¼€å‘ç¯å¢ƒè¯¦ç»†è°ƒè¯•
# INFOï¼šæ­£å¸¸ä¸šåŠ¡æµç¨‹ï¼ˆç”¨æˆ·ç™»å½•ã€è®¢å•åˆ›å»ºç­‰ï¼‰
# WARNINGï¼šéœ€è¦æ³¨æ„ä½†ä¸å½±å“è¿è¡Œï¼ˆé‡è¯•ã€é™çº§ç­‰ï¼‰
# ERRORï¼šé”™è¯¯ä½†ç³»ç»Ÿç»§ç»­è¿è¡Œ
# CRITICALï¼šä¸¥é‡é”™è¯¯ï¼Œç³»ç»Ÿå¯èƒ½å´©æºƒ
```

---

### 2. Python loggingé…ç½®

#### 2.1 åŸºç¡€é…ç½®

```python
import logging

# åŸºç¡€é…ç½®
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)

# ä½¿ç”¨
logger = logging.getLogger(__name__)

logger.debug("è°ƒè¯•ä¿¡æ¯")
logger.info("æ­£å¸¸ä¿¡æ¯")
logger.warning("è­¦å‘Šä¿¡æ¯")
logger.error("é”™è¯¯ä¿¡æ¯")
logger.critical("ä¸¥é‡é”™è¯¯")

# è¾“å‡ºï¼š
# 2024-11-20 10:30:15 - __main__ - INFO - æ­£å¸¸ä¿¡æ¯
```

---

#### 2.2 é«˜çº§é…ç½®

```python
import logging
import logging.handlers
from pathlib import Path

def setup_logging(log_dir="logs", log_level=logging.INFO):
    """é…ç½®ç”Ÿäº§çº§æ—¥å¿—ç³»ç»Ÿ"""
    
    # åˆ›å»ºæ—¥å¿—ç›®å½•
    Path(log_dir).mkdir(exist_ok=True)
    
    # åˆ›å»ºlogger
    logger = logging.getLogger("langchain_app")
    logger.setLevel(log_level)
    
    # æ¸…é™¤å·²æœ‰çš„handlersï¼ˆé¿å…é‡å¤ï¼‰
    logger.handlers.clear()
    
    # 1. æ§åˆ¶å°Handlerï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    console_handler = logging.StreamHandler()
    console_handler.setLevel(logging.INFO)
    console_format = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    console_handler.setFormatter(console_format)
    
    # 2. æ–‡ä»¶Handlerï¼ˆæ‰€æœ‰æ—¥å¿—ï¼‰
    file_handler = logging.handlers.RotatingFileHandler(
        filename=f"{log_dir}/app.log",
        maxBytes=10*1024*1024,  # 10MB
        backupCount=5,          # ä¿ç•™5ä¸ªå¤‡ä»½
        encoding='utf-8'
    )
    file_handler.setLevel(logging.DEBUG)
    file_format = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - '
        '[%(filename)s:%(lineno)d] - %(message)s'
    )
    file_handler.setFormatter(file_format)
    
    # 3. é”™è¯¯æ—¥å¿—Handlerï¼ˆåªè®°å½•ERRORåŠä»¥ä¸Šï¼‰
    error_handler = logging.handlers.RotatingFileHandler(
        filename=f"{log_dir}/error.log",
        maxBytes=10*1024*1024,
        backupCount=10,
        encoding='utf-8'
    )
    error_handler.setLevel(logging.ERROR)
    error_handler.setFormatter(file_format)
    
    # æ·»åŠ handlers
    logger.addHandler(console_handler)
    logger.addHandler(file_handler)
    logger.addHandler(error_handler)
    
    return logger


# ä½¿ç”¨
logger = setup_logging()
logger.info("ç³»ç»Ÿå¯åŠ¨")
```

---

### 3. ç»“æ„åŒ–æ—¥å¿—

#### 3.1 JSONæ ¼å¼æ—¥å¿—

```python
import logging
import json
from datetime import datetime

class JSONFormatter(logging.Formatter):
    """JSONæ ¼å¼åŒ–å™¨"""
    
    def format(self, record):
        log_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno
        }
        
        # æ·»åŠ é¢å¤–å­—æ®µ
        if hasattr(record, 'user_id'):
            log_data["user_id"] = record.user_id
        
        if hasattr(record, 'request_id'):
            log_data["request_id"] = record.request_id
        
        if record.exc_info:
            log_data["exception"] = self.formatException(record.exc_info)
        
        return json.dumps(log_data, ensure_ascii=False)


# ä½¿ç”¨
logger = logging.getLogger("app")
handler = logging.FileHandler("logs/app.json")
handler.setFormatter(JSONFormatter())
logger.addHandler(handler)

# æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
logger.info("ç”¨æˆ·ç™»å½•", extra={
    "user_id": "user_123",
    "request_id": "req_456"
})

# è¾“å‡ºï¼ˆJSONæ ¼å¼ï¼Œæ˜“äºè§£æï¼‰ï¼š
# {
#   "timestamp": "2024-11-20T02:30:15.123456",
#   "level": "INFO",
#   "logger": "app",
#   "message": "ç”¨æˆ·ç™»å½•",
#   "user_id": "user_123",
#   "request_id": "req_456"
# }
```

---

### 4. LangChainæ—¥å¿—é›†æˆ

#### 4.1 Chainæ‰§è¡Œæ—¥å¿—

```python
import logging
from langchain_openai import ChatOpenAI
from langchain.prompts import ChatPromptTemplate
from langchain.callbacks.base import BaseCallbackHandler

# é…ç½®æ—¥å¿—
logger = logging.getLogger("langchain_app")

class LoggingCallback(BaseCallbackHandler):
    """æ—¥å¿—è®°å½•Callback"""
    
    def __init__(self, logger, request_id=None):
        self.logger = logger
        self.request_id = request_id or "unknown"
    
    def on_chain_start(self, serialized, inputs, **kwargs):
        """Chainå¼€å§‹"""
        self.logger.info(
            "Chain started",
            extra={
                "request_id": self.request_id,
                "chain_type": serialized.get("name", "unknown"),
                "inputs": str(inputs)[:100]
            }
        )
    
    def on_chain_end(self, outputs, **kwargs):
        """Chainå®Œæˆ"""
        self.logger.info(
            "Chain completed",
            extra={
                "request_id": self.request_id,
                "outputs": str(outputs)[:100]
            }
        )
    
    def on_chain_error(self, error, **kwargs):
        """Chainé”™è¯¯"""
        self.logger.error(
            f"Chain error: {error}",
            extra={"request_id": self.request_id},
            exc_info=True
        )
    
    def on_llm_start(self, serialized, prompts, **kwargs):
        """LLMè°ƒç”¨å¼€å§‹"""
        self.logger.debug(
            "LLM call started",
            extra={
                "request_id": self.request_id,
                "model": serialized.get("model_name", "unknown"),
                "prompt_length": len(prompts[0])
            }
        )
    
    def on_llm_end(self, response, **kwargs):
        """LLMè°ƒç”¨å®Œæˆ"""
        self.logger.debug(
            "LLM call completed",
            extra={
                "request_id": self.request_id,
                "tokens": response.llm_output.get("token_usage", {})
            }
        )
    
    def on_llm_error(self, error, **kwargs):
        """LLMé”™è¯¯"""
        self.logger.error(
            f"LLM error: {error}",
            extra={"request_id": self.request_id},
            exc_info=True
        )


# ä½¿ç”¨
import uuid

request_id = str(uuid.uuid4())
logging_callback = LoggingCallback(logger, request_id)

llm = ChatOpenAI()
prompt = ChatPromptTemplate.from_template("è§£é‡Š{topic}")
chain = prompt | llm

result = chain.invoke(
    {"topic": "AI"},
    config={"callbacks": [logging_callback]}
)
```

---

### 5. æ—¥å¿—è½®è½¬å’Œå½’æ¡£

#### 5.1 åŸºäºå¤§å°çš„è½®è½¬

```python
import logging.handlers

# æŒ‰æ–‡ä»¶å¤§å°è½®è½¬
handler = logging.handlers.RotatingFileHandler(
    filename="logs/app.log",
    maxBytes=10*1024*1024,  # 10MB
    backupCount=5,          # ä¿ç•™5ä¸ªå¤‡ä»½
    encoding='utf-8'
)

# ç”Ÿæˆçš„æ–‡ä»¶ï¼š
# app.log         (å½“å‰)
# app.log.1       (æœ€è¿‘å¤‡ä»½)
# app.log.2
# app.log.3
# app.log.4
# app.log.5       (æœ€æ—§å¤‡ä»½)
```

---

#### 5.2 åŸºäºæ—¶é—´çš„è½®è½¬

```python
import logging.handlers

# æŒ‰æ—¶é—´è½®è½¬ï¼ˆæ¯å¤©ä¸€ä¸ªæ–‡ä»¶ï¼‰
handler = logging.handlers.TimedRotatingFileHandler(
    filename="logs/app.log",
    when='midnight',     # æ¯å¤©åˆå¤œè½®è½¬
    interval=1,          # æ¯1å¤©
    backupCount=30,      # ä¿ç•™30å¤©
    encoding='utf-8'
)

# ç”Ÿæˆçš„æ–‡ä»¶ï¼š
# app.log                    (å½“å‰)
# app.log.2024-11-19
# app.log.2024-11-18
# ...
# app.log.2024-10-21         (30å¤©å‰)

# whenå‚æ•°é€‰é¡¹ï¼š
# 'S' - ç§’
# 'M' - åˆ†é’Ÿ
# 'H' - å°æ—¶
# 'D' - å¤©
# 'midnight' - æ¯å¤©åˆå¤œ
# 'W0'-'W6' - æ¯å‘¨ä¸€åˆ°å‘¨æ—¥
```

---

### 6. æ—¥å¿—æœç´¢å’Œåˆ†æ

#### 6.1 grepæœç´¢

```bash
# æœç´¢é”™è¯¯æ—¥å¿—
grep "ERROR" logs/app.log

# æœç´¢ç‰¹å®šç”¨æˆ·
grep "user_123" logs/app.log

# æœç´¢ç‰¹å®šæ—¶é—´èŒƒå›´
grep "2024-11-20 10:" logs/app.log

# ç»„åˆæœç´¢
grep "ERROR" logs/app.log | grep "user_123"

# ç»Ÿè®¡é”™è¯¯æ•°é‡
grep -c "ERROR" logs/app.log
```

---

#### 6.2 Pythonè„šæœ¬åˆ†æ

```python
import json
from collections import Counter
from datetime import datetime

def analyze_json_logs(log_file):
    """åˆ†æJSONæ ¼å¼æ—¥å¿—"""
    
    levels = Counter()
    errors = []
    hourly_requests = Counter()
    
    with open(log_file, 'r', encoding='utf-8') as f:
        for line in f:
            try:
                log = json.loads(line)
                
                # ç»Ÿè®¡çº§åˆ«
                levels[log['level']] += 1
                
                # æ”¶é›†é”™è¯¯
                if log['level'] in ['ERROR', 'CRITICAL']:
                    errors.append(log)
                
                # ç»Ÿè®¡æ¯å°æ—¶è¯·æ±‚
                timestamp = datetime.fromisoformat(log['timestamp'])
                hour = timestamp.strftime('%Y-%m-%d %H:00')
                hourly_requests[hour] += 1
                
            except json.JSONDecodeError:
                continue
    
    # ç”ŸæˆæŠ¥å‘Š
    print("=" * 60)
    print("æ—¥å¿—åˆ†ææŠ¥å‘Š")
    print("=" * 60)
    
    print(f"\næ—¥å¿—çº§åˆ«ç»Ÿè®¡ï¼š")
    for level, count in levels.most_common():
        print(f"  {level}: {count}")
    
    print(f"\né”™è¯¯æ€»æ•°ï¼š{len(errors)}")
    if errors:
        print(f"æœ€è¿‘é”™è¯¯ï¼š")
        for error in errors[-5:]:
            print(f"  {error['timestamp']} - {error['message']}")
    
    print(f"\næ¯å°æ—¶è¯·æ±‚æ•°ï¼ˆTop 5ï¼‰ï¼š")
    for hour, count in hourly_requests.most_common(5):
        print(f"  {hour}: {count}")


# ä½¿ç”¨
analyze_json_logs("logs/app.json")
```

---

## ğŸ’» Demoæ¡ˆä¾‹ï¼šå®Œæ•´æ—¥å¿—ç³»ç»Ÿ

åˆ›å»º`production_logging_demo.py`ï¼š

```python
"""
ç”Ÿäº§çº§æ—¥å¿—ç³»ç»Ÿå®Œæ•´æ¼”ç¤º
ä»é…ç½®åˆ°ä½¿ç”¨ã€åˆ†æ
"""

import logging
import logging.handlers
import json
import uuid
from datetime import datetime
from pathlib import Path
from langchain_openai import ChatOpenAI
from langchain.prompts import ChatPromptTemplate
from langchain.callbacks.base import BaseCallbackHandler


# ============= 1. JSONæ ¼å¼åŒ–å™¨ =============

class JSONFormatter(logging.Formatter):
    """JSONæ ¼å¼æ—¥å¿—"""
    
    def format(self, record):
        log_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno
        }
        
        # æ·»åŠ é¢å¤–å­—æ®µ
        for field in ['user_id', 'request_id', 'session_id']:
            if hasattr(record, field):
                log_data[field] = getattr(record, field)
        
        # å¼‚å¸¸ä¿¡æ¯
        if record.exc_info:
            log_data["exception"] = self.formatException(record.exc_info)
        
        return json.dumps(log_data, ensure_ascii=False)


# ============= 2. æ—¥å¿—ç³»ç»Ÿé…ç½® =============

def setup_production_logging(
    log_dir="logs",
    app_name="langchain_app",
    log_level=logging.INFO
):
    """é…ç½®ç”Ÿäº§çº§æ—¥å¿—ç³»ç»Ÿ"""
    
    # åˆ›å»ºç›®å½•
    Path(log_dir).mkdir(exist_ok=True)
    
    # åˆ›å»ºlogger
    logger = logging.getLogger(app_name)
    logger.setLevel(logging.DEBUG)  # è®¾ç½®æœ€ä½çº§åˆ«
    logger.handlers.clear()
    
    # 1. æ§åˆ¶å°Handlerï¼ˆäººç±»å¯è¯»ï¼‰
    console_handler = logging.StreamHandler()
    console_handler.setLevel(log_level)
    console_format = logging.Formatter(
        '%(asctime)s - [%(levelname)s] - %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S'
    )
    console_handler.setFormatter(console_format)
    
    # 2. JSONæ–‡ä»¶Handlerï¼ˆæœºå™¨å¯è¯»ï¼‰
    json_handler = logging.handlers.TimedRotatingFileHandler(
        filename=f"{log_dir}/{app_name}.json",
        when='midnight',
        interval=1,
        backupCount=30,
        encoding='utf-8'
    )
    json_handler.setLevel(logging.DEBUG)
    json_handler.setFormatter(JSONFormatter())
    
    # 3. é”™è¯¯æ—¥å¿—Handler
    error_handler = logging.handlers.RotatingFileHandler(
        filename=f"{log_dir}/{app_name}_error.log",
        maxBytes=10*1024*1024,
        backupCount=10,
        encoding='utf-8'
    )
    error_handler.setLevel(logging.ERROR)
    error_format = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - '
        '[%(filename)s:%(lineno)d] - %(message)s\n'
        '%(exc_info)s'
    )
    error_handler.setFormatter(error_format)
    
    # æ·»åŠ handlers
    logger.addHandler(console_handler)
    logger.addHandler(json_handler)
    logger.addHandler(error_handler)
    
    logger.info("æ—¥å¿—ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ")
    
    return logger


# ============= 3. LangChainæ—¥å¿—Callback =============

class ProductionLoggingCallback(BaseCallbackHandler):
    """ç”Ÿäº§çº§æ—¥å¿—Callback"""
    
    def __init__(self, logger, request_id=None, user_id=None):
        self.logger = logger
        self.request_id = request_id or str(uuid.uuid4())
        self.user_id = user_id
    
    def _make_extra(self, **kwargs):
        """æ„å»ºextraå­—å…¸"""
        extra = {
            "request_id": self.request_id
        }
        if self.user_id:
            extra["user_id"] = self.user_id
        extra.update(kwargs)
        return extra
    
    def on_chain_start(self, serialized, inputs, **kwargs):
        self.logger.info(
            f"Chainå¼€å§‹: {serialized.get('name', 'unknown')}",
            extra=self._make_extra(
                event="chain_start",
                chain_type=serialized.get("name"),
                inputs_preview=str(inputs)[:200]
            )
        )
    
    def on_chain_end(self, outputs, **kwargs):
        self.logger.info(
            "Chainå®Œæˆ",
            extra=self._make_extra(
                event="chain_end",
                outputs_preview=str(outputs)[:200]
            )
        )
    
    def on_chain_error(self, error, **kwargs):
        self.logger.error(
            f"Chainé”™è¯¯: {error}",
            extra=self._make_extra(event="chain_error"),
            exc_info=True
        )
    
    def on_llm_start(self, serialized, prompts, **kwargs):
        self.logger.debug(
            "LLMè°ƒç”¨å¼€å§‹",
            extra=self._make_extra(
                event="llm_start",
                model=serialized.get("model_name"),
                prompt_length=len(prompts[0])
            )
        )
    
    def on_llm_end(self, response, **kwargs):
        self.logger.debug(
            "LLMè°ƒç”¨å®Œæˆ",
            extra=self._make_extra(
                event="llm_end",
                tokens=response.llm_output.get("token_usage", {})
            )
        )
    
    def on_llm_error(self, error, **kwargs):
        self.logger.error(
            f"LLMé”™è¯¯: {error}",
            extra=self._make_extra(event="llm_error"),
            exc_info=True
        )


# ============= 4. Demoæ¼”ç¤º =============

def demo_basic_logging():
    """æ¼”ç¤º1ï¼šåŸºç¡€æ—¥å¿—"""
    
    print("\n" + "="*60)
    print("æ¼”ç¤º1ï¼šåŸºç¡€æ—¥å¿—ç³»ç»Ÿ")
    print("="*60 + "\n")
    
    logger = setup_production_logging()
    
    # ä¸åŒçº§åˆ«çš„æ—¥å¿—
    logger.debug("è¿™æ˜¯è°ƒè¯•ä¿¡æ¯ï¼ˆæ§åˆ¶å°ä¸æ˜¾ç¤ºï¼‰")
    logger.info("è¿™æ˜¯ä¸€èˆ¬ä¿¡æ¯")
    logger.warning("è¿™æ˜¯è­¦å‘Šä¿¡æ¯")
    logger.error("è¿™æ˜¯é”™è¯¯ä¿¡æ¯")
    
    # å¸¦ä¸Šä¸‹æ–‡çš„æ—¥å¿—
    logger.info(
        "ç”¨æˆ·ç™»å½•",
        extra={
            "user_id": "user_123",
            "session_id": "session_456"
        }
    )
    
    print("\nâœ“ æ—¥å¿—å·²å†™å…¥ logs/ ç›®å½•")
    print("  - langchain_app.json (JSONæ ¼å¼)")
    print("  - langchain_app_error.log (é”™è¯¯æ—¥å¿—)")


def demo_langchain_logging():
    """æ¼”ç¤º2ï¼šLangChainé›†æˆ"""
    
    print("\n" + "="*60)
    print("æ¼”ç¤º2ï¼šLangChainæ—¥å¿—é›†æˆ")
    print("="*60 + "\n")
    
    logger = setup_production_logging()
    
    # åˆ›å»ºCallback
    callback = ProductionLoggingCallback(
        logger=logger,
        request_id=str(uuid.uuid4()),
        user_id="user_789"
    )
    
    # æ‰§è¡ŒChain
    llm = ChatOpenAI()
    prompt = ChatPromptTemplate.from_template("ç”¨ä¸€å¥è¯è§£é‡Š{topic}")
    chain = prompt | llm
    
    logger.info("å¼€å§‹å¤„ç†ç”¨æˆ·è¯·æ±‚", extra={"user_id": "user_789"})
    
    result = chain.invoke(
        {"topic": "åŒºå—é“¾"},
        config={"callbacks": [callback]}
    )
    
    logger.info("è¯·æ±‚å¤„ç†å®Œæˆ", extra={"user_id": "user_789"})
    
    print(f"\nç»“æœï¼š{result.content[:100]}...")
    print("\nâœ“ å®Œæ•´æ‰§è¡Œæµç¨‹å·²è®°å½•åˆ°æ—¥å¿—")


def demo_error_logging():
    """æ¼”ç¤º3ï¼šé”™è¯¯æ—¥å¿—"""
    
    print("\n" + "="*60)
    print("æ¼”ç¤º3ï¼šé”™è¯¯æ—¥å¿—è®°å½•")
    print("="*60 + "\n")
    
    logger = setup_production_logging()
    
    # æ¨¡æ‹Ÿé”™è¯¯
    try:
        # æ•…æ„åˆ¶é€ é”™è¯¯
        result = 1 / 0
    except Exception as e:
        logger.error(
            "é™¤é›¶é”™è¯¯",
            extra={"user_id": "user_error"},
            exc_info=True  # è®°å½•å®Œæ•´å †æ ˆ
        )
    
    print("\nâœ“ é”™è¯¯ä¿¡æ¯å·²è®°å½•åˆ° langchain_app_error.log")


def analyze_logs():
    """æ¼”ç¤º4ï¼šæ—¥å¿—åˆ†æ"""
    
    print("\n" + "="*60)
    print("æ¼”ç¤º4ï¼šæ—¥å¿—åˆ†æ")
    print("="*60 + "\n")
    
    log_file = "logs/langchain_app.json"
    
    if not Path(log_file).exists():
        print("âŒ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨")
        return
    
    levels = {}
    events = {}
    
    with open(log_file, 'r', encoding='utf-8') as f:
        for line in f:
            try:
                log = json.loads(line)
                
                # ç»Ÿè®¡çº§åˆ«
                level = log.get('level', 'UNKNOWN')
                levels[level] = levels.get(level, 0) + 1
                
                # ç»Ÿè®¡äº‹ä»¶
                event = log.get('event', 'general')
                events[event] = events.get(event, 0) + 1
                
            except json.JSONDecodeError:
                continue
    
    print("æ—¥å¿—ç»Ÿè®¡ï¼š")
    print(f"\næŒ‰çº§åˆ«ï¼š")
    for level, count in sorted(levels.items()):
        print(f"  {level}: {count}")
    
    print(f"\næŒ‰äº‹ä»¶ï¼š")
    for event, count in sorted(events.items(), key=lambda x: x[1], reverse=True):
        print(f"  {event}: {count}")


def main():
    """ä¸»å‡½æ•°"""
    
    print("\n" + "="*60)
    print("ğŸ¯ ç”Ÿäº§çº§æ—¥å¿—ç³»ç»Ÿå®Œæ•´æ¼”ç¤º")
    print("="*60)
    
    demo_basic_logging()
    demo_langchain_logging()
    demo_error_logging()
    analyze_logs()
    
    print("\n" + "="*60)
    print("âœ… æ‰€æœ‰æ¼”ç¤ºå®Œæˆï¼")
    print("="*60)
    print("\nğŸ’¡ ç”Ÿäº§çº§æ—¥å¿—ç³»ç»Ÿç‰¹ç‚¹ï¼š")
    print("  1. ç»“æ„åŒ–ï¼ˆJSONæ ¼å¼ï¼‰")
    print("  2. å¤šçº§åˆ«ï¼ˆDEBUGåˆ°CRITICALï¼‰")
    print("  3. å¤šè¾“å‡ºï¼ˆæ§åˆ¶å°+æ–‡ä»¶ï¼‰")
    print("  4. è‡ªåŠ¨è½®è½¬ï¼ˆæŒ‰æ—¶é—´/å¤§å°ï¼‰")
    print("  5. ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆrequest_idã€user_idï¼‰")
    print("  6. æ˜“äºåˆ†æï¼ˆå¯è§£æã€å¯æœç´¢ï¼‰")
    print("="*60 + "\n")


if __name__ == "__main__":
    main()
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### æ—¥å¿—å†…å®¹åŸåˆ™

```
âœ… åº”è¯¥è®°å½•ï¼š
- å…³é”®ä¸šåŠ¡æ“ä½œï¼ˆç™»å½•ã€ä¸‹å•ã€æ”¯ä»˜ï¼‰
- APIè°ƒç”¨ï¼ˆè¾“å…¥ã€è¾“å‡ºã€è€—æ—¶ï¼‰
- é”™è¯¯å’Œå¼‚å¸¸ï¼ˆå®Œæ•´å †æ ˆï¼‰
- æ€§èƒ½æŒ‡æ ‡ï¼ˆå“åº”æ—¶é—´ã€èµ„æºä½¿ç”¨ï¼‰
- å®‰å…¨äº‹ä»¶ï¼ˆè®¿é—®å¤±è´¥ã€å¼‚å¸¸è¡Œä¸ºï¼‰

âŒ ä¸åº”è¯¥è®°å½•ï¼š
- æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€å¯†é’¥ã€tokenï¼‰
- ä¸ªäººéšç§ï¼ˆèº«ä»½è¯å·ã€æ‰‹æœºå·å®Œæ•´ä¿¡æ¯ï¼‰
- å¤§é‡æ•°æ®ï¼ˆå®Œæ•´æ–‡æ¡£å†…å®¹ï¼‰
- è¿‡äºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
```

### æ—¥å¿—æ ¼å¼å»ºè®®

```python
# âœ… å¥½çš„æ—¥å¿—
logger.info(
    "ç”¨æˆ·ä¸‹å•æˆåŠŸ",
    extra={
        "user_id": "user_123",
        "order_id": "order_456",
        "amount": 99.99,
        "payment_method": "credit_card"
    }
)

# âŒ ä¸å¥½çš„æ—¥å¿—
logger.info(f"ç”¨æˆ·{user_id}ä¸‹å•{order_id}é‡‘é¢{amount}")
```

---

## âœ… è¯¾åæ£€éªŒ

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] é…ç½®å¤šçº§åˆ«æ—¥å¿—ç³»ç»Ÿ
- [ ] å®ç°æ—¥å¿—è½®è½¬å’Œå½’æ¡£
- [ ] é›†æˆLangChainæ—¥å¿—
- [ ] è®¾è®¡ç»“æ„åŒ–æ—¥å¿—
- [ ] åˆ†æå’Œæœç´¢æ—¥å¿—

---

## ğŸ“ ä¸‹ä¸€è¯¾é¢„å‘Š

**ç¬¬39è¯¾ï¼šæ€§èƒ½åˆ†ææ·±å…¥**

ä¸‹ä¸€è¯¾æˆ‘ä»¬å°†å­¦ä¹ ï¼š
- ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
- æ€§èƒ½åˆ†æå·¥å…·
- ç“¶é¢ˆå®šä½æ–¹æ³•
- æ€§èƒ½æµ‹è¯•
- ä¼˜åŒ–éªŒè¯

**è®©ç³»ç»Ÿæ€§èƒ½æå‡10å€ï¼**

---

**ğŸ‰ æ­å–œä½ å®Œæˆç¬¬38è¯¾ï¼**

ä½ çš„ç³»ç»Ÿç°åœ¨æœ‰äº†ä¸“ä¸šçš„æ—¥å¿—ç³»ç»Ÿï¼

**è¿›åº¦ï¼š38/165è¯¾ï¼ˆ23.0%å®Œæˆï¼‰** ğŸš€
