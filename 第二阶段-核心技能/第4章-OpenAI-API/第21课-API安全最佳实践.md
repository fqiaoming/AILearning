![å®‰å…¨å®è·µ](./images/security.svg)
*å›¾ï¼šAPIå®‰å…¨çš„å¤šå±‚é˜²æŠ¤æ¶æ„*

# ç¬¬21è¯¾ï¼šAPIå®‰å…¨æœ€ä½³å®è·µ - ä¿æŠ¤ä½ çš„AIåº”ç”¨

> ğŸ“š **è¯¾ç¨‹ä¿¡æ¯**
> - æ‰€å±æ¨¡å—ï¼šç¬¬äºŒæ¨¡å— - APIä¸LangChainå¼€å‘  
> - ç« èŠ‚ï¼šç¬¬4ç«  - APIè°ƒç”¨åŸºç¡€ï¼ˆç¬¬6/7è¯¾ï¼‰
> - å­¦ä¹ ç›®æ ‡ï¼šæŒæ¡APIå®‰å…¨ç­–ç•¥ï¼Œä¿æŠ¤å¯†é’¥å’Œé˜²æ­¢æ»¥ç”¨
> - é¢„è®¡æ—¶é—´ï¼š60-70åˆ†é’Ÿ
> - å‰ç½®çŸ¥è¯†ï¼šç¬¬16-20è¯¾

---

## ğŸ“¢ è¯¾ç¨‹å¯¼å…¥

### å‰è¨€

ä½ çš„APIå¯†é’¥ä¸å°å¿ƒæäº¤åˆ°GitHubäº†ï¼Œç¬¬äºŒå¤©è´¦å•æ˜¾ç¤ºæœ‰äººç”¨ä½ çš„å¯†é’¥è°ƒç”¨äº†10ä¸‡æ¬¡APIï¼Œæ¬ è´¹$3000ï¼æˆ–è€…æœ‰æ¶æ„ç”¨æˆ·ç–¯ç‹‚è¯·æ±‚ä½ çš„æ¥å£ï¼Œä½ çš„æœåŠ¡å™¨ç›´æ¥è¢«æ‰“å®ï¼

è¿™ä¸æ˜¯å±è¨€è€¸å¬ï¼Œè€Œæ˜¯çœŸå®å‘ç”Ÿè¿‡æ— æ•°æ¬¡çš„äº‹æ•…ï¼APIå®‰å…¨çœ‹ä¼¼ä¸èµ·çœ¼ï¼Œä½†ä¸€æ—¦å‡ºé—®é¢˜ï¼Œåæœéå¸¸ä¸¥é‡ï¼šé‡‘é’±æŸå¤±ã€æ•°æ®æ³„éœ²ã€æœåŠ¡ç˜«ç—ªã€æ³•å¾‹é£é™©ï¼

ä»Šå¤©è¿™è¯¾ï¼Œæˆ‘è¦æ•™ä½ å…¨å¥—APIå®‰å…¨é˜²æŠ¤æ–¹æ¡ˆï¼Œè®©ä½ çš„AIåº”ç”¨å›ºè‹¥é‡‘æ±¤ï¼

---

### æ ¸å¿ƒä»·å€¼ç‚¹

**ç¬¬ä¸€ï¼ŒAPIå¯†é’¥æ³„éœ²æ˜¯æœ€å¸¸è§ä¹Ÿæœ€ä¸¥é‡çš„é—®é¢˜ã€‚**

çœ‹çœ‹è¿™äº›çœŸå®æ¡ˆä¾‹ï¼š
- GitHubä¸Šæ¯å¤©æœ‰æ•°åƒä¸ªAPIå¯†é’¥è¢«æ³„éœ²
- å¼€å‘è€…ä¸å°å¿ƒæŠŠå¯†é’¥å†™åœ¨ä»£ç é‡Œæäº¤
- æœ‰äººä¸“é—¨å†™çˆ¬è™«æœç´¢æ³„éœ²çš„å¯†é’¥
- è¢«ç›—ç”¨çš„å¯†é’¥æ¯å¤©å¯èƒ½è¢«è°ƒç”¨å‡ ä¸‡æ¬¡

å¦‚æœä½ ä¸é‡è§†å¯†é’¥ç®¡ç†ï¼Œè¿Ÿæ—©ä¼šä¸­æ‹›ï¼è€Œå­¦ä¼šæ­£ç¡®ç®¡ç†å¯†é’¥ï¼Œåªéœ€è¦10åˆ†é’Ÿï¼Œä½†èƒ½é¿å…å‡ åƒå‡ ä¸‡çš„æŸå¤±ï¼

**ç¬¬äºŒï¼Œè®¿é—®æ§åˆ¶æ˜¯é˜²æ­¢æ»¥ç”¨çš„å…³é”®ã€‚**

æ²¡æœ‰è®¿é—®æ§åˆ¶çš„APIå°±åƒæ•å¼€å¤§é—¨çš„é“¶è¡Œï¼ä»»ä½•äººéƒ½èƒ½ï¼š
- æ— é™åˆ¶åœ°è¯·æ±‚
- è®¿é—®æ‰€æœ‰åŠŸèƒ½
- æŸ¥çœ‹å…¶ä»–ç”¨æˆ·çš„æ•°æ®

ä½†æœ‰äº†è®¿é—®æ§åˆ¶ï¼š
- æ¯ä¸ªç”¨æˆ·æœ‰ç‹¬ç«‹å¯†é’¥
- è®¾ç½®è¯·æ±‚é¢‘ç‡é™åˆ¶
- åˆ†é…ä¸åŒæƒé™
- è®°å½•æ‰€æœ‰æ“ä½œ

è¿™å°±æ˜¯ä¸“ä¸šç³»ç»Ÿå’Œä¸šä½™ç³»ç»Ÿçš„åŒºåˆ«ï¼

**ç¬¬ä¸‰ï¼Œå®‰å…¨ä¸æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œè€Œæ˜¯æŒç»­çš„ã€‚**

å¾ˆå¤šäººä»¥ä¸ºåšä¸€æ¬¡å®‰å…¨é…ç½®å°±ä¸‡äº‹å¤§å‰ï¼Œé”™ï¼å®‰å…¨æ˜¯æŒç»­çš„è¿‡ç¨‹ï¼š
- å®šæœŸè½®æ¢å¯†é’¥
- å®¡è®¡è®¿é—®æ—¥å¿—
- ç›‘æ§å¼‚å¸¸è¡Œä¸º
- åŠæ—¶æ›´æ–°æ¼æ´

å¤§å‚çš„å®‰å…¨å›¢é˜Ÿæ¯å¤©éƒ½åœ¨åšè¿™äº›äº‹ï¼Œè¿™ä¸æ˜¯è¿‡åº¦ç´§å¼ ï¼Œè€Œæ˜¯å¿…è¦æªæ–½ï¼

**ç¬¬å››ï¼Œè¿™æ˜¯ä¼ä¸šçº§åº”ç”¨çš„å¿…å¤‡èƒ½åŠ›ã€‚**

é¢è¯•å®˜ç»å¸¸é—®ï¼š
- "å¦‚ä½•ä¿æŠ¤APIå¯†é’¥ï¼Ÿ"
- "å¦‚ä½•é˜²æ­¢APIè¢«æ»¥ç”¨ï¼Ÿ"
- "å¦‚ä½•å®ç°è®¿é—®æ§åˆ¶ï¼Ÿ"

å¦‚æœä½ ç­”ä¸ä¸Šæ¥ï¼Œé¢è¯•å®˜ä¼šè§‰å¾—ä½ ç¼ºä¹ç”Ÿäº§ç»éªŒã€‚ä½†å¦‚æœä½ èƒ½ç³»ç»Ÿåœ°è®²å‡ºæ¥ï¼Œä¼šå¤§å¤§åŠ åˆ†ï¼

---

### è¡ŒåŠ¨å·å¬

ä»Šå¤©è¿™ä¸€è¯¾ä¼šæ•™ä½ ï¼š
- APIå¯†é’¥çš„å®‰å…¨ç®¡ç†ç­–ç•¥
- ç¯å¢ƒå˜é‡å’Œå¯†é’¥ç®¡ç†æœåŠ¡
- è®¿é—®æ§åˆ¶å’Œæƒé™ç³»ç»Ÿ
- é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰
- å®¡è®¡æ—¥å¿—å’Œç›‘æ§å‘Šè­¦
- å®‰å…¨æ£€æŸ¥æ¸…å•

**å­¦å®Œè¿™è¯¾ï¼Œä½ çš„AIåº”ç”¨å®‰å…¨æ€§ä¼šæå‡10å€ï¼**

---

## ğŸ“– çŸ¥è¯†è®²è§£

### 1. APIå¯†é’¥å®‰å…¨

#
![Api Architecture](./images/api_architecture.svg)
*å›¾ï¼šApi Architecture*

### 1.1 å¸¸è§å®‰å…¨é—®é¢˜

```
âŒ å±é™©åšæ³•ï¼š

1. ç¡¬ç¼–ç åœ¨ä»£ç ä¸­
api_key = "sk-xxxxxxxxxxxxx"

2. æäº¤åˆ°Gitä»“åº“
git add .env  # .envåŒ…å«å¯†é’¥

3. å†™åœ¨å‰ç«¯ä»£ç 
const OPENAI_KEY = "sk-xxxxx"  // ç”¨æˆ·å¯è§ï¼

4. æ‰“å°åˆ°æ—¥å¿—
print(f"Using API key: {api_key}")

5. é€šè¿‡URLä¼ é€’
https://api.example.com?api_key=sk-xxxxx

6. å…±äº«ç»™ä»–äºº
"è¿™æ˜¯æˆ‘çš„APIå¯†é’¥ï¼šsk-xxxxx"

7. ä½¿ç”¨é»˜è®¤å¯†é’¥
ä»ä¸æ›´æ¢ï¼Œä¸€ç›´ç”¨åŒä¸€ä¸ª
```

#### 1.2 æ­£ç¡®çš„å¯†é’¥ç®¡ç†

**æ–¹æ³•1ï¼šç¯å¢ƒå˜é‡**
```bash
# .envæ–‡ä»¶
OPENAI_API_KEY=sk-xxxxxxxxxxxxx

# åŠ å…¥.gitignore
echo ".env" >> .gitignore

# Pythonè¯»å–
from dotenv import load_dotenv
import os

load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")
```

**æ–¹æ³•2ï¼šé…ç½®æ–‡ä»¶ï¼ˆåŠ å¯†ï¼‰**
```python
import json
from cryptography.fernet import Fernet

class SecureConfig:
    """åŠ å¯†é…ç½®ç®¡ç†"""
    
    def __init__(self, key_file="secret.key"):
        # ç”Ÿæˆæˆ–åŠ è½½å¯†é’¥
        try:
            with open(key_file, "rb") as f:
                self.key = f.read()
        except FileNotFoundError:
            self.key = Fernet.generate_key()
            with open(key_file, "wb") as f:
                f.write(self.key)
        
        self.cipher = Fernet(self.key)
    
    def encrypt_config(self, config, filename="config.enc"):
        """åŠ å¯†å¹¶ä¿å­˜é…ç½®"""
        encrypted = self.cipher.encrypt(json.dumps(config).encode())
        with open(filename, "wb") as f:
            f.write(encrypted)
    
    def load_config(self, filename="config.enc"):
        """åŠ è½½å¹¶è§£å¯†é…ç½®"""
        with open(filename, "rb") as f:
            encrypted = f.read()
        decrypted = self.cipher.decrypt(encrypted)
        return json.loads(decrypted)

# ä½¿ç”¨
config_manager = SecureConfig()

# é¦–æ¬¡ä¿å­˜
config_manager.encrypt_config({
    "OPENAI_API_KEY": "sk-xxxxx",
    "DEEPSEEK_API_KEY": "sk-yyyyy"
})

# åç»­ä½¿ç”¨
config = config_manager.load_config()
api_key = config["OPENAI_API_KEY"]
```

**æ–¹æ³•3ï¼šå¯†é’¥ç®¡ç†æœåŠ¡**
```python
# AWS Secrets Manager
import boto3

def get_secret(secret_name):
    client = boto3.client('secretsmanager')
    response = client.get_secret_value(SecretId=secret_name)
    return json.loads(response['SecretString'])

# Azure Key Vault
from azure.identity import DefaultAzureCredential
from azure.keyvault.secrets import SecretClient

credential = DefaultAzureCredential()
client = SecretClient(vault_url="https://myvault.vault.azure.net", 
                     credential=credential)
secret = client.get_secret("OpenAI-API-Key")
api_key = secret.value
```

---

### 2. è®¿é—®æ§åˆ¶

#### 2.1 APIå¯†é’¥ç³»ç»Ÿ

```python
import secrets
import hashlib
from datetime import datetime, timedelta

class APIKeyManager:
    """APIå¯†é’¥ç®¡ç†å™¨"""
    
    def __init__(self):
        self.keys = {}  # å®é™…åº”è¯¥ç”¨æ•°æ®åº“
    
    def generate_key(self, user_id, name="", expires_in_days=365):
        """ç”ŸæˆAPIå¯†é’¥"""
        # ç”Ÿæˆéšæœºå¯†é’¥
        key = f"sk-{secrets.token_urlsafe(32)}"
        
        # å­˜å‚¨å¯†é’¥ä¿¡æ¯ï¼ˆåº”è¯¥å­˜å‚¨hashï¼Œä¸æ˜¯æ˜æ–‡ï¼‰
        key_hash = hashlib.sha256(key.encode()).hexdigest()
        
        self.keys[key_hash] = {
            "user_id": user_id,
            "name": name,
            "created_at": datetime.now(),
            "expires_at": datetime.now() + timedelta(days=expires_in_days),
            "is_active": True,
            "usage_count": 0,
            "last_used": None
        }
        
        return key  # åªè¿”å›ä¸€æ¬¡ï¼
    
    def validate_key(self, key):
        """éªŒè¯å¯†é’¥"""
        key_hash = hashlib.sha256(key.encode()).hexdigest()
        
        if key_hash not in self.keys:
            return {"valid": False, "error": "å¯†é’¥ä¸å­˜åœ¨"}
        
        key_info = self.keys[key_hash]
        
        # æ£€æŸ¥æ˜¯å¦æ¿€æ´»
        if not key_info["is_active"]:
            return {"valid": False, "error": "å¯†é’¥å·²ç¦ç”¨"}
        
        # æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
        if datetime.now() > key_info["expires_at"]:
            return {"valid": False, "error": "å¯†é’¥å·²è¿‡æœŸ"}
        
        # æ›´æ–°ä½¿ç”¨ä¿¡æ¯
        key_info["usage_count"] += 1
        key_info["last_used"] = datetime.now()
        
        return {
            "valid": True,
            "user_id": key_info["user_id"],
            "usage_count": key_info["usage_count"]
        }
    
    def revoke_key(self, key):
        """æ’¤é”€å¯†é’¥"""
        key_hash = hashlib.sha256(key.encode()).hexdigest()
        if key_hash in self.keys:
            self.keys[key_hash]["is_active"] = False
            return True
        return False
    
    def rotate_key(self, old_key, user_id):
        """è½®æ¢å¯†é’¥"""
        # æ’¤é”€æ—§å¯†é’¥
        self.revoke_key(old_key)
        
        # ç”Ÿæˆæ–°å¯†é’¥
        new_key = self.generate_key(user_id, name="Rotated Key")
        return new_key


# ä½¿ç”¨ç¤ºä¾‹
key_manager = APIKeyManager()

# ç”Ÿæˆå¯†é’¥
new_key = key_manager.generate_key(user_id="user_001", name="Production Key")
print(f"æ–°å¯†é’¥ï¼š{new_key}")

# éªŒè¯å¯†é’¥
result = key_manager.validate_key(new_key)
print(f"éªŒè¯ç»“æœï¼š{result}")

# æ’¤é”€å¯†é’¥
key_manager.revoke_key(new_key)
```

---

### 3. é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰

#### 3.1 å›ºå®šçª—å£

```python
from collections import defaultdict
from datetime import datetime, timedelta

class RateLimiter:
    """é€Ÿç‡é™åˆ¶å™¨ï¼ˆå›ºå®šçª—å£ï¼‰"""
    
    def __init__(self, max_requests=10, window_seconds=60):
        self.max_requests = max_requests
        self.window = timedelta(seconds=window_seconds)
        self.requests = defaultdict(list)
    
    def is_allowed(self, user_id):
        """æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚"""
        now = datetime.now()
        
        # æ¸…ç†è¿‡æœŸè®°å½•
        cutoff = now - self.window
        self.requests[user_id] = [
            req_time for req_time in self.requests[user_id]
            if req_time > cutoff
        ]
        
        # æ£€æŸ¥æ˜¯å¦è¶…é™
        if len(self.requests[user_id]) >= self.max_requests:
            return False
        
        # è®°å½•æœ¬æ¬¡è¯·æ±‚
        self.requests[user_id].append(now)
        return True
    
    def get_remaining(self, user_id):
        """è·å–å‰©ä½™é…é¢"""
        now = datetime.now()
        cutoff = now - self.window
        
        recent_requests = [
            req_time for req_time in self.requests[user_id]
            if req_time > cutoff
        ]
        
        return self.max_requests - len(recent_requests)


# ä½¿ç”¨ç¤ºä¾‹
limiter = RateLimiter(max_requests=5, window_seconds=60)

def api_endpoint(user_id, request):
    """APIç«¯ç‚¹ï¼ˆå¸¦é€Ÿç‡é™åˆ¶ï¼‰"""
    if not limiter.is_allowed(user_id):
        remaining = limiter.get_remaining(user_id)
        return {
            "error": "Rate limit exceeded",
            "remaining": remaining,
            "reset_in": 60
        }
    
    # å¤„ç†è¯·æ±‚
    return {"success": True, "data": "..."}
```

#### 3.2 ä»¤ç‰Œæ¡¶ç®—æ³•

```python
import time

class TokenBucket:
    """ä»¤ç‰Œæ¡¶ç®—æ³•"""
    
    def __init__(self, capacity=10, refill_rate=1):
        """
        capacity: æ¡¶å®¹é‡
        refill_rate: æ¯ç§’è¡¥å……çš„ä»¤ç‰Œæ•°
        """
        self.capacity = capacity
        self.refill_rate = refill_rate
        self.tokens = capacity
        self.last_refill = time.time()
    
    def _refill(self):
        """è¡¥å……ä»¤ç‰Œ"""
        now = time.time()
        elapsed = now - self.last_refill
        
        # è®¡ç®—åº”è¡¥å……çš„ä»¤ç‰Œæ•°
        tokens_to_add = elapsed * self.refill_rate
        self.tokens = min(self.capacity, self.tokens + tokens_to_add)
        self.last_refill = now
    
    def consume(self, tokens=1):
        """æ¶ˆè´¹ä»¤ç‰Œ"""
        self._refill()
        
        if self.tokens >= tokens:
            self.tokens -= tokens
            return True
        return False
    
    def get_available_tokens(self):
        """è·å–å¯ç”¨ä»¤ç‰Œæ•°"""
        self._refill()
        return int(self.tokens)


# ä½¿ç”¨ç¤ºä¾‹
bucket = TokenBucket(capacity=10, refill_rate=2)  # æ¯ç§’è¡¥å……2ä¸ªä»¤ç‰Œ

def protected_api():
    if not bucket.consume(1):
        return {"error": "Rate limit exceeded", 
                "available_tokens": bucket.get_available_tokens()}
    
    # æ‰§è¡ŒAPIé€»è¾‘
    return {"success": True}
```

---

### 4. å®¡è®¡æ—¥å¿—

```python
import logging
from datetime import datetime
import json

class APIAuditLogger:
    """APIå®¡è®¡æ—¥å¿—"""
    
    def __init__(self, log_file="api_audit.log"):
        self.logger = logging.getLogger("API_AUDIT")
        self.logger.setLevel(logging.INFO)
        
        # æ–‡ä»¶å¤„ç†å™¨
        handler = logging.FileHandler(log_file)
        formatter = logging.Formatter(
            '%(asctime)s - %(levelname)s - %(message)s'
        )
        handler.setFormatter(formatter)
        self.logger.addHandler(handler)
    
    def log_request(self, user_id, endpoint, method, params=None, 
                   response_status=None, response_time=None):
        """è®°å½•APIè¯·æ±‚"""
        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "user_id": user_id,
            "endpoint": endpoint,
            "method": method,
            "params": params,
            "response_status": response_status,
            "response_time": response_time
        }
        
        self.logger.info(json.dumps(log_entry))
    
    def log_authentication(self, user_id, success, ip_address=None):
        """è®°å½•è®¤è¯å°è¯•"""
        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "event": "authentication",
            "user_id": user_id,
            "success": success,
            "ip_address": ip_address
        }
        
        self.logger.warning(json.dumps(log_entry))
    
    def log_security_event(self, event_type, user_id, details):
        """è®°å½•å®‰å…¨äº‹ä»¶"""
        log_entry = {
            "timestamp": datetime.now().isoformat(),
            "event": "security",
            "type": event_type,
            "user_id": user_id,
            "details": details
        }
        
        self.logger.error(json.dumps(log_entry))


# ä½¿ç”¨ç¤ºä¾‹
audit_logger = APIAuditLogger()

def secure_api_endpoint(api_key, request_data):
    """å®‰å…¨çš„APIç«¯ç‚¹"""
    start_time = time.time()
    
    # éªŒè¯APIå¯†é’¥
    key_validation = key_manager.validate_key(api_key)
    if not key_validation["valid"]:
        audit_logger.log_authentication(
            user_id="unknown",
            success=False,
            ip_address="127.0.0.1"
        )
        return {"error": "Invalid API key"}
    
    user_id = key_validation["user_id"]
    
    # æ£€æŸ¥é€Ÿç‡é™åˆ¶
    if not limiter.is_allowed(user_id):
        audit_logger.log_security_event(
            event_type="rate_limit_exceeded",
            user_id=user_id,
            details={"endpoint": "/api/chat"}
        )
        return {"error": "Rate limit exceeded"}
    
    # å¤„ç†è¯·æ±‚
    response = process_request(request_data)
    
    # è®°å½•å®¡è®¡æ—¥å¿—
    response_time = time.time() - start_time
    audit_logger.log_request(
        user_id=user_id,
        endpoint="/api/chat",
        method="POST",
        params=request_data,
        response_status=200,
        response_time=response_time
    )
    
    return response
```

---

## ğŸ’» Demoæ¡ˆä¾‹ï¼šå®Œæ•´çš„å®‰å…¨APIç³»ç»Ÿ

åˆ›å»º`secure_api_system.py`ï¼š

```python
"""
å®Œæ•´çš„å®‰å…¨APIç³»ç»Ÿ
é›†æˆå¯†é’¥ç®¡ç†ã€è®¿é—®æ§åˆ¶ã€é€Ÿç‡é™åˆ¶ã€å®¡è®¡æ—¥å¿—
"""

import secrets
import hashlib
from datetime import datetime, timedelta
from collections import defaultdict
import time
import logging


class SecureAPISystem:
    """å®‰å…¨çš„APIç³»ç»Ÿ"""
    
    def __init__(self):
        # å¯†é’¥å­˜å‚¨ï¼ˆå®é™…åº”ç”¨ç”¨æ•°æ®åº“ï¼‰
        self.api_keys = {}
        
        # é€Ÿç‡é™åˆ¶å™¨
        self.rate_limits = defaultdict(list)
        self.max_requests_per_minute = 10
        
        # å®¡è®¡æ—¥å¿—
        self.setup_logging()
    
    def setup_logging(self):
        """é…ç½®æ—¥å¿—"""
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            handlers=[
                logging.FileHandler('api_audit.log'),
                logging.StreamHandler()
            ]
        )
        self.logger = logging.getLogger(__name__)
    
    # ===== å¯†é’¥ç®¡ç† =====
    
    def create_api_key(self, user_id, name=""):
        """åˆ›å»ºAPIå¯†é’¥"""
        key = f"sk-{secrets.token_urlsafe(32)}"
        key_hash = hashlib.sha256(key.encode()).hexdigest()
        
        self.api_keys[key_hash] = {
            "user_id": user_id,
            "name": name,
            "created_at": datetime.now(),
            "is_active": True,
            "request_count": 0
        }
        
        self.logger.info(f"[å¯†é’¥åˆ›å»º] User: {user_id}, Name: {name}")
        
        return key
    
    def validate_api_key(self, key):
        """éªŒè¯APIå¯†é’¥"""
        key_hash = hashlib.sha256(key.encode()).hexdigest()
        
        if key_hash not in self.api_keys:
            self.logger.warning(f"[è®¤è¯å¤±è´¥] æ— æ•ˆçš„å¯†é’¥")
            return None
        
        key_info = self.api_keys[key_hash]
        
        if not key_info["is_active"]:
            self.logger.warning(f"[è®¤è¯å¤±è´¥] å¯†é’¥å·²ç¦ç”¨: {key_info['user_id']}")
            return None
        
        return key_info
    
    # ===== é€Ÿç‡é™åˆ¶ =====
    
    def check_rate_limit(self, user_id):
        """æ£€æŸ¥é€Ÿç‡é™åˆ¶"""
        now = datetime.now()
        minute_ago = now - timedelta(minutes=1)
        
        # æ¸…ç†è¿‡æœŸè®°å½•
        self.rate_limits[user_id] = [
            req_time for req_time in self.rate_limits[user_id]
            if req_time > minute_ago
        ]
        
        # æ£€æŸ¥æ˜¯å¦è¶…é™
        if len(self.rate_limits[user_id]) >= self.max_requests_per_minute:
            self.logger.warning(f"[é€Ÿç‡é™åˆ¶] User: {user_id}, è¶…è¿‡é™åˆ¶")
            return False
        
        # è®°å½•è¯·æ±‚
        self.rate_limits[user_id].append(now)
        return True
    
    # ===== APIç«¯ç‚¹ =====
    
    def chat_endpoint(self, api_key, message):
        """èŠå¤©APIç«¯ç‚¹"""
        start_time = time.time()
        
        # 1. éªŒè¯å¯†é’¥
        key_info = self.validate_api_key(api_key)
        if not key_info:
            return {
                "success": False,
                "error": "æ— æ•ˆçš„APIå¯†é’¥"
            }
        
        user_id = key_info["user_id"]
        
        # 2. æ£€æŸ¥é€Ÿç‡é™åˆ¶
        if not self.check_rate_limit(user_id):
            return {
                "success": False,
                "error": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•"
            }
        
        # 3. å¤„ç†è¯·æ±‚ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
        response = f"æ”¶åˆ°æ¶ˆæ¯ï¼š{message}"
        
        # 4. æ›´æ–°ç»Ÿè®¡
        key_info["request_count"] += 1
        
        # 5. è®°å½•å®¡è®¡æ—¥å¿—
        elapsed = time.time() - start_time
        self.logger.info(
            f"[APIè¯·æ±‚] User: {user_id}, "
            f"Message: {message[:50]}..., "
            f"Time: {elapsed:.3f}s"
        )
        
        return {
            "success": True,
            "response": response,
            "user_id": user_id,
            "remaining_requests": self.max_requests_per_minute - 
                                len(self.rate_limits[user_id])
        }
    
    def get_stats(self, api_key):
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        key_info = self.validate_api_key(api_key)
        if not key_info:
            return {"error": "æ— æ•ˆçš„APIå¯†é’¥"}
        
        user_id = key_info["user_id"]
        
        return {
            "user_id": user_id,
            "total_requests": key_info["request_count"],
            "created_at": key_info["created_at"].isoformat(),
            "remaining_this_minute": self.max_requests_per_minute - 
                                    len(self.rate_limits[user_id])
        }


def demo():
    """æ¼”ç¤º"""
    print("ğŸ” å®‰å…¨APIç³»ç»Ÿæ¼”ç¤º\n")
    
    system = SecureAPISystem()
    
    # 1. åˆ›å»ºAPIå¯†é’¥
    print("="*60)
    print("æ­¥éª¤1ï¼šåˆ›å»ºAPIå¯†é’¥")
    print("="*60)
    api_key = system.create_api_key("user_001", "æµ‹è¯•å¯†é’¥")
    print(f"âœ“ APIå¯†é’¥ï¼š{api_key[:20]}...")
    
    # 2. æ­£å¸¸è¯·æ±‚
    print("\n" + "="*60)
    print("æ­¥éª¤2ï¼šæ­£å¸¸è¯·æ±‚")
    print("="*60)
    
    for i in range(3):
        result = system.chat_endpoint(api_key, f"æµ‹è¯•æ¶ˆæ¯ {i+1}")
        print(f"è¯·æ±‚{i+1}ï¼š{result['success']}, "
              f"å‰©ä½™é…é¢ï¼š{result.get('remaining_requests', 0)}")
    
    # 3. æµ‹è¯•é€Ÿç‡é™åˆ¶
    print("\n" + "="*60)
    print("æ­¥éª¤3ï¼šæµ‹è¯•é€Ÿç‡é™åˆ¶ï¼ˆå¿«é€Ÿè¯·æ±‚ï¼‰")
    print("="*60)
    
    success_count = 0
    failed_count = 0
    
    for i in range(15):  # è¶…è¿‡é™åˆ¶
        result = system.chat_endpoint(api_key, f"å¿«é€Ÿè¯·æ±‚ {i+1}")
        if result["success"]:
            success_count += 1
        else:
            failed_count += 1
    
    print(f"âœ“ æˆåŠŸï¼š{success_count}æ¬¡")
    print(f"âœ— é™æµï¼š{failed_count}æ¬¡")
    
    # 4. æŸ¥çœ‹ç»Ÿè®¡
    print("\n" + "="*60)
    print("æ­¥éª¤4ï¼šæŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯")
    print("="*60)
    
    stats = system.get_stats(api_key)
    for key, value in stats.items():
        print(f"  {key}: {value}")
    
    # 5. æµ‹è¯•æ— æ•ˆå¯†é’¥
    print("\n" + "="*60)
    print("æ­¥éª¤5ï¼šæµ‹è¯•æ— æ•ˆå¯†é’¥")
    print("="*60)
    
    result = system.chat_endpoint("invalid_key", "æµ‹è¯•")
    print(f"ç»“æœï¼š{result}")


if __name__ == "__main__":
    demo()
```

---

## ğŸ¯ å®‰å…¨æ£€æŸ¥æ¸…å•

### å¼€å‘é˜¶æ®µ

```
âœ… å¯†é’¥ç®¡ç†
  â–¡ ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥
  â–¡ .envæ–‡ä»¶åŠ å…¥.gitignore
  â–¡ ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
  â–¡ ä¸åœ¨æ—¥å¿—ä¸­æ‰“å°å¯†é’¥

âœ… ä»£ç å®‰å…¨
  â–¡ è¾“å…¥éªŒè¯å’Œæ¸…æ´—
  â–¡ å‚æ•°ç±»å‹æ£€æŸ¥
  â–¡ SQLæ³¨å…¥é˜²æŠ¤
  â–¡ XSSé˜²æŠ¤

âœ… è®¿é—®æ§åˆ¶
  â–¡ å®ç°APIå¯†é’¥ç³»ç»Ÿ
  â–¡ æ¯ä¸ªç”¨æˆ·ç‹¬ç«‹å¯†é’¥
  â–¡ å¯†é’¥å®šæœŸè½®æ¢
```

### ç”Ÿäº§ç¯å¢ƒ

```
âœ… éƒ¨ç½²å®‰å…¨
  â–¡ ä½¿ç”¨HTTPS
  â–¡ é…ç½®CORS
  â–¡ éšè—é”™è¯¯è¯¦æƒ…
  â–¡ è®¾ç½®è¶…æ—¶é™åˆ¶

âœ… ç›‘æ§å‘Šè­¦
  â–¡ å¼‚å¸¸è¯·æ±‚ç›‘æ§
  â–¡ é€Ÿç‡é™åˆ¶å‘Šè­¦
  â–¡ æˆæœ¬å¼‚å¸¸å‘Šè­¦
  â–¡ è®¤è¯å¤±è´¥å‘Šè­¦

âœ… å®¡è®¡åˆè§„
  â–¡ è®°å½•æ‰€æœ‰APIè°ƒç”¨
  â–¡ ä¿ç•™æ—¥å¿—è‡³å°‘90å¤©
  â–¡ å®šæœŸå®‰å…¨å®¡è®¡
  â–¡ åˆè§„æ€§æ£€æŸ¥
```

---

## âœ… è¯¾åæ£€éªŒ

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] å®‰å…¨ç®¡ç†APIå¯†é’¥
- [ ] å®ç°è®¿é—®æ§åˆ¶ç³»ç»Ÿ
- [ ] è®¾è®¡é€Ÿç‡é™åˆ¶ç­–ç•¥
- [ ] è®°å½•å®¡è®¡æ—¥å¿—
- [ ] æ„å»ºå®‰å…¨çš„APIç³»ç»Ÿ

---

## ğŸ“ ä¸‹ä¸€è¯¾é¢„å‘Š

**ç¬¬22è¯¾ï¼šAPIè°ƒç”¨æœ€ä½³å®è·µæ€»ç»“**

å®ŒæˆAPIåŸºç¡€ç« èŠ‚çš„æœ€åä¸€è¯¾ï¼Œæˆ‘ä»¬å°†ï¼š
- æ€»ç»“APIè°ƒç”¨çš„æ‰€æœ‰è¦ç‚¹
- ç”Ÿäº§çº§APIæœåŠ¡æ¶æ„
- æ€§èƒ½ä¼˜åŒ–æŠ€å·§
- å®æˆ˜æ¡ˆä¾‹åˆ†æ

**ç¬¬4ç« çš„å®Œç¾æ”¶å®˜ï¼**

---

**ğŸ‰ æ­å–œä½ å®Œæˆç¬¬21è¯¾ï¼**

ä½ çš„APIåº”ç”¨ç°åœ¨æ—¢å¼ºå¤§åˆå®‰å…¨ï¼

**è¿›åº¦ï¼š21/165è¯¾ï¼ˆ12.7%å®Œæˆï¼‰** ğŸš€

