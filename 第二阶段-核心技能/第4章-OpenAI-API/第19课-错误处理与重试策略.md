![é”™è¯¯å¤„ç†](./images/error_handling.svg)
*å›¾ï¼šå¥å£®çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶*

# ç¬¬19è¯¾ï¼šé”™è¯¯å¤„ç†ä¸é‡è¯•ç­–ç•¥ - æ„å»ºå¥å£®ç³»ç»Ÿ

> ğŸ“š **è¯¾ç¨‹ä¿¡æ¯**
> - æ‰€å±æ¨¡å—ï¼šç¬¬äºŒæ¨¡å— - APIä¸LangChainå¼€å‘  
> - ç« èŠ‚ï¼šç¬¬4ç«  - APIè°ƒç”¨åŸºç¡€ï¼ˆç¬¬4/7è¯¾ï¼‰
> - å­¦ä¹ ç›®æ ‡ï¼šæŒæ¡é”™è¯¯å¤„ç†å’Œæ™ºèƒ½é‡è¯•ï¼Œæ„å»ºç”Ÿäº§çº§å¥å£®ç³»ç»Ÿ
> - é¢„è®¡æ—¶é—´ï¼š70-80åˆ†é’Ÿ
> - å‰ç½®çŸ¥è¯†ï¼šç¬¬16-18è¯¾

---

## ğŸ“¢ è¯¾ç¨‹å¯¼å…¥

### å‰è¨€

ä½ çš„AIåº”ç”¨ä¸Šçº¿äº†ï¼Œçªç„¶OpenAIæœåŠ¡æŠ–äº†ä¸€ä¸‹ï¼Œä½ çš„ç³»ç»Ÿç›´æ¥å´©äº†ï¼Œç”¨æˆ·çœ‹åˆ°ä¸€å †æŠ¥é”™ï¼æˆ–è€…ç½‘ç»œå¶å°”å¡é¡¿ï¼Œè¯·æ±‚å¤±è´¥ï¼Œä½†ä½ æ²¡æœ‰é‡è¯•æœºåˆ¶ï¼Œç”¨æˆ·åªèƒ½æ‰‹åŠ¨åˆ·æ–°ï¼

è¿™äº›é—®é¢˜åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¤ªå¸¸è§äº†ï¼APIä¸å¯èƒ½100%å¯ç”¨ï¼Œç½‘ç»œä¸å¯èƒ½100%ç¨³å®šã€‚ä½†ä¸“ä¸šçš„ç³»ç»Ÿå’Œä¸šä½™çš„ç³»ç»ŸåŒºåˆ«å°±åœ¨äºï¼š**é‡åˆ°é”™è¯¯æ—¶ï¼Œä¸“ä¸šç³»ç»ŸçŸ¥é“æ€ä¹ˆä¼˜é›…åœ°å¤„ç†å’Œæ¢å¤ï¼**

ä»Šå¤©è¿™è¯¾ï¼Œæˆ‘è¦æ•™ä½ æ„å»ºçœŸæ­£å¥å£®çš„AIç³»ç»Ÿï¼Œè®©ä½ çš„åº”ç”¨åœ¨å„ç§å¼‚å¸¸æƒ…å†µä¸‹éƒ½èƒ½ç¨³å®šè¿è¡Œï¼

---

### æ ¸å¿ƒä»·å€¼ç‚¹

**ç¬¬ä¸€ï¼Œé”™è¯¯å¤„ç†ä¸æ˜¯å¯é€‰é¡¹ï¼Œæ˜¯ç”Ÿäº§ç³»ç»Ÿçš„åŸºç¡€ã€‚**

çœ‹çœ‹ä¼šé‡åˆ°ä»€ä¹ˆé”™è¯¯ï¼š
- **ç½‘ç»œé—®é¢˜**ï¼šè¶…æ—¶ã€è¿æ¥å¤±è´¥ã€DNSè§£æå¤±è´¥
- **APIé—®é¢˜**ï¼šæœåŠ¡å™¨é”™è¯¯ã€é™æµã€ç»´æŠ¤
- **å‚æ•°é—®é¢˜**ï¼štokenè¶…é™ã€æ ¼å¼é”™è¯¯
- **è´¦æˆ·é—®é¢˜**ï¼šä½™é¢ä¸è¶³ã€æƒé™ä¸å¤Ÿ

å¦‚æœä¸å¤„ç†è¿™äº›é”™è¯¯ï¼Œä½ çš„ç³»ç»Ÿä¼šï¼š
- é¢‘ç¹å´©æºƒ
- ç”¨æˆ·ä½“éªŒæå·®
- è¿ç»´æˆæœ¬é«˜ï¼ˆæ€»æ˜¯è¦äººå·¥ä»‹å…¥ï¼‰
- éš¾ä»¥å®šä½é—®é¢˜

ä½†å¦‚æœå¤„ç†å¾—å½“ï¼Œç³»ç»Ÿä¼šéå¸¸ç¨³å®šï¼

**ç¬¬äºŒï¼Œæ™ºèƒ½é‡è¯•æ˜¯è§£å†³ä¸´æ—¶æ€§é”™è¯¯çš„é“¶å¼¹ã€‚**

å¾ˆå¤šé”™è¯¯æ˜¯ä¸´æ—¶çš„ï¼š
- ç½‘ç»œæŠ–åŠ¨ï¼š1ç§’åå¯èƒ½å°±å¥½äº†
- æœåŠ¡å™¨ç¹å¿™ï¼šè¿‡ä¼šå„¿é‡è¯•å°±æˆåŠŸ
- é™æµï¼šç­‰å¾…ä¸€æ®µæ—¶é—´å†è¯·æ±‚

æ™ºèƒ½é‡è¯•ç­–ç•¥ï¼ˆå¦‚æŒ‡æ•°é€€é¿ï¼‰èƒ½è‡ªåŠ¨è§£å†³90%çš„ä¸´æ—¶é”™è¯¯ï¼è€Œä¸”å®ç°èµ·æ¥å¹¶ä¸å¤æ‚ï¼ŒæŠ•å…¥äº§å‡ºæ¯”è¶…é«˜ï¼

**ç¬¬ä¸‰ï¼Œç†”æ–­å™¨å’Œé™çº§æ˜¯é«˜å¯ç”¨ç³»ç»Ÿçš„æ ¸å¿ƒã€‚**

æƒ³è±¡ä½ çš„ç³»ç»Ÿè°ƒç”¨OpenAIï¼š
- **æ— ç†”æ–­å™¨**ï¼šAPIä¸€ç›´å¤±è´¥ï¼Œç³»ç»Ÿä¸€ç›´é‡è¯•ï¼Œå®Œå…¨å¡æ­»
- **æœ‰ç†”æ–­å™¨**ï¼šè¿ç»­å¤±è´¥åè‡ªåŠ¨ç†”æ–­ï¼Œåˆ‡æ¢åˆ°é™çº§æ–¹æ¡ˆ

è¿™å°±æ˜¯é¡¶çº§ç³»ç»Ÿå’Œæ™®é€šç³»ç»Ÿçš„åŒºåˆ«ï¼å¤§å‚çš„ç³»ç»Ÿèƒ½åšåˆ°"æ°¸ä¸å®•æœº"ï¼Œé çš„å°±æ˜¯è¿™äº›æœºåˆ¶ï¼

**ç¬¬å››ï¼Œè¿™æ˜¯é¢è¯•å’Œå·¥ä½œä¸­çš„å¿…å¤‡æŠ€èƒ½ã€‚**

é¢è¯•å®˜ç»å¸¸é—®ï¼š
- "å¦‚ä½•å¤„ç†APIè°ƒç”¨å¤±è´¥ï¼Ÿ"
- "ä»€ä¹ˆæ˜¯æŒ‡æ•°é€€é¿ï¼Ÿ"
- "å¦‚ä½•è®¾è®¡é™çº§æ–¹æ¡ˆï¼Ÿ"

å¦‚æœä½ èƒ½ç³»ç»Ÿåœ°è®²å‡ºè¿™äº›ï¼Œé¢è¯•å®˜ä¼šè§‰å¾—ä½ å¾ˆä¸“ä¸šï¼è€Œä¸”è¿™äº›æŠ€èƒ½åœ¨å·¥ä½œä¸­ä¹Ÿå¤©å¤©ç”¨åˆ°ï¼

---

### è¡ŒåŠ¨å·å¬

ä»Šå¤©è¿™ä¸€è¯¾ä¼šæ•™ä½ ï¼š
- OpenAIæ‰€æœ‰é”™è¯¯ç±»å‹å’Œå¤„ç†æ–¹æ³•
- æ™ºèƒ½é‡è¯•ç­–ç•¥ï¼ˆæŒ‡æ•°é€€é¿ã€æŠ–åŠ¨ï¼‰
- ç†”æ–­å™¨æ¨¡å¼çš„å®ç°
- é™çº§æ–¹æ¡ˆè®¾è®¡
- ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

**å­¦å®Œè¿™è¯¾ï¼Œä½ çš„ç³»ç»Ÿå¥å£®æ€§ä¼šæå‡10å€ï¼**

---

## ğŸ“– çŸ¥è¯†è®²è§£

### 1. OpenAIé”™è¯¯ç±»å‹

#
![Api Architecture](./images/api_architecture.svg)
*å›¾ï¼šApi Architecture*

### 1.1 å¸¸è§é”™è¯¯

```python
from openai import (
    APIError,           # APIæœåŠ¡å™¨é”™è¯¯
    APIConnectionError, # ç½‘ç»œè¿æ¥é”™è¯¯
    RateLimitError,    # é€Ÿç‡é™åˆ¶
    APITimeoutError,   # è¶…æ—¶
    AuthenticationError, # è®¤è¯é”™è¯¯
    BadRequestError,   # è¯·æ±‚æ ¼å¼é”™è¯¯
    ConflictError,     # å†²çªé”™è¯¯
    InternalServerError, # å†…éƒ¨æœåŠ¡å™¨é”™è¯¯
    NotFoundError,     # èµ„æºæœªæ‰¾åˆ°
    PermissionDeniedError, # æƒé™ä¸è¶³
    UnprocessableEntityError # æ— æ³•å¤„ç†çš„å®ä½“
)
```

#### 1.2 é”™è¯¯åˆ†ç±»

```
å¯é‡è¯•é”™è¯¯ï¼ˆTransient Errorsï¼‰ï¼š
âœ… APIConnectionError - ç½‘ç»œé—®é¢˜
âœ… APITimeoutError - è¶…æ—¶
âœ… RateLimitError - é™æµï¼ˆç­‰å¾…åé‡è¯•ï¼‰
âœ… InternalServerError - æœåŠ¡å™¨ä¸´æ—¶é”™è¯¯
âœ… APIError (500/502/503/504) - æœåŠ¡å™¨é”™è¯¯

ä¸å¯é‡è¯•é”™è¯¯ï¼ˆPermanent Errorsï¼‰ï¼š
âŒ AuthenticationError - APIå¯†é’¥é”™è¯¯
âŒ PermissionDeniedError - æƒé™ä¸å¤Ÿ
âŒ NotFoundError - æ¨¡å‹ä¸å­˜åœ¨
âŒ BadRequestError - å‚æ•°é”™è¯¯
âŒ UnprocessableEntityError - tokenè¶…é™

å¤„ç†ç­–ç•¥ï¼š
- å¯é‡è¯•ï¼šè‡ªåŠ¨é‡è¯•
- ä¸å¯é‡è¯•ï¼šè®°å½•é”™è¯¯ï¼Œè¿”å›å‹å¥½æç¤º
```

---

### 2. åŸºç¡€é”™è¯¯å¤„ç†

#### 2.1 ç®€å•try-except

```python
from openai import OpenAI, APIError

client = OpenAI()

def safe_chat(message):
    """åŸºç¡€é”™è¯¯å¤„ç†"""
    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": message}]
        )
        return response.choices[0].message.content
    
    except APIError as e:
        print(f"OpenAI APIé”™è¯¯ï¼š{e}")
        return "æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚"
    
    except Exception as e:
        print(f"æœªçŸ¥é”™è¯¯ï¼š{e}")
        return "ç³»ç»Ÿé”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚"
```

#### 2.2 è¯¦ç»†é”™è¯¯å¤„ç†

```python
def detailed_error_handling(message):
    """è¯¦ç»†çš„é”™è¯¯å¤„ç†"""
    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": message}],
            timeout=30
        )
        return {"success": True, "data": response.choices[0].message.content}
    
    except AuthenticationError:
        return {"success": False, "error": "APIå¯†é’¥æ— æ•ˆ"}
    
    except PermissionDeniedError:
        return {"success": False, "error": "æƒé™ä¸è¶³"}
    
    except RateLimitError:
        return {"success": False, "error": "è¯·æ±‚è¿‡å¿«ï¼Œè¯·ç¨åé‡è¯•"}
    
    except APITimeoutError:
        return {"success": False, "error": "è¯·æ±‚è¶…æ—¶"}
    
    except APIConnectionError:
        return {"success": False, "error": "ç½‘ç»œè¿æ¥å¤±è´¥"}
    
    except BadRequestError as e:
        return {"success": False, "error": f"è¯·æ±‚å‚æ•°é”™è¯¯ï¼š{e}"}
    
    except APIError as e:
        return {"success": False, "error": f"APIé”™è¯¯ï¼š{e}"}
    
    except Exception as e:
        return {"success": False, "error": f"æœªçŸ¥é”™è¯¯ï¼š{e}"}
```

---

### 3. æ™ºèƒ½é‡è¯•ç­–ç•¥

#### 3.1 åŸºç¡€é‡è¯•

```python
import time

def retry_on_failure(func, max_retries=3):
    """åŸºç¡€é‡è¯•"""
    for i in range(max_retries):
        try:
            return func()
        except Exception as e:
            if i == max_retries - 1:
                raise
            print(f"ç¬¬{i+1}æ¬¡å°è¯•å¤±è´¥ï¼š{e}ï¼Œæ­£åœ¨é‡è¯•...")
            time.sleep(1)  # å›ºå®šå»¶è¿Ÿ
```

#### 3.2 æŒ‡æ•°é€€é¿ï¼ˆExponential Backoffï¼‰

```python
def exponential_backoff_retry(func, max_retries=5):
    """æŒ‡æ•°é€€é¿é‡è¯•"""
    for i in range(max_retries):
        try:
            return func()
        except Exception as e:
            if i == max_retries - 1:
                raise
            
            # æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s, 8s, 16s
            wait_time = 2 ** i
            print(f"ç¬¬{i+1}æ¬¡å°è¯•å¤±è´¥ï¼Œ{wait_time}ç§’åé‡è¯•...")
            time.sleep(wait_time)
```

**ä¸ºä»€ä¹ˆç”¨æŒ‡æ•°é€€é¿ï¼Ÿ**
```
å›ºå®šå»¶è¿Ÿçš„é—®é¢˜ï¼š
- å»¶è¿Ÿå¤ªçŸ­ï¼šè¿˜æ²¡æ¢å¤å°±é‡è¯•ï¼Œè¿˜æ˜¯å¤±è´¥
- å»¶è¿Ÿå¤ªé•¿ï¼šæ¢å¤äº†è¿˜åœ¨ç­‰ï¼Œæµªè´¹æ—¶é—´

æŒ‡æ•°é€€é¿çš„ä¼˜åŠ¿ï¼š
- å¼€å§‹é—´éš”çŸ­ï¼šå¿«é€Ÿé‡è¯•
- é€æ¸å¢åŠ ï¼šç»™ç³»ç»Ÿæ¢å¤æ—¶é—´
- é¿å…é›ªå´©ï¼šä¸ä¼šæ‰€æœ‰è¯·æ±‚åŒæ—¶é‡è¯•
```

#### 3.3 å¸¦æŠ–åŠ¨çš„æŒ‡æ•°é€€é¿ï¼ˆJittered Backoffï¼‰

```python
import random

def jittered_exponential_backoff(func, max_retries=5):
    """å¸¦æŠ–åŠ¨çš„æŒ‡æ•°é€€é¿"""
    for i in range(max_retries):
        try:
            return func()
        except Exception as e:
            if i == max_retries - 1:
                raise
            
            # åŸºç¡€ç­‰å¾…æ—¶é—´
            base_wait = 2 ** i
            
            # æ·»åŠ éšæœºæŠ–åŠ¨ï¼ˆ0-100%ï¼‰
            jitter = random.uniform(0, base_wait)
            wait_time = base_wait + jitter
            
            print(f"ç¬¬{i+1}æ¬¡å°è¯•å¤±è´¥ï¼Œ{wait_time:.2f}ç§’åé‡è¯•...")
            time.sleep(wait_time)
```

**ä¸ºä»€ä¹ˆéœ€è¦æŠ–åŠ¨ï¼Ÿ**
```
åœºæ™¯ï¼š1000ä¸ªå®¢æˆ·ç«¯åŒæ—¶å¤±è´¥

æ— æŠ–åŠ¨ï¼š
- æ‰€æœ‰å®¢æˆ·ç«¯éƒ½ç­‰å¾…2ç§’
- 2ç§’ååŒæ—¶é‡è¯•
- æœåŠ¡å™¨å†æ¬¡å‹å®
- é™·å…¥å¾ªç¯

æœ‰æŠ–åŠ¨ï¼š
- æ¯ä¸ªå®¢æˆ·ç«¯ç­‰å¾…æ—¶é—´ä¸åŒï¼ˆ2-4ç§’ï¼‰
- é‡è¯•è¯·æ±‚åˆ†æ•£å¼€
- æœåŠ¡å™¨å‹åŠ›å¹³æ»‘
- æ›´å®¹æ˜“æ¢å¤
```

---

#### 3.4 é«˜çº§é‡è¯•è£…é¥°å™¨

```python
from functools import wraps
import time
import random

def retry_with_backoff(
    max_retries=5,
    base_delay=1,
    max_delay=60,
    exponential_base=2,
    jitter=True,
    retryable_exceptions=(APIError, APIConnectionError, APITimeoutError, RateLimitError)
):
    """é«˜çº§é‡è¯•è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for attempt in range(max_retries):
                try:
                    return func(*args, **kwargs)
                
                except retryable_exceptions as e:
                    if attempt == max_retries - 1:
                        raise
                    
                    # è®¡ç®—ç­‰å¾…æ—¶é—´
                    delay = min(base_delay * (exponential_base ** attempt), max_delay)
                    
                    # æ·»åŠ æŠ–åŠ¨
                    if jitter:
                        delay = delay * (0.5 + random.random())
                    
                    print(f"[Retry] ç¬¬{attempt+1}æ¬¡å¤±è´¥ï¼š{type(e).__name__}")
                    print(f"[Retry] {delay:.2f}ç§’åé‡è¯•...")
                    
                    time.sleep(delay)
                
                except Exception as e:
                    # ä¸å¯é‡è¯•çš„é”™è¯¯ç›´æ¥æŠ›å‡º
                    print(f"[Error] ä¸å¯é‡è¯•çš„é”™è¯¯ï¼š{type(e).__name__}: {e}")
                    raise
        
        return wrapper
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@retry_with_backoff(max_retries=3)
def api_call(message):
    response = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": message}]
    )
    return response.choices[0].message.content
```

---

### 4. ç†”æ–­å™¨æ¨¡å¼ï¼ˆCircuit Breakerï¼‰

#### 4.1 ç†”æ–­å™¨åŸç†

```
ç†”æ–­å™¨ä¸‰ç§çŠ¶æ€ï¼š

1. Closedï¼ˆé—­åˆï¼‰ï¼šæ­£å¸¸çŠ¶æ€
   - è¯·æ±‚æ­£å¸¸é€šè¿‡
   - è®°å½•å¤±è´¥æ¬¡æ•°
   - å¤±è´¥æ¬¡æ•°è¾¾åˆ°é˜ˆå€¼ â†’ Open

2. Openï¼ˆå¼€è·¯ï¼‰ï¼šç†”æ–­çŠ¶æ€
   - ç›´æ¥æ‹’ç»è¯·æ±‚ï¼Œä¸è°ƒç”¨API
   - å¿«é€Ÿå¤±è´¥ï¼Œè¿”å›é™çº§å“åº”
   - ç­‰å¾…ä¸€æ®µæ—¶é—´ â†’ Half-Open

3. Half-Openï¼ˆåŠå¼€ï¼‰ï¼šå°è¯•æ¢å¤
   - å…è®¸å°‘é‡è¯·æ±‚é€šè¿‡
   - å¦‚æœæˆåŠŸ â†’ Closed
   - å¦‚æœå¤±è´¥ â†’ Open

æ¯”å–»ï¼š
å°±åƒå®¶é‡Œçš„ç”µè·¯æ–­è·¯å™¨ï¼š
- æ­£å¸¸æ—¶ï¼ˆClosedï¼‰ï¼šç”µæµæ­£å¸¸é€šè¿‡
- çŸ­è·¯æ—¶ï¼ˆOpenï¼‰ï¼šè‡ªåŠ¨æ–­å¼€ï¼Œä¿æŠ¤ç”µè·¯
- ä¿®å¤åï¼ˆHalf-Openï¼‰ï¼šå°è¯•æ¢å¤
```

#### 4.2 ç†”æ–­å™¨å®ç°

```python
from enum import Enum
from datetime import datetime, timedelta
from collections import deque

class CircuitState(Enum):
    CLOSED = "closed"
    OPEN = "open"
    HALF_OPEN = "half_open"


class CircuitBreaker:
    """ç†”æ–­å™¨"""
    
    def __init__(
        self,
        failure_threshold=5,      # å¤±è´¥é˜ˆå€¼
        success_threshold=2,      # æ¢å¤é˜ˆå€¼
        timeout=60,              # ç†”æ–­æ—¶é—´ï¼ˆç§’ï¼‰
        window_size=10           # æ»‘åŠ¨çª—å£å¤§å°
    ):
        self.failure_threshold = failure_threshold
        self.success_threshold = success_threshold
        self.timeout = timeout
        self.window_size = window_size
        
        self.state = CircuitState.CLOSED
        self.failure_count = 0
        self.success_count = 0
        self.last_failure_time = None
        self.recent_results = deque(maxlen=window_size)
    
    def call(self, func, *args, **kwargs):
        """æ‰§è¡Œå‡½æ•°è°ƒç”¨"""
        # æ£€æŸ¥çŠ¶æ€
        if self.state == CircuitState.OPEN:
            if self._should_attempt_reset():
                self.state = CircuitState.HALF_OPEN
                print(f"[CircuitBreaker] çŠ¶æ€å˜æ›´ï¼šOPEN â†’ HALF_OPEN")
            else:
                raise Exception("Circuit is OPEN - ç†”æ–­å™¨å¼€å¯ï¼Œæ‹’ç»è¯·æ±‚")
        
        try:
            result = func(*args, **kwargs)
            self._on_success()
            return result
        
        except Exception as e:
            self._on_failure()
            raise
    
    def _should_attempt_reset(self):
        """æ˜¯å¦åº”è¯¥å°è¯•æ¢å¤"""
        if self.last_failure_time is None:
            return False
        return datetime.now() - self.last_failure_time > timedelta(seconds=self.timeout)
    
    def _on_success(self):
        """æˆåŠŸå›è°ƒ"""
        self.recent_results.append(True)
        
        if self.state == CircuitState.HALF_OPEN:
            self.success_count += 1
            if self.success_count >= self.success_threshold:
                self.state = CircuitState.CLOSED
                self.failure_count = 0
                self.success_count = 0
                print(f"[CircuitBreaker] çŠ¶æ€å˜æ›´ï¼šHALF_OPEN â†’ CLOSEDï¼ˆæ¢å¤æ­£å¸¸ï¼‰")
        
        elif self.state == CircuitState.CLOSED:
            # é‡ç½®å¤±è´¥è®¡æ•°
            recent_failures = sum(1 for r in self.recent_results if not r)
            if recent_failures == 0:
                self.failure_count = 0
    
    def _on_failure(self):
        """å¤±è´¥å›è°ƒ"""
        self.recent_results.append(False)
        self.last_failure_time = datetime.now()
        
        if self.state == CircuitState.HALF_OPEN:
            # åŠå¼€çŠ¶æ€å¤±è´¥ï¼Œé‡æ–°ç†”æ–­
            self.state = CircuitState.OPEN
            self.success_count = 0
            print(f"[CircuitBreaker] çŠ¶æ€å˜æ›´ï¼šHALF_OPEN â†’ OPENï¼ˆæ¢å¤å¤±è´¥ï¼‰")
        
        elif self.state == CircuitState.CLOSED:
            self.failure_count += 1
            if self.failure_count >= self.failure_threshold:
                self.state = CircuitState.OPEN
                print(f"[CircuitBreaker] çŠ¶æ€å˜æ›´ï¼šCLOSED â†’ OPENï¼ˆè§¦å‘ç†”æ–­ï¼‰")
    
    def get_state(self):
        """è·å–å½“å‰çŠ¶æ€"""
        return self.state.value


# ä½¿ç”¨ç¤ºä¾‹
circuit_breaker = CircuitBreaker(failure_threshold=3, timeout=10)

def safe_api_call(message):
    """å¸¦ç†”æ–­å™¨çš„APIè°ƒç”¨"""
    try:
        return circuit_breaker.call(
            lambda: client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[{"role": "user", "content": message}]
            ).choices[0].message.content
        )
    except Exception as e:
        # ç†”æ–­æ—¶è¿”å›é™çº§å“åº”
        return "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"
```

---

### 5. é™çº§æ–¹æ¡ˆ

#### 5.1 å¤šå±‚é™çº§

```python
class AIServiceWithFallback:
    """å¸¦é™çº§çš„AIæœåŠ¡"""
    
    def __init__(self):
        self.primary_client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
        self.fallback_client = OpenAI(
            base_url=os.getenv("LOCAL_LLM_BASE_URL"),
            api_key="lm-studio"
        )
        self.cache = {}  # ç®€å•ç¼“å­˜
    
    def chat(self, message):
        """å¤šå±‚é™çº§çš„èŠå¤©"""
        # ç¬¬1å±‚ï¼šæ£€æŸ¥ç¼“å­˜
        if message in self.cache:
            print("[Fallback] ä½¿ç”¨ç¼“å­˜")
            return self.cache[message]
        
        # ç¬¬2å±‚ï¼šå°è¯•ä¸»æœåŠ¡ï¼ˆGPTï¼‰
        try:
            response = self.primary_client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=[{"role": "user", "content": message}],
                timeout=10
            )
            result = response.choices[0].message.content
            self.cache[message] = result
            return result
        
        except Exception as e:
            print(f"[Fallback] ä¸»æœåŠ¡å¤±è´¥ï¼š{e}")
        
        # ç¬¬3å±‚ï¼šé™çº§åˆ°æœ¬åœ°æ¨¡å‹
        try:
            print("[Fallback] é™çº§åˆ°æœ¬åœ°æ¨¡å‹")
            response = self.fallback_client.chat.completions.create(
                model="qwen2.5-7b-instruct",
                messages=[{"role": "user", "content": message}],
                timeout=10
            )
            return response.choices[0].message.content
        
        except Exception as e:
            print(f"[Fallback] æœ¬åœ°æ¨¡å‹å¤±è´¥ï¼š{e}")
        
        # ç¬¬4å±‚ï¼šè¿”å›é¢„è®¾å›å¤
        print("[Fallback] ä½¿ç”¨é¢„è®¾å›å¤")
        return "æŠ±æ­‰ï¼Œç³»ç»Ÿæš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•ã€‚"
```

---

## ğŸ’» Demoæ¡ˆä¾‹ï¼šå¥å£®çš„AIæœåŠ¡

### æ¡ˆä¾‹è¯´æ˜

ç»¼åˆè¿ç”¨æ‰€æœ‰æŠ€æœ¯ï¼Œæ„å»ºä¸€ä¸ªç”Ÿäº§çº§å¥å£®çš„AIæœåŠ¡ã€‚

### ä»£ç å®ç°

åˆ›å»º`robust_ai_service.py`ï¼š

```python
"""
å¥å£®çš„AIæœåŠ¡
ç»¼åˆé”™è¯¯å¤„ç†ã€é‡è¯•ã€ç†”æ–­å™¨ã€é™çº§
"""

from openai import OpenAI, APIError, RateLimitError, APIConnectionError
import time
import random
from datetime import datetime
from functools import wraps
from enum import Enum


class CircuitState(Enum):
    """ç†”æ–­å™¨çŠ¶æ€"""
    CLOSED = "closed"
    OPEN = "open"
    HALF_OPEN = "half_open"


class CircuitBreaker:
    """ç®€åŒ–çš„ç†”æ–­å™¨"""
    
    def __init__(self, failure_threshold=5, timeout=60):
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.state = CircuitState.CLOSED
        self.failure_count = 0
        self.last_failure_time = None
    
    def call(self, func):
        if self.state == CircuitState.OPEN:
            if self.last_failure_time and \
               (datetime.now() - self.last_failure_time).seconds > self.timeout:
                self.state = CircuitState.HALF_OPEN
                print("[ç†”æ–­å™¨] å°è¯•æ¢å¤...")
            else:
                raise Exception("ç†”æ–­å™¨å¼€å¯")
        
        try:
            result = func()
            if self.state == CircuitState.HALF_OPEN:
                self.state = CircuitState.CLOSED
                self.failure_count = 0
                print("[ç†”æ–­å™¨] æ¢å¤æ­£å¸¸")
            return result
        
        except Exception as e:
            self.failure_count += 1
            self.last_failure_time = datetime.now()
            
            if self.failure_count >= self.failure_threshold:
                self.state = CircuitState.OPEN
                print(f"[ç†”æ–­å™¨] è§¦å‘ç†”æ–­ï¼ˆå¤±è´¥{self.failure_count}æ¬¡ï¼‰")
            raise


def retry_with_backoff(max_retries=3):
    """é‡è¯•è£…é¥°å™¨"""
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            for i in range(max_retries):
                try:
                    return func(*args, **kwargs)
                except (APIError, APIConnectionError, RateLimitError) as e:
                    if i == max_retries - 1:
                        raise
                    
                    wait_time = (2 ** i) * (0.5 + random.random())
                    print(f"[é‡è¯•] ç¬¬{i+1}æ¬¡å¤±è´¥ï¼Œ{wait_time:.2f}ç§’åé‡è¯•")
                    time.sleep(wait_time)
        return wrapper
    return decorator


class RobustAIService:
    """å¥å£®çš„AIæœåŠ¡"""
    
    def __init__(self):
        self.client = OpenAI()
        self.circuit_breaker = CircuitBreaker(failure_threshold=3, timeout=30)
        self.cache = {}
        self.stats = {
            "total_requests": 0,
            "successful_requests": 0,
            "failed_requests": 0,
            "cache_hits": 0,
            "circuit_breaker_trips": 0
        }
    
    @retry_with_backoff(max_retries=3)
    def _api_call(self, message):
        """åº•å±‚APIè°ƒç”¨ï¼ˆå¸¦é‡è¯•ï¼‰"""
        response = self.client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[{"role": "user", "content": message}],
            timeout=30
        )
        return response.choices[0].message.content
    
    def chat(self, message):
        """å¯¹å¤–æ¥å£"""
        self.stats["total_requests"] += 1
        
        # æ£€æŸ¥ç¼“å­˜
        if message in self.cache:
            self.stats["cache_hits"] += 1
            print("[ç¼“å­˜] å‘½ä¸­")
            return {"source": "cache", "content": self.cache[message]}
        
        try:
            # é€šè¿‡ç†”æ–­å™¨è°ƒç”¨
            result = self.circuit_breaker.call(
                lambda: self._api_call(message)
            )
            
            self.stats["successful_requests"] += 1
            self.cache[message] = result
            return {"source": "api", "content": result}
        
        except Exception as e:
            self.stats["failed_requests"] += 1
            
            if "ç†”æ–­å™¨å¼€å¯" in str(e):
                self.stats["circuit_breaker_trips"] += 1
                print("[é™çº§] ç†”æ–­å™¨å¼€å¯ï¼Œä½¿ç”¨é¢„è®¾å›å¤")
                return {
                    "source": "fallback",
                    "content": "ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•"
                }
            
            print(f"[é”™è¯¯] {e}")
            return {
                "source": "error",
                "content": "æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨"
            }
    
    def get_stats(self):
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        success_rate = 0
        if self.stats["total_requests"] > 0:
            success_rate = self.stats["successful_requests"] / self.stats["total_requests"] * 100
        
        return {
            **self.stats,
            "success_rate": f"{success_rate:.2f}%",
            "cache_hit_rate": f"{self.stats['cache_hits'] / max(self.stats['total_requests'], 1) * 100:.2f}%"
        }


def demo():
    """æ¼”ç¤º"""
    print("ğŸš€ å¥å£®AIæœåŠ¡æ¼”ç¤º\n")
    
    service = RobustAIService()
    
    # æµ‹è¯•ç”¨ä¾‹
    test_cases = [
        "ä»€ä¹ˆæ˜¯Pythonï¼Ÿ",
        "ä»€ä¹ˆæ˜¯Pythonï¼Ÿ",  # é‡å¤ï¼Œæµ‹è¯•ç¼“å­˜
        "ä»€ä¹ˆæ˜¯Javaï¼Ÿ",
        "ä»€ä¹ˆæ˜¯Goï¼Ÿ"
    ]
    
    for i, message in enumerate(test_cases, 1):
        print(f"\n{'='*60}")
        print(f"è¯·æ±‚ {i}/{len(test_cases)}")
        print(f"{'='*60}")
        print(f"é—®é¢˜ï¼š{message}")
        
        result = service.chat(message)
        print(f"æ¥æºï¼š{result['source']}")
        print(f"å›å¤ï¼š{result['content'][:100]}...")
    
    # æ˜¾ç¤ºç»Ÿè®¡
    print(f"\n{'='*60}")
    print("ç»Ÿè®¡ä¿¡æ¯")
    print(f"{'='*60}")
    stats = service.get_stats()
    for key, value in stats.items():
        print(f"{key}: {value}")


if __name__ == "__main__":
    demo()
```

---

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

### 1. é”™è¯¯å¤„ç†åŸåˆ™

```
âœ… åˆ†ç±»å¤„ç†ï¼šåŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•é”™è¯¯
âœ… å‹å¥½æç¤ºï¼šç»™ç”¨æˆ·æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
âœ… è®°å½•æ—¥å¿—ï¼šæ‰€æœ‰é”™è¯¯éƒ½è¦è®°å½•
âœ… åŠæ—¶å‘Šè­¦ï¼šå…³é”®é”™è¯¯è¦é€šçŸ¥è¿ç»´
âœ… ä¼˜é›…é™çº§ï¼šä¸èƒ½è®©ç³»ç»Ÿå´©æºƒ
```

### 2. é‡è¯•ç­–ç•¥é€‰æ‹©

```
åœºæ™¯1ï¼šç½‘ç»œä¸ç¨³å®š
â†’ æŒ‡æ•°é€€é¿ + æŠ–åŠ¨

åœºæ™¯2ï¼šæœåŠ¡å¶å°”æŠ–åŠ¨
â†’ ç®€å•é‡è¯•3æ¬¡

åœºæ™¯3ï¼šé«˜å¹¶å‘ç³»ç»Ÿ
â†’ æŠ–åŠ¨å¿…é¡»åŠ ï¼ˆé¿å…é›ªå´©ï¼‰

åœºæ™¯4ï¼šå¯¹æ—¶å»¶æ•æ„Ÿ
â†’ æœ€å¤šé‡è¯•1-2æ¬¡
```

### 3. ç†”æ–­å™¨é…ç½®

```
ä¿å®ˆé…ç½®ï¼ˆé¿å…è¯¯ç†”æ–­ï¼‰ï¼š
- failure_threshold: 10
- timeout: 120s

æ¿€è¿›é…ç½®ï¼ˆå¿«é€Ÿç†”æ–­ï¼‰ï¼š
- failure_threshold: 3
- timeout: 30s

æ¨èé…ç½®ï¼š
- failure_threshold: 5
- timeout: 60s
```

---

## âœ… è¯¾åæ£€éªŒ

å®Œæˆæœ¬è¯¾åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- [ ] å¤„ç†æ‰€æœ‰OpenAIé”™è¯¯ç±»å‹
- [ ] å®ç°æŒ‡æ•°é€€é¿é‡è¯•
- [ ] ç†è§£ç†”æ–­å™¨æ¨¡å¼
- [ ] è®¾è®¡å¤šå±‚é™çº§æ–¹æ¡ˆ
- [ ] æ„å»ºç”Ÿäº§çº§å¥å£®ç³»ç»Ÿ

---

## ğŸ“ ä¸‹ä¸€è¯¾é¢„å‘Š

**ç¬¬20è¯¾ï¼šTokenç®¡ç†ä¸æˆæœ¬ä¼˜åŒ–**

APIè°ƒç”¨è¦èŠ±é’±ï¼Œå¦‚ä½•æ§åˆ¶æˆæœ¬ï¼Ÿä¸‹ä¸€è¯¾æˆ‘ä»¬å°†å­¦ä¹ ï¼š
- Tokençš„è®¡ç®—å’Œä¼°ç®—
- æç¤ºè¯ä¼˜åŒ–å‡å°‘token
- ç¼“å­˜ç­–ç•¥é™ä½æˆæœ¬
- æ··åˆæ¨¡å‹èŠ‚çœå¼€æ”¯
- æˆæœ¬ç›‘æ§å’Œå‘Šè­¦

**è®©ä½ çš„AIåº”ç”¨æ—¢å¥½ç”¨åˆçœé’±ï¼**

---

**ğŸ‰ æ­å–œä½ å®Œæˆç¬¬19è¯¾ï¼**

ä½ çš„ç³»ç»Ÿç°åœ¨å¥å£®å¯é ï¼Œèƒ½åº”å¯¹å„ç§å¼‚å¸¸æƒ…å†µï¼

**ä¸‹ä¸€æ­¥ï¼š** å­¦ä¹ å¦‚ä½•ä¼˜åŒ–æˆæœ¬ï¼

